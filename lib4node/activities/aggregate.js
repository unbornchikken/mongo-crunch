"use strict";
"use strict";
var CollectionOp = require('./collectionOp');
var util = require('util');
var Activity = require("../../deps/workflow-4-node").activities.Activity;
var _ = require('lodash');
var MongoDBContext = require('./mongoDBContext');
function Aggregate() {
  CollectionOp.call(this);
  this.pipeline = null;
  this.options = null;
  this.toArray = false;
}
util.inherits(Aggregate, CollectionOp);
Aggregate.prototype.doWork = function(callContext) {
  callContext.schedule(this.get('pipeline'), '_pipelineGot');
};
Aggregate.prototype._pipelineGot = function(callContext, reason, result) {
  if (result === Activity.states.complete) {
    if (_.isPlainObject(result) || _.isArray(result)) {
      var coll = callContext.activity.getCollection(this);
      var cursor = coll.aggregate(result, this.get("options"));
      if (this.get("toArray")) {
        cursor.toArray(function(err, result) {
          if (err) {
            callContext.fail(err);
          } else {
            callContext.complete(result);
          }
          cursor.close();
        });
      } else {
        MongoDBContext.registerOpenedCursor(this, cursor);
        callContext.complete(cursor);
      }
    } else {
      if (result)
        callContext.fail(new Error("Aggregation pipeline expected."));
      else
        callContext.fail(new Error("Invalid aggregation pipeline:" + JSON.stringify(result)));
    }
  } else {
    callContext.end(reason, result);
  }
};
module.exports = Aggregate;
//# sourceMappingURL=data:application/json;base64,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QVUsSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFHLE9BQUssQ0FBQyxDQUFDO0VBQ25DO0FBQUEsQUFDSixDQUFBO0FBRUEsS0FBSyxRQUFRLEVBQUksVUFBUSxDQUFDO0FBQzFCIiwiZmlsZSI6ImFjdGl2aXRpZXMvYWdncmVnYXRlLmpzIiwic291cmNlUm9vdCI6IkM6L0dJVC9tb25nby1jcnVuY2gvbGliLyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxubGV0IENvbGxlY3Rpb25PcCA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbk9wJyk7XHJcbmxldCB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xyXG5sZXQgQWN0aXZpdHkgPSByZXF1aXJlKFwiLi4vLi4vZGVwcy93b3JrZmxvdy00LW5vZGVcIikuYWN0aXZpdGllcy5BY3Rpdml0eTtcclxubGV0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcclxubGV0IE1vbmdvREJDb250ZXh0ID0gcmVxdWlyZSgnLi9tb25nb0RCQ29udGV4dCcpO1xyXG5cclxuZnVuY3Rpb24gQWdncmVnYXRlKCkge1xyXG4gICAgQ29sbGVjdGlvbk9wLmNhbGwodGhpcyk7XHJcbiAgICB0aGlzLnBpcGVsaW5lID0gbnVsbDtcclxuICAgIHRoaXMub3B0aW9ucyA9IG51bGw7XHJcbiAgICB0aGlzLnRvQXJyYXkgPSBmYWxzZTtcclxufVxyXG5cclxudXRpbC5pbmhlcml0cyhBZ2dyZWdhdGUsIENvbGxlY3Rpb25PcCk7XHJcblxyXG5BZ2dyZWdhdGUucHJvdG90eXBlLmRvV29yayA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCkge1xyXG4gICAgY2FsbENvbnRleHQuc2NoZWR1bGUodGhpcy5nZXQoJ3BpcGVsaW5lJyksICdfcGlwZWxpbmVHb3QnKTtcclxufTtcclxuXHJcbkFnZ3JlZ2F0ZS5wcm90b3R5cGUuX3BpcGVsaW5lR290ID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCByZWFzb24sIHJlc3VsdCkge1xyXG4gICAgaWYgKHJlc3VsdCA9PT0gQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlKSB7XHJcbiAgICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHJlc3VsdCkgfHwgXy5pc0FycmF5KHJlc3VsdCkpIHtcclxuICAgICAgICAgICBsZXQgY29sbCA9IGNhbGxDb250ZXh0LmFjdGl2aXR5LmdldENvbGxlY3Rpb24odGhpcyk7XHJcbiAgICAgICAgICAgbGV0IGN1cnNvciA9IGNvbGwuYWdncmVnYXRlKHJlc3VsdCwgdGhpcy5nZXQoXCJvcHRpb25zXCIpKTtcclxuICAgICAgICAgICBpZiAodGhpcy5nZXQoXCJ0b0FycmF5XCIpKSB7XHJcbiAgICAgICAgICAgICAgIGN1cnNvci50b0FycmF5KGZ1bmN0aW9uKGVyciwgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgY2FsbENvbnRleHQuZmFpbChlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgY2FsbENvbnRleHQuY29tcGxldGUocmVzdWx0KTtcclxuICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgIGN1cnNvci5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICB9XHJcbiAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgIE1vbmdvREJDb250ZXh0LnJlZ2lzdGVyT3BlbmVkQ3Vyc29yKHRoaXMsIGN1cnNvcik7XHJcbiAgICAgICAgICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKGN1cnNvcik7XHJcbiAgICAgICAgICAgfVxyXG4gICAgICAgfVxyXG4gICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgaWYgKHJlc3VsdClcclxuICAgICAgICAgICAgY2FsbENvbnRleHQuZmFpbChuZXcgRXJyb3IoXCJBZ2dyZWdhdGlvbiBwaXBlbGluZSBleHBlY3RlZC5cIikpO1xyXG4gICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgY2FsbENvbnRleHQuZmFpbChuZXcgRXJyb3IoXCJJbnZhbGlkIGFnZ3JlZ2F0aW9uIHBpcGVsaW5lOlwiICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkpO1xyXG4gICAgICAgfVxyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgICAgY2FsbENvbnRleHQuZW5kKHJlYXNvbiwgcmVzdWx0KTtcclxuICAgIH1cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBBZ2dyZWdhdGU7XHJcbiJdfQ==
