"use strict";
"use strict";
var Activity = require("../../deps/workflow-4-node").activities.Activity;
var util = require("util");
var activityMarkup = require("../../deps/workflow-4-node").activities.activityMarkup;
var _ = require("lodash");
var fast = require("fast.js");
var Bluebird = require("bluebird");
var MongoClient = require("mongodb").MongoClient;
var StrMap = require("backpack-node").collections.StrMap;
var debug = require("debug")("mongo-crunch:Context");
function MongoDBContext() {
  Activity.call(this);
  this.connections = null;
  this.body = null;
}
util.inherits(MongoDBContext, Activity);
MongoDBContext.prototype.run = function(callContext, args) {
  var self = this;
  var body = self.get("body");
  var connections = self.get("connections");
  debug(("Running connections: " + connections + "."));
  if (!body) {
    debug("There is no body, context completed.");
    callContext.complete();
    return ;
  }
  function toConnectionsArray(conns) {
    function toConnection(conn) {
      if (_.isString(conn)) {
        conn = {
          name: "default",
          url: conn,
          options: null
        };
      } else if (_.isObject(conn)) {
        conn = {
          name: conn.name || "default",
          url: conn.url,
          options: conn.options
        };
      } else {
        throw new Error("Connection is invalid: " + JSON.stringify(conn));
      }
      if (_.isString(conn.url) && conn.url) {
        return conn;
      }
      throw new Error("Connection is invalid: " + JSON.stringify(conn));
    }
    var result = [];
    if (_.isArray(conns)) {
      fast.forEach(conns, function(c) {
        result.push(toConnection(c));
      });
    } else {
      result.push(toConnection(conns));
    }
    return result;
  }
  try {
    debug("Parsing connections.");
    var connsDef = toConnectionsArray(connections);
    debug(("There is " + connsDef.length + " connection(s) has been defined."));
    var processedConns = new StrMap();
    fast.forEach(connsDef, function(conn) {
      if (!processedConns.containsKey(conn.name)) {
        processedConns.add(conn.name, conn);
      } else {
        throw new Error("Duplicated connection \"" + conn.name + "\".");
      }
    });
    var tasks = [];
    processedConns.forEachValue(function(conn) {
      debug(("Creating Db for connection " + conn.url + ", options " + conn.options + "."));
      tasks.push(Bluebird.promisify(MongoClient.connect)(conn.url, conn.options).then(function(db) {
        debug("Db created.");
        conn.db = db;
      }));
    });
    Bluebird.all(tasks).then(function() {
      var newConns = {};
      self.set("connections", newConns);
      self.set("MongoDBContext_CollectionRecycleBin", {});
      self.set("MongoDBContext_OpenedCursors", []);
      self.set("MongoDBContext_SeenCollections", []);
      processedConns.forEach(function(kvp) {
        newConns[kvp.key] = kvp.value.db;
      });
      debug("Context has been initialized, scheduling body.");
      callContext.schedule(body, "_bodyCompleted");
    }, function(e) {
      callContext.fail(e);
    });
  } catch (e) {
    callContext.fail(e);
  }
};
MongoDBContext.prototype._bodyCompleted = function(callContext, reason, result) {
  var self = this;
  debug(("Context's body completed, reason: " + reason + "."));
  if (reason !== Activity.states.complete) {
    debug("Reason is not complete, resuming call context.");
    callContext.end(reason, result);
    return ;
  }
  Bluebird.coroutine($traceurRuntime.initGeneratorFunction(function $__0() {
    var taskError,
        MongoDBContext_CollectionRecycleBin,
        MongoDBContext_OpenedCursors,
        tasks,
        binVals,
        connections,
        closeTasks,
        e;
    return $traceurRuntime.createGeneratorInstance(function($ctx) {
      while (true)
        switch ($ctx.state) {
          case 0:
            taskError = null;
            debug("Doing final tasks.");
            $ctx.state = 36;
            break;
          case 36:
            $ctx.pushTry(24, 25);
            $ctx.state = 27;
            break;
          case 27:
            MongoDBContext_CollectionRecycleBin = self.get("MongoDBContext_CollectionRecycleBin");
            MongoDBContext_OpenedCursors = self.get("MongoDBContext_OpenedCursors");
            tasks = [];
            binVals = _.values(MongoDBContext_CollectionRecycleBin);
            debug(("Collections in recycle bin: " + binVals.length + "."));
            fast.forEach(binVals, function(coll) {
              debug(("Dropping collection: " + coll.collectionName));
              tasks.push(Bluebird.promisify(coll.drop, coll)().then(function() {
                debug(("Collection '" + coll.collectionName + "' dropped."));
              }).catch(function(e) {
                if (e.name === "MongoError" && e.message === "ns not found") {
                  debug(("Collection '" + coll.collectionName + "' doesn't exists."));
                  return ;
                }
                debug(("ERROR: Collection '" + coll.collectionName + "' dropping failed with\n" + e.stack));
              }));
            });
            debug(("Cursors to close: " + MongoDBContext_OpenedCursors.length + "."));
            fast.forEach(MongoDBContext_OpenedCursors, function(c, idx) {
              tasks.push(Bluebird.promisify(c.close, c)().then(function() {
                debug(("Cursor " + idx + ". dropped."));
              }).catch(function(e) {
                debug(("ERROR: Cursor " + idx + ". closing failed with\n" + e.stack));
              }));
            });
            $ctx.state = 6;
            break;
          case 6:
            $ctx.state = 2;
            return Bluebird.all(tasks);
          case 2:
            $ctx.maybeThrow();
            $ctx.state = 4;
            break;
          case 4:
            $ctx.popTry();
            $ctx.state = 25;
            $ctx.finallyFallThrough = -2;
            break;
          case 24:
            $ctx.popTry();
            $ctx.maybeUncatchable();
            e = $ctx.storedException;
            $ctx.state = 30;
            break;
          case 30:
            taskError = e;
            $ctx.state = 25;
            $ctx.finallyFallThrough = -2;
            break;
          case 25:
            $ctx.popTry();
            $ctx.state = 34;
            break;
          case 34:
            self.delete("MongoDBContext_CollectionRecycleBin");
            self.delete("MongoDBContext_OpenedCursors");
            self.delete("MongoDBContext_SeenCollections");
            connections = self.get("connections");
            debug(("Closing " + connections.length + " connections."));
            closeTasks = [];
            fast.forEach(_.values(connections), function(db) {
              debug(("Closing '" + db.databaseName + "'."));
              closeTasks.push(Bluebird.promisify(db.close, db)(true).then(function() {
                debug(("Db '" + db.databaseName + "' closed."));
              }).catch(function(e) {
                debug(("ERROR: Closing Db '" + db.databaseName + "' failed with\n" + e.stack));
              }));
            });
            $ctx.state = 21;
            break;
          case 21:
            $ctx.pushTry(11, null);
            $ctx.state = 14;
            break;
          case 14:
            $ctx.state = 8;
            return Bluebird.all(closeTasks);
          case 8:
            $ctx.maybeThrow();
            $ctx.state = 10;
            break;
          case 10:
            $ctx.popTry();
            $ctx.state = 16;
            break;
          case 11:
            $ctx.popTry();
            $ctx.maybeUncatchable();
            e = $ctx.storedException;
            $ctx.state = 17;
            break;
          case 17:
            debug("ERROR: Cannot close MongoDB connections, error\n" + e.stack);
            $ctx.state = 16;
            break;
          case 16:
            if (taskError) {
              debug("ERROR: final tasks failed. Reporting error to call context.");
              callContext.fail(taskError);
            } else {
              debug("Final tasks completed.");
              callContext.complete();
            }
            $ctx.state = 23;
            break;
          case 23:
            $ctx.state = $ctx.finallyFallThrough;
            break;
          default:
            return $ctx.end();
        }
    }, $__0, this);
  }))();
};
MongoDBContext.addCollectionToRecycleBin = function(scope, collection) {
  var bin = scope.get("MongoDBContext_CollectionRecycleBin");
  debug(("Adding collection '" + collection.collectionName + "' to recycle bin."));
  bin[collection.collectionName] = collection;
  debug(("Recycle bin size is " + _.keys(bin).length + "."));
};
MongoDBContext.registerOpenedCursor = function(scope, cursor) {
  var cursors = scope.get("MongoDBContext_OpenedCursors");
  debug("Registering a cursor as opened.");
  cursors.push(cursor);
  debug(("There are " + cursors.length + " cursors registered."));
};
MongoDBContext.unregisterOpenedCursor = function(scope, cursor) {
  debug("Unregistering opened cursor.");
  scope.set("MongoDBContext_OpenedCursors", _.without(scope.get("MongoDBContext_OpenedCursors"), cursor));
  debug(("There are " + scope.get("MongoDBContext_OpenedCursors").length + " cursors registered."));
};
MongoDBContext.isFirstSeenCollection = function(scope, db, collectionName) {
  debug(("Determining if '" + collectionName + "' collection in '" + db.databaseName + "' db is first seen by the current context."));
  var colls = scope.get("MongoDBContext_SeenCollections");
  var entry = _.first(_.where(colls, {db: db}));
  if (!entry) {
    var collReg = {};
    collReg[collectionName] = true;
    colls.push({
      db: db,
      collections: collReg
    });
    debug("Fist seen.");
    return true;
  }
  if (!entry.collections[collectionName]) {
    entry.collections[collectionName] = true;
    debug("First seen.");
    return true;
  }
  debug("Not first seen.");
  return false;
};
module.exports = MongoDBContext;
//# sourceMappingURL=data:application/json;base64,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QUFJLEdBQUMsQ0FBQztBQUNoQixVQUFNLENBQUUsY0FBYSxDQUFDLEVBQUksS0FBRyxDQUFDO0FBQzlCLFFBQUksS0FBSyxBQUFDLENBQUM7QUFDUCxPQUFDLENBQUcsR0FBQztBQUNMLGdCQUFVLENBQUcsUUFBTTtBQUFBLElBQ3ZCLENBQUMsQ0FBQztBQUNGLFFBQUksQUFBQyxDQUFDLFlBQVcsQ0FBQyxDQUFDO0FBQ25CLFNBQU8sS0FBRyxDQUFDO0VBQ2Y7QUFBQSxBQUNBLEtBQUksQ0FBQyxLQUFJLFlBQVksQ0FBRSxjQUFhLENBQUMsQ0FBRztBQUNwQyxRQUFJLFlBQVksQ0FBRSxjQUFhLENBQUMsRUFBSSxLQUFHLENBQUM7QUFDeEMsUUFBSSxBQUFDLENBQUMsYUFBWSxDQUFDLENBQUM7QUFDcEIsU0FBTyxLQUFHLENBQUM7RUFDZjtBQUFBLEFBQ0EsTUFBSSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztBQUN4QixPQUFPLE1BQUksQ0FBQztBQUNoQixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksZUFBYSxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9tb25nb0RCQ29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJDOi9HSVQvbW9uZ28tY3J1bmNoL2xpYi8iLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcclxuXHJcbmxldCBBY3Rpdml0eSA9IHJlcXVpcmUoXCIuLi8uLi9kZXBzL3dvcmtmbG93LTQtbm9kZVwiKS5hY3Rpdml0aWVzLkFjdGl2aXR5O1xyXG5sZXQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG5sZXQgYWN0aXZpdHlNYXJrdXAgPSByZXF1aXJlKFwiLi4vLi4vZGVwcy93b3JrZmxvdy00LW5vZGVcIikuYWN0aXZpdGllcy5hY3Rpdml0eU1hcmt1cDtcclxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG5sZXQgZmFzdCA9IHJlcXVpcmUoXCJmYXN0LmpzXCIpO1xyXG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XHJcbmxldCBNb25nb0NsaWVudCA9IHJlcXVpcmUoXCJtb25nb2RiXCIpLk1vbmdvQ2xpZW50O1xyXG5sZXQgU3RyTWFwID0gcmVxdWlyZShcImJhY2twYWNrLW5vZGVcIikuY29sbGVjdGlvbnMuU3RyTWFwO1xyXG5sZXQgZGVidWcgPSByZXF1aXJlKFwiZGVidWdcIikoXCJtb25nby1jcnVuY2g6Q29udGV4dFwiKTtcclxuXHJcbmZ1bmN0aW9uIE1vbmdvREJDb250ZXh0ICgpIHtcclxuICAgIEFjdGl2aXR5LmNhbGwodGhpcyk7XHJcblxyXG4gICAgdGhpcy5jb25uZWN0aW9ucyA9IG51bGw7XHJcbiAgICB0aGlzLmJvZHkgPSBudWxsO1xyXG59XHJcblxyXG51dGlsLmluaGVyaXRzKE1vbmdvREJDb250ZXh0LCBBY3Rpdml0eSk7XHJcblxyXG5Nb25nb0RCQ29udGV4dC5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBhcmdzKSB7XHJcbiAgICBsZXQgc2VsZiA9IHRoaXM7XHJcbiAgICBsZXQgYm9keSA9IHNlbGYuZ2V0KFwiYm9keVwiKTtcclxuICAgIGxldCBjb25uZWN0aW9ucyA9IHNlbGYuZ2V0KFwiY29ubmVjdGlvbnNcIik7XHJcblxyXG4gICAgZGVidWcoYFJ1bm5pbmcgY29ubmVjdGlvbnM6ICR7Y29ubmVjdGlvbnN9LmApO1xyXG5cclxuICAgIGlmICghYm9keSkge1xyXG4gICAgICAgIGRlYnVnKFwiVGhlcmUgaXMgbm8gYm9keSwgY29udGV4dCBjb21wbGV0ZWQuXCIpO1xyXG5cclxuICAgICAgICBjYWxsQ29udGV4dC5jb21wbGV0ZSgpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiB0b0Nvbm5lY3Rpb25zQXJyYXkgKGNvbm5zKSB7XHJcblxyXG4gICAgICAgIGZ1bmN0aW9uIHRvQ29ubmVjdGlvbiAoY29ubikge1xyXG4gICAgICAgICAgICBpZiAoXy5pc1N0cmluZyhjb25uKSkge1xyXG4gICAgICAgICAgICAgICAgY29ubiA9IHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBcImRlZmF1bHRcIixcclxuICAgICAgICAgICAgICAgICAgICB1cmw6IGNvbm4sXHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogbnVsbFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChfLmlzT2JqZWN0KGNvbm4pKSB7XHJcbiAgICAgICAgICAgICAgICBjb25uID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IGNvbm4ubmFtZSB8fCBcImRlZmF1bHRcIixcclxuICAgICAgICAgICAgICAgICAgICB1cmw6IGNvbm4udXJsLFxyXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IGNvbm4ub3B0aW9uc1xyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvbm5lY3Rpb24gaXMgaW52YWxpZDogXCIgKyBKU09OLnN0cmluZ2lmeShjb25uKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChfLmlzU3RyaW5nKGNvbm4udXJsKSAmJiBjb25uLnVybCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ29ubmVjdGlvbiBpcyBpbnZhbGlkOiBcIiArIEpTT04uc3RyaW5naWZ5KGNvbm4pKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCByZXN1bHQgPSBbXTtcclxuICAgICAgICBpZiAoXy5pc0FycmF5KGNvbm5zKSkge1xyXG4gICAgICAgICAgICBmYXN0LmZvckVhY2goY29ubnMsIGZ1bmN0aW9uIChjKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCh0b0Nvbm5lY3Rpb24oYykpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHRvQ29ubmVjdGlvbihjb25ucykpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgICAgZGVidWcoXCJQYXJzaW5nIGNvbm5lY3Rpb25zLlwiKTtcclxuICAgICAgICBsZXQgY29ubnNEZWYgPSB0b0Nvbm5lY3Rpb25zQXJyYXkoY29ubmVjdGlvbnMpO1xyXG4gICAgICAgIGRlYnVnKGBUaGVyZSBpcyAke2Nvbm5zRGVmLmxlbmd0aH0gY29ubmVjdGlvbihzKSBoYXMgYmVlbiBkZWZpbmVkLmApO1xyXG4gICAgICAgIGxldCBwcm9jZXNzZWRDb25ucyA9IG5ldyBTdHJNYXAoKTtcclxuICAgICAgICBmYXN0LmZvckVhY2goY29ubnNEZWYsIGZ1bmN0aW9uIChjb25uKSB7XHJcbiAgICAgICAgICAgIGlmICghcHJvY2Vzc2VkQ29ubnMuY29udGFpbnNLZXkoY29ubi5uYW1lKSkge1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2VkQ29ubnMuYWRkKGNvbm4ubmFtZSwgY29ubik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJEdXBsaWNhdGVkIGNvbm5lY3Rpb24gXFxcIlwiICsgY29ubi5uYW1lICsgXCJcXFwiLlwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBsZXQgdGFza3MgPSBbXTtcclxuICAgICAgICBwcm9jZXNzZWRDb25ucy5mb3JFYWNoVmFsdWUoZnVuY3Rpb24gKGNvbm4pIHtcclxuICAgICAgICAgICAgZGVidWcoYENyZWF0aW5nIERiIGZvciBjb25uZWN0aW9uICR7Y29ubi51cmx9LCBvcHRpb25zICR7Y29ubi5vcHRpb25zfS5gKTtcclxuICAgICAgICAgICAgdGFza3MucHVzaChCbHVlYmlyZC5wcm9taXNpZnkoTW9uZ29DbGllbnQuY29ubmVjdCkoY29ubi51cmwsIGNvbm4ub3B0aW9ucykudGhlbihmdW5jdGlvbiAoZGIpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnKFwiRGIgY3JlYXRlZC5cIik7XHJcbiAgICAgICAgICAgICAgICBjb25uLmRiID0gZGI7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgQmx1ZWJpcmQuYWxsKHRhc2tzKS50aGVuKFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbmV3Q29ubnMgPSB7fTtcclxuICAgICAgICAgICAgICAgIHNlbGYuc2V0KFwiY29ubmVjdGlvbnNcIiwgbmV3Q29ubnMpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5zZXQoXCJNb25nb0RCQ29udGV4dF9Db2xsZWN0aW9uUmVjeWNsZUJpblwiLCB7fSk7XHJcbiAgICAgICAgICAgICAgICBzZWxmLnNldChcIk1vbmdvREJDb250ZXh0X09wZW5lZEN1cnNvcnNcIiwgW10pO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5zZXQoXCJNb25nb0RCQ29udGV4dF9TZWVuQ29sbGVjdGlvbnNcIiwgW10pO1xyXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2VkQ29ubnMuZm9yRWFjaChmdW5jdGlvbiAoa3ZwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmV3Q29ubnNba3ZwLmtleV0gPSBrdnAudmFsdWUuZGI7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICBkZWJ1ZyhcIkNvbnRleHQgaGFzIGJlZW4gaW5pdGlhbGl6ZWQsIHNjaGVkdWxpbmcgYm9keS5cIik7XHJcbiAgICAgICAgICAgICAgICBjYWxsQ29udGV4dC5zY2hlZHVsZShib2R5LCBcIl9ib2R5Q29tcGxldGVkXCIpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgY2FsbENvbnRleHQuZmFpbChlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgIGNhbGxDb250ZXh0LmZhaWwoZSk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5Nb25nb0RCQ29udGV4dC5wcm90b3R5cGUuX2JvZHlDb21wbGV0ZWQgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICBsZXQgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgZGVidWcoYENvbnRleHQncyBib2R5IGNvbXBsZXRlZCwgcmVhc29uOiAke3JlYXNvbn0uYCk7XHJcblxyXG4gICAgaWYgKHJlYXNvbiAhPT0gQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlKSB7XHJcbiAgICAgICAgZGVidWcoXCJSZWFzb24gaXMgbm90IGNvbXBsZXRlLCByZXN1bWluZyBjYWxsIGNvbnRleHQuXCIpO1xyXG4gICAgICAgIGNhbGxDb250ZXh0LmVuZChyZWFzb24sIHJlc3VsdCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIEJsdWViaXJkLmNvcm91dGluZShmdW5jdGlvbiogKCkge1xyXG4gICAgICAgIGxldCB0YXNrRXJyb3IgPSBudWxsO1xyXG5cclxuICAgICAgICBkZWJ1ZyhcIkRvaW5nIGZpbmFsIHRhc2tzLlwiKTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBsZXQgTW9uZ29EQkNvbnRleHRfQ29sbGVjdGlvblJlY3ljbGVCaW4gPSBzZWxmLmdldChcIk1vbmdvREJDb250ZXh0X0NvbGxlY3Rpb25SZWN5Y2xlQmluXCIpO1xyXG4gICAgICAgICAgICBsZXQgTW9uZ29EQkNvbnRleHRfT3BlbmVkQ3Vyc29ycyA9IHNlbGYuZ2V0KFwiTW9uZ29EQkNvbnRleHRfT3BlbmVkQ3Vyc29yc1wiKTtcclxuICAgICAgICAgICAgbGV0IHRhc2tzID0gW107XHJcblxyXG4gICAgICAgICAgICBsZXQgYmluVmFscyA9IF8udmFsdWVzKE1vbmdvREJDb250ZXh0X0NvbGxlY3Rpb25SZWN5Y2xlQmluKTtcclxuICAgICAgICAgICAgZGVidWcoYENvbGxlY3Rpb25zIGluIHJlY3ljbGUgYmluOiAke2JpblZhbHMubGVuZ3RofS5gKTtcclxuICAgICAgICAgICAgZmFzdC5mb3JFYWNoKGJpblZhbHMsIGZ1bmN0aW9uIChjb2xsKSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1ZyhgRHJvcHBpbmcgY29sbGVjdGlvbjogJHtjb2xsLmNvbGxlY3Rpb25OYW1lfWApO1xyXG4gICAgICAgICAgICAgICAgdGFza3MucHVzaChCbHVlYmlyZC5wcm9taXNpZnkoY29sbC5kcm9wLCBjb2xsKSgpXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKGBDb2xsZWN0aW9uICcke2NvbGwuY29sbGVjdGlvbk5hbWV9JyBkcm9wcGVkLmApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLm5hbWUgPT09IFwiTW9uZ29FcnJvclwiICYmIGUubWVzc2FnZSA9PT0gXCJucyBub3QgZm91bmRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoYENvbGxlY3Rpb24gJyR7Y29sbC5jb2xsZWN0aW9uTmFtZX0nIGRvZXNuJ3QgZXhpc3RzLmApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKGBFUlJPUjogQ29sbGVjdGlvbiAnJHtjb2xsLmNvbGxlY3Rpb25OYW1lfScgZHJvcHBpbmcgZmFpbGVkIHdpdGhcXG4ke2Uuc3RhY2t9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGRlYnVnKGBDdXJzb3JzIHRvIGNsb3NlOiAke01vbmdvREJDb250ZXh0X09wZW5lZEN1cnNvcnMubGVuZ3RofS5gKTtcclxuICAgICAgICAgICAgZmFzdC5mb3JFYWNoKE1vbmdvREJDb250ZXh0X09wZW5lZEN1cnNvcnMsIGZ1bmN0aW9uIChjLCBpZHgpIHtcclxuICAgICAgICAgICAgICAgIHRhc2tzLnB1c2goQmx1ZWJpcmQucHJvbWlzaWZ5KGMuY2xvc2UsIGMpKClcclxuICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoYEN1cnNvciAke2lkeH0uIGRyb3BwZWQuYCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhgRVJST1I6IEN1cnNvciAke2lkeH0uIGNsb3NpbmcgZmFpbGVkIHdpdGhcXG4ke2Uuc3RhY2t9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHlpZWxkIEJsdWViaXJkLmFsbCh0YXNrcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHRhc2tFcnJvciA9IGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZpbmFsbHkge1xyXG4gICAgICAgICAgICBzZWxmLmRlbGV0ZShcIk1vbmdvREJDb250ZXh0X0NvbGxlY3Rpb25SZWN5Y2xlQmluXCIpO1xyXG4gICAgICAgICAgICBzZWxmLmRlbGV0ZShcIk1vbmdvREJDb250ZXh0X09wZW5lZEN1cnNvcnNcIik7XHJcbiAgICAgICAgICAgIHNlbGYuZGVsZXRlKFwiTW9uZ29EQkNvbnRleHRfU2VlbkNvbGxlY3Rpb25zXCIpO1xyXG5cclxuICAgICAgICAgICAgLy8gQ2xvc2UgYWxsIGRiczpcclxuICAgICAgICAgICAgbGV0IGNvbm5lY3Rpb25zID0gc2VsZi5nZXQoXCJjb25uZWN0aW9uc1wiKTtcclxuICAgICAgICAgICAgZGVidWcoYENsb3NpbmcgJHtjb25uZWN0aW9ucy5sZW5ndGh9IGNvbm5lY3Rpb25zLmApO1xyXG4gICAgICAgICAgICBsZXQgY2xvc2VUYXNrcyA9IFtdO1xyXG4gICAgICAgICAgICBmYXN0LmZvckVhY2goXy52YWx1ZXMoY29ubmVjdGlvbnMpLCBmdW5jdGlvbiAoZGIpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnKGBDbG9zaW5nICcke2RiLmRhdGFiYXNlTmFtZX0nLmApO1xyXG4gICAgICAgICAgICAgICAgY2xvc2VUYXNrcy5wdXNoKEJsdWViaXJkLnByb21pc2lmeShkYi5jbG9zZSwgZGIpKHRydWUpXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKGBEYiAnJHtkYi5kYXRhYmFzZU5hbWV9JyBjbG9zZWQuYCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24oZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhgRVJST1I6IENsb3NpbmcgRGIgJyR7ZGIuZGF0YWJhc2VOYW1lfScgZmFpbGVkIHdpdGhcXG4ke2Uuc3RhY2t9YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB5aWVsZCBCbHVlYmlyZC5hbGwoY2xvc2VUYXNrcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnKFwiRVJST1I6IENhbm5vdCBjbG9zZSBNb25nb0RCIGNvbm5lY3Rpb25zLCBlcnJvclxcblwiICsgZS5zdGFjayk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0YXNrRXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnKFwiRVJST1I6IGZpbmFsIHRhc2tzIGZhaWxlZC4gUmVwb3J0aW5nIGVycm9yIHRvIGNhbGwgY29udGV4dC5cIik7XHJcbiAgICAgICAgICAgICAgICBjYWxsQ29udGV4dC5mYWlsKHRhc2tFcnJvcik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1ZyhcIkZpbmFsIHRhc2tzIGNvbXBsZXRlZC5cIik7XHJcbiAgICAgICAgICAgICAgICBjYWxsQ29udGV4dC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSkoKTtcclxufTtcclxuXHJcbk1vbmdvREJDb250ZXh0LmFkZENvbGxlY3Rpb25Ub1JlY3ljbGVCaW4gPSBmdW5jdGlvbiAoc2NvcGUsIGNvbGxlY3Rpb24pIHtcclxuICAgIGxldCBiaW4gPSBzY29wZS5nZXQoXCJNb25nb0RCQ29udGV4dF9Db2xsZWN0aW9uUmVjeWNsZUJpblwiKTtcclxuICAgIGRlYnVnKGBBZGRpbmcgY29sbGVjdGlvbiAnJHtjb2xsZWN0aW9uLmNvbGxlY3Rpb25OYW1lfScgdG8gcmVjeWNsZSBiaW4uYCk7XHJcbiAgICBiaW5bY29sbGVjdGlvbi5jb2xsZWN0aW9uTmFtZV0gPSBjb2xsZWN0aW9uO1xyXG4gICAgZGVidWcoYFJlY3ljbGUgYmluIHNpemUgaXMgJHtfLmtleXMoYmluKS5sZW5ndGh9LmApO1xyXG59O1xyXG5cclxuTW9uZ29EQkNvbnRleHQucmVnaXN0ZXJPcGVuZWRDdXJzb3IgPSBmdW5jdGlvbiAoc2NvcGUsIGN1cnNvcikge1xyXG4gICAgbGV0IGN1cnNvcnMgPSBzY29wZS5nZXQoXCJNb25nb0RCQ29udGV4dF9PcGVuZWRDdXJzb3JzXCIpO1xyXG4gICAgZGVidWcoYFJlZ2lzdGVyaW5nIGEgY3Vyc29yIGFzIG9wZW5lZC5gKTtcclxuICAgIGN1cnNvcnMucHVzaChjdXJzb3IpO1xyXG4gICAgZGVidWcoYFRoZXJlIGFyZSAke2N1cnNvcnMubGVuZ3RofSBjdXJzb3JzIHJlZ2lzdGVyZWQuYCk7XHJcbn07XHJcblxyXG5Nb25nb0RCQ29udGV4dC51bnJlZ2lzdGVyT3BlbmVkQ3Vyc29yID0gZnVuY3Rpb24gKHNjb3BlLCBjdXJzb3IpIHtcclxuICAgIGRlYnVnKGBVbnJlZ2lzdGVyaW5nIG9wZW5lZCBjdXJzb3IuYCk7XHJcbiAgICBzY29wZS5zZXQoXCJNb25nb0RCQ29udGV4dF9PcGVuZWRDdXJzb3JzXCIsIF8ud2l0aG91dChzY29wZS5nZXQoXCJNb25nb0RCQ29udGV4dF9PcGVuZWRDdXJzb3JzXCIpLCBjdXJzb3IpKTtcclxuICAgIGRlYnVnKGBUaGVyZSBhcmUgJHtzY29wZS5nZXQoXCJNb25nb0RCQ29udGV4dF9PcGVuZWRDdXJzb3JzXCIpLmxlbmd0aH0gY3Vyc29ycyByZWdpc3RlcmVkLmApO1xyXG59O1xyXG5cclxuTW9uZ29EQkNvbnRleHQuaXNGaXJzdFNlZW5Db2xsZWN0aW9uID0gZnVuY3Rpb24gKHNjb3BlLCBkYiwgY29sbGVjdGlvbk5hbWUpIHtcclxuICAgIGRlYnVnKGBEZXRlcm1pbmluZyBpZiAnJHtjb2xsZWN0aW9uTmFtZX0nIGNvbGxlY3Rpb24gaW4gJyR7ZGIuZGF0YWJhc2VOYW1lfScgZGIgaXMgZmlyc3Qgc2VlbiBieSB0aGUgY3VycmVudCBjb250ZXh0LmApO1xyXG4gICAgbGV0IGNvbGxzID0gc2NvcGUuZ2V0KFwiTW9uZ29EQkNvbnRleHRfU2VlbkNvbGxlY3Rpb25zXCIpO1xyXG4gICAgbGV0IGVudHJ5ID0gXy5maXJzdChfLndoZXJlKGNvbGxzLCB7IGRiOiBkYiB9KSk7XHJcbiAgICBpZiAoIWVudHJ5KSB7XHJcbiAgICAgICAgbGV0IGNvbGxSZWcgPSB7fTtcclxuICAgICAgICBjb2xsUmVnW2NvbGxlY3Rpb25OYW1lXSA9IHRydWU7XHJcbiAgICAgICAgY29sbHMucHVzaCh7XHJcbiAgICAgICAgICAgIGRiOiBkYixcclxuICAgICAgICAgICAgY29sbGVjdGlvbnM6IGNvbGxSZWdcclxuICAgICAgICB9KTtcclxuICAgICAgICBkZWJ1ZyhcIkZpc3Qgc2Vlbi5cIik7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICBpZiAoIWVudHJ5LmNvbGxlY3Rpb25zW2NvbGxlY3Rpb25OYW1lXSkge1xyXG4gICAgICAgIGVudHJ5LmNvbGxlY3Rpb25zW2NvbGxlY3Rpb25OYW1lXSA9IHRydWU7XHJcbiAgICAgICAgZGVidWcoXCJGaXJzdCBzZWVuLlwiKTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIGRlYnVnKFwiTm90IGZpcnN0IHNlZW4uXCIpO1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG59O1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBNb25nb0RCQ29udGV4dDsiXX0=
