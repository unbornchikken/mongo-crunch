"use strict";
var _ = require("lodash");
var UnitOfWork = require("./unitOfWork");
var Collection = require("mongodb").Collection;
var Bluebird = require("bluebird");
function IterateObj(obj) {
  this._obj = obj;
}
IterateObj.prototype.next = function(cb) {
  if (!_.isNull(this._obj)) {
    var o = this._obj;
    this._obj = null;
    cb(null, o);
  } else {
    cb(null, null);
  }
};
IterateObj.prototype.close = _.noop;
function IterateArray(array) {
  this._array = array;
  this._index = 0;
}
IterateArray.prototype.next = function(cb) {
  if (this._index < this._array.length) {
    cb(null, this._array[this._index++]);
  } else {
    cb(null, null);
  }
};
IterateArray.prototype.close = _.noop;
function IterateCursor(scope, cursor) {
  this._scope = scope;
  this._cursor = cursor;
  if (!(this._next = this._cursor.nextObject || this._cursor.next)) {
    this._cursor.pause();
  }
  this._on = false;
}
IterateCursor.prototype.next = function(cb) {
  var self = this;
  if (this._next) {
    this._next.call(this._cursor, function(err, result) {
      if (err || !result) {
        try {
          self.close();
        } catch (err2) {
          cb(err2);
          return;
        }
      }
      cb(err, result);
    });
  } else {
    var reported = false;
    var installHandlers = function() {
      if (!self._on) {
        self._cursor.on("data", dataHandler);
        self._cursor.on("error", errorHandler);
        self._cursor.on("end", endHandler);
        self._on = true;
      }
    };
    var uninstallHandlers = function() {
      self._cursor.removeListener("data", dataHandler);
      self._cursor.removeListener("error", errorHandler);
      self._cursor.removeListener("end", endHandler);
    };
    var registerEnd = function(result) {
      if (!reported) {
        try {
          self.close();
          self._end = result;
        } finally {
          uninstallHandlers();
          reported = true;
        }
      }
    };
    var dataHandler = function(result) {
      self._cursor.pause();
      cb(null, result);
    };
    var errorHandler = function(err) {
      registerEnd(err);
    };
    var endHandler = function() {
      registerEnd(true);
    };
    if (self._end) {
      if (_.isObject(self._end)) {
        cb(self._end, null);
      } else {
        cb(null, null);
      }
    } else {
      installHandlers();
      this._cursor.resume();
    }
  }
};
IterateCursor.prototype.close = function() {
  if (this._cursor) {
    UnitOfWork.unregisterOpenedCursor(this._scope, this._cursor);
    this._cursor.close();
    this._cursor = null;
  }
};
function createIterator(scope, obj) {
  var it;
  if (obj) {
    if (obj instanceof Collection) {
      it = new IterateCursor(scope, obj.find());
    } else if (_.isFunction(obj.next) || _.isFunction(obj.nextObject)) {
      it = new IterateCursor(scope, obj);
    } else if (_.isArray(obj)) {
      it = new IterateArray(obj);
    } else {
      it = new IterateObj(obj);
    }
  } else {
    if (_.isUndefined(obj)) {
      throw new TypeError("Argument value of 'obj' expected.");
    }
    it = {next: function(cb) {
        cb(null, null);
      }};
  }
  return Bluebird.promisifyAll(it);
}
module.exports = createIterator;
//# sourceMappingURL=data:application/json;base64,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RSxDQUFHO0FBQ0wsT0FBSSxHQUFFLFdBQWEsV0FBUyxDQUFHO0FBQzNCLE9BQUMsRUFBSSxJQUFJLGNBQVksQUFBQyxDQUFDLEtBQUksQ0FBRyxDQUFBLEdBQUUsS0FBSyxBQUFDLEVBQUMsQ0FBQyxDQUFDO0lBQzdDLEtBQ0ssS0FBSSxDQUFBLFdBQVcsQUFBQyxDQUFDLEdBQUUsS0FBSyxDQUFDLENBQUEsRUFBSyxDQUFBLENBQUEsV0FBVyxBQUFDLENBQUMsR0FBRSxXQUFXLENBQUMsQ0FBRztBQUM3RCxPQUFDLEVBQUksSUFBSSxjQUFZLEFBQUMsQ0FBQyxLQUFJLENBQUcsSUFBRSxDQUFDLENBQUM7SUFDdEMsS0FDSyxLQUFJLENBQUEsUUFBUSxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUc7QUFDckIsT0FBQyxFQUFJLElBQUksYUFBVyxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUM7SUFDOUIsS0FDSztBQUNELE9BQUMsRUFBSSxJQUFJLFdBQVMsQUFBQyxDQUFDLEdBQUUsQ0FBQyxDQUFDO0lBQzVCO0FBQUEsRUFDSixLQUNLO0FBQ0QsT0FBSSxDQUFBLFlBQVksQUFBQyxDQUFDLEdBQUUsQ0FBQyxDQUFHO0FBQ3BCLFVBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxtQ0FBa0MsQ0FBQyxDQUFDO0lBQzVEO0FBQUEsQUFDQSxLQUFDLEVBQUksRUFDRCxJQUFHLENBQUcsVUFBVSxFQUFDLENBQUc7QUFDaEIsU0FBQyxBQUFDLENBQUMsSUFBRyxDQUFHLEtBQUcsQ0FBQyxDQUFDO01BQ2xCLENBQ0osQ0FBQztFQUNMO0FBQUEsQUFDQSxPQUFPLENBQUEsUUFBTyxhQUFhLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztBQUNwQztBQUFBLEFBRUEsS0FBSyxRQUFRLEVBQUksZUFBYSxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9jcmVhdGVJdGVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcbmxldCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcclxubGV0IFVuaXRPZldvcmsgPSByZXF1aXJlKFwiLi91bml0T2ZXb3JrXCIpO1xyXG5sZXQgQ29sbGVjdGlvbiA9IHJlcXVpcmUoXCJtb25nb2RiXCIpLkNvbGxlY3Rpb247XHJcbmxldCBCbHVlYmlyZCA9IHJlcXVpcmUoXCJibHVlYmlyZFwiKTtcclxuXHJcbmZ1bmN0aW9uIEl0ZXJhdGVPYmoob2JqKSB7XHJcbiAgICB0aGlzLl9vYmogPSBvYmo7XHJcbn1cclxuXHJcbkl0ZXJhdGVPYmoucHJvdG90eXBlLm5leHQgPSBmdW5jdGlvbiAoY2IpIHtcclxuICAgIGlmICghXy5pc051bGwodGhpcy5fb2JqKSkge1xyXG4gICAgICAgIGxldCBvID0gdGhpcy5fb2JqO1xyXG4gICAgICAgIHRoaXMuX29iaiA9IG51bGw7XHJcbiAgICAgICAgY2IobnVsbCwgbyk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBjYihudWxsLCBudWxsKTtcclxuICAgIH1cclxufTtcclxuXHJcbkl0ZXJhdGVPYmoucHJvdG90eXBlLmNsb3NlID0gXy5ub29wO1xyXG5cclxuZnVuY3Rpb24gSXRlcmF0ZUFycmF5KGFycmF5KSB7XHJcbiAgICB0aGlzLl9hcnJheSA9IGFycmF5O1xyXG4gICAgdGhpcy5faW5kZXggPSAwO1xyXG59XHJcblxyXG5JdGVyYXRlQXJyYXkucHJvdG90eXBlLm5leHQgPSBmdW5jdGlvbiAoY2IpIHtcclxuICAgIGlmICh0aGlzLl9pbmRleCA8IHRoaXMuX2FycmF5Lmxlbmd0aCkge1xyXG4gICAgICAgIGNiKG51bGwsIHRoaXMuX2FycmF5W3RoaXMuX2luZGV4KytdKTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIGNiKG51bGwsIG51bGwpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuSXRlcmF0ZUFycmF5LnByb3RvdHlwZS5jbG9zZSA9IF8ubm9vcDtcclxuXHJcbmZ1bmN0aW9uIEl0ZXJhdGVDdXJzb3Ioc2NvcGUsIGN1cnNvcikge1xyXG4gICAgdGhpcy5fc2NvcGUgPSBzY29wZTtcclxuICAgIHRoaXMuX2N1cnNvciA9IGN1cnNvcjtcclxuICAgIGlmICghKHRoaXMuX25leHQgPSB0aGlzLl9jdXJzb3IubmV4dE9iamVjdCB8fCB0aGlzLl9jdXJzb3IubmV4dCkpIHtcclxuICAgICAgICB0aGlzLl9jdXJzb3IucGF1c2UoKTtcclxuICAgIH1cclxuICAgIHRoaXMuX29uID0gZmFsc2U7XHJcbn1cclxuXHJcbkl0ZXJhdGVDdXJzb3IucHJvdG90eXBlLm5leHQgPSBmdW5jdGlvbiAoY2IpIHtcclxuICAgIGxldCBzZWxmID0gdGhpcztcclxuICAgIGlmICh0aGlzLl9uZXh0KSB7XHJcbiAgICAgICAgdGhpcy5fbmV4dC5jYWxsKHRoaXMuX2N1cnNvcixcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGVyciwgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyIHx8ICFyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNhdGNoIChlcnIyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKGVycjIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY2IoZXJyLCByZXN1bHQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHZhciByZXBvcnRlZCA9IGZhbHNlO1xyXG4gICAgICAgIGxldCBpbnN0YWxsSGFuZGxlcnMgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmICghc2VsZi5fb24pIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX2N1cnNvci5vbihcImRhdGFcIiwgZGF0YUhhbmRsZXIpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5fY3Vyc29yLm9uKFwiZXJyb3JcIiwgZXJyb3JIYW5kbGVyKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuX2N1cnNvci5vbihcImVuZFwiLCBlbmRIYW5kbGVyKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuX29uID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IHVuaW5zdGFsbEhhbmRsZXJzID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBzZWxmLl9jdXJzb3IucmVtb3ZlTGlzdGVuZXIoXCJkYXRhXCIsIGRhdGFIYW5kbGVyKTtcclxuICAgICAgICAgICAgc2VsZi5fY3Vyc29yLnJlbW92ZUxpc3RlbmVyKFwiZXJyb3JcIiwgZXJyb3JIYW5kbGVyKTtcclxuICAgICAgICAgICAgc2VsZi5fY3Vyc29yLnJlbW92ZUxpc3RlbmVyKFwiZW5kXCIsIGVuZEhhbmRsZXIpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IHJlZ2lzdGVyRW5kID0gZnVuY3Rpb24ocmVzdWx0KSB7XHJcbiAgICAgICAgICAgIGlmICghcmVwb3J0ZWQpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5jbG9zZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuX2VuZCA9IHJlc3VsdDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGZpbmFsbHkge1xyXG4gICAgICAgICAgICAgICAgICAgIHVuaW5zdGFsbEhhbmRsZXJzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVwb3J0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICB2YXIgZGF0YUhhbmRsZXIgPSBmdW5jdGlvbiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgIHNlbGYuX2N1cnNvci5wYXVzZSgpO1xyXG4gICAgICAgICAgICBjYihudWxsLCByZXN1bHQpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdmFyIGVycm9ySGFuZGxlciA9IGZ1bmN0aW9uIChlcnIpIHtcclxuICAgICAgICAgICAgcmVnaXN0ZXJFbmQoZXJyKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHZhciBlbmRIYW5kbGVyID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZWdpc3RlckVuZCh0cnVlKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmIChzZWxmLl9lbmQpIHtcclxuICAgICAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VsZi5fZW5kKSkge1xyXG4gICAgICAgICAgICAgICAgY2Ioc2VsZi5fZW5kLCBudWxsKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNiKG51bGwsIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBpbnN0YWxsSGFuZGxlcnMoKTtcclxuICAgICAgICAgICAgdGhpcy5fY3Vyc29yLnJlc3VtZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufTtcclxuXHJcbkl0ZXJhdGVDdXJzb3IucHJvdG90eXBlLmNsb3NlID0gZnVuY3Rpb24oKSB7XHJcbiAgICBpZiAodGhpcy5fY3Vyc29yKSB7XHJcbiAgICAgICAgVW5pdE9mV29yay51bnJlZ2lzdGVyT3BlbmVkQ3Vyc29yKHRoaXMuX3Njb3BlLCB0aGlzLl9jdXJzb3IpO1xyXG4gICAgICAgIHRoaXMuX2N1cnNvci5jbG9zZSgpO1xyXG4gICAgICAgIHRoaXMuX2N1cnNvciA9IG51bGw7XHJcbiAgICB9XHJcbn07XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVJdGVyYXRvcihzY29wZSwgb2JqKSB7XHJcbiAgICBsZXQgaXQ7XHJcbiAgICBpZiAob2JqKSB7XHJcbiAgICAgICAgaWYgKG9iaiBpbnN0YW5jZW9mIENvbGxlY3Rpb24pIHtcclxuICAgICAgICAgICAgaXQgPSBuZXcgSXRlcmF0ZUN1cnNvcihzY29wZSwgb2JqLmZpbmQoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKF8uaXNGdW5jdGlvbihvYmoubmV4dCkgfHwgXy5pc0Z1bmN0aW9uKG9iai5uZXh0T2JqZWN0KSkge1xyXG4gICAgICAgICAgICBpdCA9IG5ldyBJdGVyYXRlQ3Vyc29yKHNjb3BlLCBvYmopO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIGlmIChfLmlzQXJyYXkob2JqKSkge1xyXG4gICAgICAgICAgICBpdCA9IG5ldyBJdGVyYXRlQXJyYXkob2JqKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGl0ID0gbmV3IEl0ZXJhdGVPYmoob2JqKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChvYmopKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCB2YWx1ZSBvZiAnb2JqJyBleHBlY3RlZC5cIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGl0ID0ge1xyXG4gICAgICAgICAgICBuZXh0OiBmdW5jdGlvbiAoY2IpIHtcclxuICAgICAgICAgICAgICAgIGNiKG51bGwsIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHJldHVybiBCbHVlYmlyZC5wcm9taXNpZnlBbGwoaXQpO1xyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IGNyZWF0ZUl0ZXJhdG9yOyJdfQ==
