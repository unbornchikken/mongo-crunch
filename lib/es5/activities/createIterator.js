"use strict";
"use strict";
var _ = require("lodash");
var UnitOfWork = require("./unitOfWork");
var Collection = require("mongodb").Collection;
var Bluebird = require("bluebird");
function IterateObj(obj) {
  this._obj = obj;
}
IterateObj.prototype.next = function(cb) {
  if (!_.isNull(this._obj)) {
    var o = this._obj;
    this._obj = null;
    cb(null, o);
  } else {
    cb(null, null);
  }
};
IterateObj.prototype.close = _.noop;
function IterateArray(array) {
  this._array = array;
  this._index = 0;
}
IterateArray.prototype.next = function(cb) {
  if (this._index < this._array.length) {
    cb(null, this._array[this._index++]);
  } else {
    cb(null, null);
  }
};
IterateArray.prototype.close = _.noop;
function IterateCursor(scope, cursor) {
  this._scope = scope;
  this._cursor = cursor;
  if (!(this._next = this._cursor.nextObject || this._cursor.next)) {
    this._cursor.pause();
  }
  this._on = false;
}
IterateCursor.prototype.next = function(cb) {
  var self = this;
  if (this._next) {
    this._next.call(this._cursor, function(err, result) {
      if (err || !result) {
        try {
          self.close();
        } catch (err2) {
          cb(err2);
          return;
        }
      }
      cb(err, result);
    });
  } else {
    var reported = false;
    var installHandlers = function() {
      if (!self._on) {
        self._cursor.on("data", dataHandler);
        self._cursor.on("error", errorHandler);
        self._cursor.on("end", endHandler);
        self._on = true;
      }
    };
    var uninstallHandlers = function() {
      self._cursor.removeListener("data", dataHandler);
      self._cursor.removeListener("error", errorHandler);
      self._cursor.removeListener("end", endHandler);
    };
    var registerEnd = function(result) {
      if (!reported) {
        try {
          self.close();
          self._end = result;
        } finally {
          uninstallHandlers();
          reported = true;
        }
      }
    };
    var dataHandler = function(result) {
      self._cursor.pause();
      cb(null, result);
    };
    var errorHandler = function(err) {
      registerEnd(err);
    };
    var endHandler = function() {
      registerEnd(true);
    };
    if (self._end) {
      if (_.isObject(self._end)) {
        cb(self._end, null);
      } else {
        cb(null, null);
      }
    } else {
      installHandlers();
      this._cursor.resume();
    }
  }
};
IterateCursor.prototype.close = function() {
  if (this._cursor) {
    UnitOfWork.unregisterOpenedCursor(this._scope, this._cursor);
    this._cursor.close();
    this._cursor = null;
  }
};
function createIterator(scope, obj) {
  var it;
  if (obj) {
    if (obj instanceof Collection) {
      it = new IterateCursor(scope, obj.find());
    } else if (_.isFunction(obj.next) || _.isFunction(obj.nextObject)) {
      it = new IterateCursor(scope, obj);
    } else if (_.isArray(obj)) {
      it = new IterateArray(obj);
    } else {
      it = new IterateObj(obj);
    }
  } else {
    if (_.isUndefined(obj)) {
      throw new TypeError("Argument value of 'obj' expected.");
    }
    it = {next: function(cb) {
        cb(null, null);
      }};
  }
  return Bluebird.promisifyAll(it);
}
module.exports = createIterator;
//# sourceMappingURL=data:application/json;base64,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QztBQUNOLEtBQUksR0FBRSxDQUFHO0FBQ0wsT0FBSSxHQUFFLFdBQWEsV0FBUyxDQUFHO0FBQzNCLE9BQUMsRUFBSSxJQUFJLGNBQVksQUFBQyxDQUFDLEtBQUksQ0FBRyxDQUFBLEdBQUUsS0FBSyxBQUFDLEVBQUMsQ0FBQyxDQUFDO0lBQzdDLEtBQ0ssS0FBSSxDQUFBLFdBQVcsQUFBQyxDQUFDLEdBQUUsS0FBSyxDQUFDLENBQUEsRUFBSyxDQUFBLENBQUEsV0FBVyxBQUFDLENBQUMsR0FBRSxXQUFXLENBQUMsQ0FBRztBQUM3RCxPQUFDLEVBQUksSUFBSSxjQUFZLEFBQUMsQ0FBQyxLQUFJLENBQUcsSUFBRSxDQUFDLENBQUM7SUFDdEMsS0FDSyxLQUFJLENBQUEsUUFBUSxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUc7QUFDckIsT0FBQyxFQUFJLElBQUksYUFBVyxBQUFDLENBQUMsR0FBRSxDQUFDLENBQUM7SUFDOUIsS0FDSztBQUNELE9BQUMsRUFBSSxJQUFJLFdBQVMsQUFBQyxDQUFDLEdBQUUsQ0FBQyxDQUFDO0lBQzVCO0FBQUEsRUFDSixLQUNLO0FBQ0QsT0FBSSxDQUFBLFlBQVksQUFBQyxDQUFDLEdBQUUsQ0FBQyxDQUFHO0FBQ3BCLFVBQU0sSUFBSSxVQUFRLEFBQUMsQ0FBQyxtQ0FBa0MsQ0FBQyxDQUFDO0lBQzVEO0FBQUEsQUFDQSxLQUFDLEVBQUksRUFDRCxJQUFHLENBQUcsVUFBVSxFQUFDLENBQUc7QUFDaEIsU0FBQyxBQUFDLENBQUMsSUFBRyxDQUFHLEtBQUcsQ0FBQyxDQUFDO01BQ2xCLENBQ0osQ0FBQztFQUNMO0FBQUEsQUFDQSxPQUFPLENBQUEsUUFBTyxhQUFhLEFBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztBQUNwQztBQUFBLEFBRUEsS0FBSyxRQUFRLEVBQUksZUFBYSxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9jcmVhdGVJdGVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgVW5pdE9mV29yayA9IHJlcXVpcmUoXCIuL3VuaXRPZldvcmtcIik7XG5sZXQgQ29sbGVjdGlvbiA9IHJlcXVpcmUoXCJtb25nb2RiXCIpLkNvbGxlY3Rpb247XG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5cbmZ1bmN0aW9uIEl0ZXJhdGVPYmoob2JqKSB7XG4gICAgdGhpcy5fb2JqID0gb2JqO1xufVxuXG5JdGVyYXRlT2JqLnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gKGNiKSB7XG4gICAgaWYgKCFfLmlzTnVsbCh0aGlzLl9vYmopKSB7XG4gICAgICAgIGxldCBvID0gdGhpcy5fb2JqO1xuICAgICAgICB0aGlzLl9vYmogPSBudWxsO1xuICAgICAgICBjYihudWxsLCBvKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNiKG51bGwsIG51bGwpO1xuICAgIH1cbn07XG5cbkl0ZXJhdGVPYmoucHJvdG90eXBlLmNsb3NlID0gXy5ub29wO1xuXG5mdW5jdGlvbiBJdGVyYXRlQXJyYXkoYXJyYXkpIHtcbiAgICB0aGlzLl9hcnJheSA9IGFycmF5O1xuICAgIHRoaXMuX2luZGV4ID0gMDtcbn1cblxuSXRlcmF0ZUFycmF5LnByb3RvdHlwZS5uZXh0ID0gZnVuY3Rpb24gKGNiKSB7XG4gICAgaWYgKHRoaXMuX2luZGV4IDwgdGhpcy5fYXJyYXkubGVuZ3RoKSB7XG4gICAgICAgIGNiKG51bGwsIHRoaXMuX2FycmF5W3RoaXMuX2luZGV4KytdKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNiKG51bGwsIG51bGwpO1xuICAgIH1cbn07XG5cbkl0ZXJhdGVBcnJheS5wcm90b3R5cGUuY2xvc2UgPSBfLm5vb3A7XG5cbmZ1bmN0aW9uIEl0ZXJhdGVDdXJzb3Ioc2NvcGUsIGN1cnNvcikge1xuICAgIHRoaXMuX3Njb3BlID0gc2NvcGU7XG4gICAgdGhpcy5fY3Vyc29yID0gY3Vyc29yO1xuICAgIGlmICghKHRoaXMuX25leHQgPSB0aGlzLl9jdXJzb3IubmV4dE9iamVjdCB8fCB0aGlzLl9jdXJzb3IubmV4dCkpIHtcbiAgICAgICAgdGhpcy5fY3Vyc29yLnBhdXNlKCk7XG4gICAgfVxuICAgIHRoaXMuX29uID0gZmFsc2U7XG59XG5cbkl0ZXJhdGVDdXJzb3IucHJvdG90eXBlLm5leHQgPSBmdW5jdGlvbiAoY2IpIHtcbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgaWYgKHRoaXMuX25leHQpIHtcbiAgICAgICAgdGhpcy5fbmV4dC5jYWxsKHRoaXMuX2N1cnNvcixcbiAgICAgICAgICAgIGZ1bmN0aW9uIChlcnIsIHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIGlmIChlcnIgfHwgIXJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNhdGNoIChlcnIyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYihlcnIyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYihlcnIsIHJlc3VsdCk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHZhciByZXBvcnRlZCA9IGZhbHNlO1xuICAgICAgICBsZXQgaW5zdGFsbEhhbmRsZXJzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKCFzZWxmLl9vbikge1xuICAgICAgICAgICAgICAgIHNlbGYuX2N1cnNvci5vbihcImRhdGFcIiwgZGF0YUhhbmRsZXIpO1xuICAgICAgICAgICAgICAgIHNlbGYuX2N1cnNvci5vbihcImVycm9yXCIsIGVycm9ySGFuZGxlcik7XG4gICAgICAgICAgICAgICAgc2VsZi5fY3Vyc29yLm9uKFwiZW5kXCIsIGVuZEhhbmRsZXIpO1xuICAgICAgICAgICAgICAgIHNlbGYuX29uID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgbGV0IHVuaW5zdGFsbEhhbmRsZXJzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgc2VsZi5fY3Vyc29yLnJlbW92ZUxpc3RlbmVyKFwiZGF0YVwiLCBkYXRhSGFuZGxlcik7XG4gICAgICAgICAgICBzZWxmLl9jdXJzb3IucmVtb3ZlTGlzdGVuZXIoXCJlcnJvclwiLCBlcnJvckhhbmRsZXIpO1xuICAgICAgICAgICAgc2VsZi5fY3Vyc29yLnJlbW92ZUxpc3RlbmVyKFwiZW5kXCIsIGVuZEhhbmRsZXIpO1xuICAgICAgICB9O1xuICAgICAgICBsZXQgcmVnaXN0ZXJFbmQgPSBmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgIGlmICghcmVwb3J0ZWQpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBzZWxmLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgIHNlbGYuX2VuZCA9IHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZmluYWxseSB7XG4gICAgICAgICAgICAgICAgICAgIHVuaW5zdGFsbEhhbmRsZXJzKCk7XG4gICAgICAgICAgICAgICAgICAgIHJlcG9ydGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHZhciBkYXRhSGFuZGxlciA9IGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgICAgIHNlbGYuX2N1cnNvci5wYXVzZSgpO1xuICAgICAgICAgICAgY2IobnVsbCwgcmVzdWx0KTtcbiAgICAgICAgfTtcbiAgICAgICAgdmFyIGVycm9ySGFuZGxlciA9IGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgIHJlZ2lzdGVyRW5kKGVycik7XG4gICAgICAgIH07XG4gICAgICAgIHZhciBlbmRIYW5kbGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmVnaXN0ZXJFbmQodHJ1ZSk7XG4gICAgICAgIH07XG4gICAgICAgIGlmIChzZWxmLl9lbmQpIHtcbiAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KHNlbGYuX2VuZCkpIHtcbiAgICAgICAgICAgICAgICBjYihzZWxmLl9lbmQsIG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY2IobnVsbCwgbnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBpbnN0YWxsSGFuZGxlcnMoKTtcbiAgICAgICAgICAgIHRoaXMuX2N1cnNvci5yZXN1bWUoKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbkl0ZXJhdGVDdXJzb3IucHJvdG90eXBlLmNsb3NlID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMuX2N1cnNvcikge1xuICAgICAgICBVbml0T2ZXb3JrLnVucmVnaXN0ZXJPcGVuZWRDdXJzb3IodGhpcy5fc2NvcGUsIHRoaXMuX2N1cnNvcik7XG4gICAgICAgIHRoaXMuX2N1cnNvci5jbG9zZSgpO1xuICAgICAgICB0aGlzLl9jdXJzb3IgPSBudWxsO1xuICAgIH1cbn07XG5cbmZ1bmN0aW9uIGNyZWF0ZUl0ZXJhdG9yKHNjb3BlLCBvYmopIHtcbiAgICBsZXQgaXQ7XG4gICAgaWYgKG9iaikge1xuICAgICAgICBpZiAob2JqIGluc3RhbmNlb2YgQ29sbGVjdGlvbikge1xuICAgICAgICAgICAgaXQgPSBuZXcgSXRlcmF0ZUN1cnNvcihzY29wZSwgb2JqLmZpbmQoKSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoXy5pc0Z1bmN0aW9uKG9iai5uZXh0KSB8fCBfLmlzRnVuY3Rpb24ob2JqLm5leHRPYmplY3QpKSB7XG4gICAgICAgICAgICBpdCA9IG5ldyBJdGVyYXRlQ3Vyc29yKHNjb3BlLCBvYmopO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKF8uaXNBcnJheShvYmopKSB7XG4gICAgICAgICAgICBpdCA9IG5ldyBJdGVyYXRlQXJyYXkob2JqKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGl0ID0gbmV3IEl0ZXJhdGVPYmoob2JqKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQob2JqKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIkFyZ3VtZW50IHZhbHVlIG9mICdvYmonIGV4cGVjdGVkLlwiKTtcbiAgICAgICAgfVxuICAgICAgICBpdCA9IHtcbiAgICAgICAgICAgIG5leHQ6IGZ1bmN0aW9uIChjYikge1xuICAgICAgICAgICAgICAgIGNiKG51bGwsIG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gQmx1ZWJpcmQucHJvbWlzaWZ5QWxsKGl0KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBjcmVhdGVJdGVyYXRvcjsiXX0=
