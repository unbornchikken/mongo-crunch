"use strict";
var util = require("util");
var Query = require("./query");
var UnitOfWork = require("./unitOfWork");
var debug = require("debug")("mongo-crunch:Apply");
var Bluebird = require("bluebird");
var async = Bluebird.coroutine;
var _ = require("lodash");
var Collection = require("mongodb").Collection;
var wf4node = require("workflow-4-node");
var Activity = wf4node.activities.Activity;
var ApplyCursor = require("./applyCursor");
var TransformCursor = require("./transformCursor");
function Apply() {
  Query.call(this);
  this.toArray = false;
  this.transform = null;
  this.nonScopedProperties.add("_apply");
  this.codeProperties.add("transform");
}
util.inherits(Apply, Query);
Apply.prototype.doQuery = function(callContext, query, options) {
  this._query = query;
  this._options = options;
  callContext.schedule(this._args, "_argsGot");
};
Apply.prototype._argsGot = function(callContext, reason, result) {
  if (reason !== Activity.states.complete) {
    callContext.end(reason, result);
    return;
  }
  this._args = result;
  callContext.schedule(this.transform, "_transformGot");
};
Apply.prototype._transformGot = function(callContext, reason, result) {
  if (reason !== Activity.states.complete) {
    callContext.end(reason, result);
    return;
  }
  var self = this;
  var args = this._args;
  var transform = result;
  var query = this._query;
  var options = this._options || {};
  var coll = this.getCollection.call(this);
  query = query || {};
  var cursor;
  if (_.isPlainObject(query.pipeline) || _.isArray(query.pipeline)) {
    if (_.isUndefined(options.allowDiskUse)) {
      options.allowDiskUse = true;
    }
    debug("Creating cursor on '%s' for aggregate pipeline:\n%j\noptions:\n%j", coll.collectionName, query.pipeline, options);
    cursor = coll.aggregate(query.pipeline, options);
  } else {
    debug("Creating cursor on '%s' for query:\n%j\noptions:\n%j", coll.collectionName, query, options);
    cursor = coll.find(query, options);
  }
  cursor = callContext.activity._apply.call(this, args, coll, cursor, options);
  if (_.isFunction(transform)) {
    cursor = new TransformCursor(this, cursor, transform);
  }
  if (self.toArray) {
    debug("Converting cursor to array.");
    cursor.toArray(function(err, _result) {
      if (err) {
        callContext.fail(err);
      } else {
        debug(("_result documents count: " + _result.length));
        callContext.complete(_result);
      }
      cursor.close();
    });
  } else {
    debug("Registering cursor in context.");
    UnitOfWork.registerOpenedcursor(self, cursor);
    callContext.complete(cursor);
  }
};
Apply.prototype._apply = function(operands, coll, cursor, options) {
  if (_.isPlainObject(operands)) {
    operands = [operands];
  }
  if (!operands) {
    return cursor;
  }
  if (!_.isArray(operands)) {
    throw new Error("Operands should be and array or a plain object.");
  }
  options = _.clone(options);
  debug(("Applying " + operands.length + " operands to cursor."));
  for (var i = 0; i < operands.length; i++) {
    var operand = operands[i];
    if (!_.isPlainObject(operand)) {
      throw new Error(("Operand " + i + ". should be a plain object."));
    }
    if (!_.isPlainObject(operand.query)) {
      throw new Error(("Operand " + i + ". property of 'query' should be a plain object."));
    }
    if (!_.isString(operand.name)) {
      throw new Error(("Operand " + i + ". property of 'name' should be a string."));
    }
    var opColl = coll;
    if (operand.collection instanceof Collection) {
      opColl = operand.collection;
    }
    options.fields = operand.fields || undefined;
    var type = operand.type || "outer";
    if (type !== "outer" && type !== "cross") {
      throw new Error(("Operand " + i + ". type's value '" + type + "' is invalid."));
    }
    var applyPars = {
      scope: this,
      cursor: cursor,
      collection: opColl,
      query: operand.query,
      type: type,
      name: operand.name,
      flat: operand.flat,
      options: options
    };
    debug("Applying operand, collection: '%s', query:\n%j\ntype:%s\nflat:%s\nname:%s\noptions:\n%j", applyPars.collection.collectionName, applyPars.query, applyPars.type, applyPars.flat, applyPars.name, applyPars.options);
    cursor = new ApplyCursor(applyPars);
  }
  return cursor;
};
module.exports = Apply;
//# sourceMappingURL=data:application/json;base64,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aXRpZXMvYXBwbHkuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxubGV0IHV0aWwgPSByZXF1aXJlKFwidXRpbFwiKTtcclxubGV0IFF1ZXJ5ID0gcmVxdWlyZShcIi4vcXVlcnlcIik7XHJcbmxldCBVbml0T2ZXb3JrID0gcmVxdWlyZShcIi4vdW5pdE9mV29ya1wiKTtcclxubGV0IGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpKFwibW9uZ28tY3J1bmNoOkFwcGx5XCIpO1xyXG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XHJcbmxldCBhc3luYyA9IEJsdWViaXJkLmNvcm91dGluZTtcclxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG5sZXQgQ29sbGVjdGlvbiA9IHJlcXVpcmUoXCJtb25nb2RiXCIpLkNvbGxlY3Rpb247XHJcbmxldCB3ZjRub2RlID0gcmVxdWlyZShcIndvcmtmbG93LTQtbm9kZVwiKTtcclxubGV0IEFjdGl2aXR5ID0gd2Y0bm9kZS5hY3Rpdml0aWVzLkFjdGl2aXR5O1xyXG5sZXQgQXBwbHlDdXJzb3IgPSByZXF1aXJlKFwiLi9hcHBseUN1cnNvclwiKTtcclxubGV0IFRyYW5zZm9ybUN1cnNvciA9IHJlcXVpcmUoXCIuL3RyYW5zZm9ybUN1cnNvclwiKTtcclxuXHJcbmZ1bmN0aW9uIEFwcGx5KCkge1xyXG4gICAgUXVlcnkuY2FsbCh0aGlzKTtcclxuXHJcbiAgICB0aGlzLnRvQXJyYXkgPSBmYWxzZTtcclxuICAgIHRoaXMudHJhbnNmb3JtID0gbnVsbDtcclxuICAgIHRoaXMubm9uU2NvcGVkUHJvcGVydGllcy5hZGQoXCJfYXBwbHlcIik7XHJcbiAgICB0aGlzLmNvZGVQcm9wZXJ0aWVzLmFkZChcInRyYW5zZm9ybVwiKTtcclxufVxyXG5cclxudXRpbC5pbmhlcml0cyhBcHBseSwgUXVlcnkpO1xyXG5cclxuQXBwbHkucHJvdG90eXBlLmRvUXVlcnkgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIHF1ZXJ5LCBvcHRpb25zKSB7XHJcbiAgICB0aGlzLl9xdWVyeSA9IHF1ZXJ5O1xyXG4gICAgdGhpcy5fb3B0aW9ucyA9IG9wdGlvbnM7XHJcbiAgICBjYWxsQ29udGV4dC5zY2hlZHVsZSh0aGlzLl9hcmdzLCBcIl9hcmdzR290XCIpO1xyXG59O1xyXG5cclxuQXBwbHkucHJvdG90eXBlLl9hcmdzR290ID0gZnVuY3Rpb24oY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICBpZiAocmVhc29uICE9PSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUpIHtcclxuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuX2FyZ3MgPSByZXN1bHQ7XHJcbiAgICBjYWxsQ29udGV4dC5zY2hlZHVsZSh0aGlzLnRyYW5zZm9ybSwgXCJfdHJhbnNmb3JtR290XCIpO1xyXG59O1xyXG5cclxuQXBwbHkucHJvdG90eXBlLl90cmFuc2Zvcm1Hb3QgPSBmdW5jdGlvbihjYWxsQ29udGV4dCwgcmVhc29uLCByZXN1bHQpIHtcclxuICAgIGlmIChyZWFzb24gIT09IEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZSkge1xyXG4gICAgICAgIGNhbGxDb250ZXh0LmVuZChyZWFzb24sIHJlc3VsdCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBzZWxmID0gdGhpcztcclxuICAgIGxldCBhcmdzID0gdGhpcy5fYXJncztcclxuICAgIGxldCB0cmFuc2Zvcm0gPSByZXN1bHQ7XHJcbiAgICBsZXQgcXVlcnkgPSB0aGlzLl9xdWVyeTtcclxuICAgIGxldCBvcHRpb25zID0gdGhpcy5fb3B0aW9ucyB8fCB7fTtcclxuICAgIGxldCBjb2xsID0gdGhpcy5nZXRDb2xsZWN0aW9uLmNhbGwodGhpcyk7XHJcbiAgICBxdWVyeSA9IHF1ZXJ5IHx8IHt9O1xyXG4gICAgbGV0IGN1cnNvcjtcclxuICAgIGlmIChfLmlzUGxhaW5PYmplY3QocXVlcnkucGlwZWxpbmUpIHx8IF8uaXNBcnJheShxdWVyeS5waXBlbGluZSkpIHtcclxuICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChvcHRpb25zLmFsbG93RGlza1VzZSkpIHtcclxuICAgICAgICAgICAgb3B0aW9ucy5hbGxvd0Rpc2tVc2UgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBkZWJ1ZyhcIkNyZWF0aW5nIGN1cnNvciBvbiAnJXMnIGZvciBhZ2dyZWdhdGUgcGlwZWxpbmU6XFxuJWpcXG5vcHRpb25zOlxcbiVqXCIsIGNvbGwuY29sbGVjdGlvbk5hbWUsIHF1ZXJ5LnBpcGVsaW5lLCBvcHRpb25zKTtcclxuICAgICAgICBjdXJzb3IgPSBjb2xsLmFnZ3JlZ2F0ZShxdWVyeS5waXBlbGluZSwgb3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBkZWJ1ZyhcIkNyZWF0aW5nIGN1cnNvciBvbiAnJXMnIGZvciBxdWVyeTpcXG4lalxcbm9wdGlvbnM6XFxuJWpcIiwgY29sbC5jb2xsZWN0aW9uTmFtZSwgcXVlcnksIG9wdGlvbnMpO1xyXG4gICAgICAgIGN1cnNvciA9IGNvbGwuZmluZChxdWVyeSwgb3B0aW9ucyk7XHJcbiAgICB9XHJcbiAgICBjdXJzb3IgPSBjYWxsQ29udGV4dC5hY3Rpdml0eS5fYXBwbHkuY2FsbCh0aGlzLCBhcmdzLCBjb2xsLCBjdXJzb3IsIG9wdGlvbnMpO1xyXG4gICAgaWYgKF8uaXNGdW5jdGlvbih0cmFuc2Zvcm0pKSB7XHJcbiAgICAgICAgY3Vyc29yID0gbmV3IFRyYW5zZm9ybUN1cnNvcih0aGlzLCBjdXJzb3IsIHRyYW5zZm9ybSk7XHJcbiAgICB9XHJcbiAgICBpZiAoc2VsZi50b0FycmF5KSB7XHJcbiAgICAgICAgZGVidWcoYENvbnZlcnRpbmcgY3Vyc29yIHRvIGFycmF5LmApO1xyXG4gICAgICAgIGN1cnNvci50b0FycmF5KGZ1bmN0aW9uIChlcnIsIF9yZXN1bHQpIHtcclxuICAgICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAgICAgY2FsbENvbnRleHQuZmFpbChlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZGVidWcoYF9yZXN1bHQgZG9jdW1lbnRzIGNvdW50OiAke19yZXN1bHQubGVuZ3RofWApO1xyXG4gICAgICAgICAgICAgICAgY2FsbENvbnRleHQuY29tcGxldGUoX3Jlc3VsdCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY3Vyc29yLmNsb3NlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBkZWJ1ZyhgUmVnaXN0ZXJpbmcgY3Vyc29yIGluIGNvbnRleHQuYCk7XHJcbiAgICAgICAgVW5pdE9mV29yay5yZWdpc3Rlck9wZW5lZGN1cnNvcihzZWxmLCBjdXJzb3IpO1xyXG4gICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKGN1cnNvcik7XHJcbiAgICB9XHJcbn07XHJcblxyXG5BcHBseS5wcm90b3R5cGUuX2FwcGx5ID0gZnVuY3Rpb24ob3BlcmFuZHMsIGNvbGwsIGN1cnNvciwgb3B0aW9ucykge1xyXG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdChvcGVyYW5kcykpIHtcclxuICAgICAgICBvcGVyYW5kcyA9IFtvcGVyYW5kc107XHJcbiAgICB9XHJcbiAgICBpZiAoIW9wZXJhbmRzKSB7XHJcbiAgICAgICAgcmV0dXJuIGN1cnNvcjtcclxuICAgIH1cclxuICAgIGlmICghXy5pc0FycmF5KG9wZXJhbmRzKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIk9wZXJhbmRzIHNob3VsZCBiZSBhbmQgYXJyYXkgb3IgYSBwbGFpbiBvYmplY3QuXCIpO1xyXG4gICAgfVxyXG4gICAgb3B0aW9ucyA9IF8uY2xvbmUob3B0aW9ucyk7XHJcbiAgICBkZWJ1ZyhgQXBwbHlpbmcgJHtvcGVyYW5kcy5sZW5ndGh9IG9wZXJhbmRzIHRvIGN1cnNvci5gKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3BlcmFuZHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBsZXQgb3BlcmFuZCA9IG9wZXJhbmRzW2ldO1xyXG4gICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG9wZXJhbmQpKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgT3BlcmFuZCAke2l9LiBzaG91bGQgYmUgYSBwbGFpbiBvYmplY3QuYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghXy5pc1BsYWluT2JqZWN0KG9wZXJhbmQucXVlcnkpKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgT3BlcmFuZCAke2l9LiBwcm9wZXJ0eSBvZiAncXVlcnknIHNob3VsZCBiZSBhIHBsYWluIG9iamVjdC5gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFfLmlzU3RyaW5nKG9wZXJhbmQubmFtZSkpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcGVyYW5kICR7aX0uIHByb3BlcnR5IG9mICduYW1lJyBzaG91bGQgYmUgYSBzdHJpbmcuYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBvcENvbGwgPSBjb2xsO1xyXG4gICAgICAgIGlmIChvcGVyYW5kLmNvbGxlY3Rpb24gaW5zdGFuY2VvZiBDb2xsZWN0aW9uKSB7XHJcbiAgICAgICAgICAgIG9wQ29sbCA9IG9wZXJhbmQuY29sbGVjdGlvbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgb3B0aW9ucy5maWVsZHMgPSBvcGVyYW5kLmZpZWxkcyB8fCB1bmRlZmluZWQ7XHJcbiAgICAgICAgbGV0IHR5cGUgPSBvcGVyYW5kLnR5cGUgfHwgXCJvdXRlclwiO1xyXG4gICAgICAgIGlmICh0eXBlICE9PSBcIm91dGVyXCIgJiYgdHlwZSAhPT0gXCJjcm9zc1wiKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgT3BlcmFuZCAke2l9LiB0eXBlJ3MgdmFsdWUgJyR7dHlwZX0nIGlzIGludmFsaWQuYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBhcHBseVBhcnMgPSB7XHJcbiAgICAgICAgICAgIHNjb3BlOiB0aGlzLFxyXG4gICAgICAgICAgICBjdXJzb3I6IGN1cnNvcixcclxuICAgICAgICAgICAgY29sbGVjdGlvbjogb3BDb2xsLFxyXG4gICAgICAgICAgICBxdWVyeTogb3BlcmFuZC5xdWVyeSxcclxuICAgICAgICAgICAgdHlwZTogdHlwZSxcclxuICAgICAgICAgICAgbmFtZTogb3BlcmFuZC5uYW1lLFxyXG4gICAgICAgICAgICBmbGF0OiBvcGVyYW5kLmZsYXQsXHJcbiAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnNcclxuICAgICAgICB9O1xyXG4gICAgICAgIGRlYnVnKFwiQXBwbHlpbmcgb3BlcmFuZCwgY29sbGVjdGlvbjogJyVzJywgcXVlcnk6XFxuJWpcXG50eXBlOiVzXFxuZmxhdDolc1xcbm5hbWU6JXNcXG5vcHRpb25zOlxcbiVqXCIsXHJcbiAgICAgICAgICAgIGFwcGx5UGFycy5jb2xsZWN0aW9uLmNvbGxlY3Rpb25OYW1lLFxyXG4gICAgICAgICAgICBhcHBseVBhcnMucXVlcnksXHJcbiAgICAgICAgICAgIGFwcGx5UGFycy50eXBlLFxyXG4gICAgICAgICAgICBhcHBseVBhcnMuZmxhdCxcclxuICAgICAgICAgICAgYXBwbHlQYXJzLm5hbWUsXHJcbiAgICAgICAgICAgIGFwcGx5UGFycy5vcHRpb25zKTtcclxuICAgICAgICBjdXJzb3IgPSBuZXcgQXBwbHlDdXJzb3IoYXBwbHlQYXJzKTtcclxuICAgIH1cclxuICAgIHJldHVybiBjdXJzb3I7XHJcbn07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IEFwcGx5OyJdfQ==
