"use strict";
var wf4node = require("workflow-4-node");
var util = require("util");
var Modify = require("./modify");
var Activity = wf4node.activities.Activity;
var debug = require("debug")("mongo-crunch:Insert");
var Bluebird = require("bluebird");
var _ = require("lodash");
var UnitOfWork = require("./unitOfWork");
var Collection = require("mongodb").Collection;
var createIterator = require("./createIterator");
var config = require("../config");
function Insert() {
  Modify.call(this);
  this.documents = null;
}
util.inherits(Insert, Modify);
Insert.prototype.doWork = function(callContext) {
  debug("Scheduling documents.");
  callContext.schedule(this.documents, "_documentsGot");
};
Insert.prototype._documentsGot = function(callContext, reason, result) {
  var self = this;
  if (reason === Activity.states.complete) {
    if (result) {
      var coll = this.getCollection.call(this);
      var options = this.getOptions.call(this);
      var it = createIterator(this, result);
      var bulk = coll.initializeUnorderedBulkOp();
      var count = 0;
      debug("Processing.");
      var process = function() {
        it.next(function(err, doc) {
          if (err) {
            debug(("Next failed.\n" + err.stack));
            callContext.fail(err);
          } else if (doc) {
            debug("Doc got:\n%j", doc);
            bulk.insert(_.clone(doc));
            count++;
            if (count >= config.bulkSize) {
              debug("Executing bulk.");
              bulk.execute(options, function(err2, bwResult) {
                if (err2) {
                  debug(("Bulk execute failed.\n" + (err2.stack ? err2.stack : err2)));
                  callContext.fail(err2);
                } else {
                  debug("Bulk executed.");
                  count = 0;
                  bulk = coll.initializeUnorderedBulkOp();
                  process();
                }
              });
            } else {
              process();
            }
          } else {
            if (!count) {
              callContext.complete();
            } else {
              debug("Executing final bulk.");
              bulk.execute(options, function(err2, bwResult) {
                if (err2) {
                  debug(("Bulk execute failed.\n" + err2.stack));
                  callContext.fail(err2);
                } else {
                  debug("Bulk executed.");
                  callContext.complete();
                }
              });
            }
          }
        });
      };
      process();
    } else {
      debug("No documents, ending.");
      callContext.end(reason);
    }
  } else {
    callContext.end(reason, result);
  }
};
module.exports = Insert;
//# sourceMappingURL=data:application/json;base64,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Q0FBQyxPQUFNLENBQUcsVUFBUyxJQUFHLENBQUcsQ0FBQSxRQUFPLENBQUc7QUFDM0MsbUJBQUksSUFBRyxDQUFHO0FBQ04sc0JBQUksQUFBQyxFQUFDLHdCQUF3QixFQUFDLENBQUEsSUFBRyxNQUFNLEVBQUcsQ0FBQztBQUM1Qyw0QkFBVSxLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztnQkFDMUIsS0FDSztBQUNELHNCQUFJLEFBQUMsQ0FBQyxnQkFBZSxDQUFDLENBQUM7QUFDdkIsNEJBQVUsU0FBUyxBQUFDLEVBQUMsQ0FBQztnQkFDMUI7QUFBQSxjQUNKLENBQUMsQ0FBQztZQUNOO0FBQUEsVUFDSjtBQUFBLFFBQ0osQ0FBQyxDQUFDO01BQ04sQ0FBQztBQUNELFlBQU0sQUFBQyxFQUFDLENBQUM7SUFDYixLQUNLO0FBQ0QsVUFBSSxBQUFDLENBQUMsdUJBQXNCLENBQUMsQ0FBQztBQUM5QixnQkFBVSxJQUFJLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztJQUMzQjtBQUFBLEVBQ0osS0FDSztBQUNELGNBQVUsSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFHLE9BQUssQ0FBQyxDQUFDO0VBQ25DO0FBQUEsQUFDSixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksT0FBSyxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9pbnNlcnQuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxubGV0IHdmNG5vZGUgPSByZXF1aXJlKFwid29ya2Zsb3ctNC1ub2RlXCIpO1xyXG5sZXQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG5sZXQgTW9kaWZ5ID0gcmVxdWlyZShcIi4vbW9kaWZ5XCIpO1xyXG5sZXQgQWN0aXZpdHkgPSB3ZjRub2RlLmFjdGl2aXRpZXMuQWN0aXZpdHk7XHJcbmxldCBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKShcIm1vbmdvLWNydW5jaDpJbnNlcnRcIik7XHJcbmxldCBCbHVlYmlyZCA9IHJlcXVpcmUoXCJibHVlYmlyZFwiKTtcclxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG5sZXQgVW5pdE9mV29yayA9IHJlcXVpcmUoXCIuL3VuaXRPZldvcmtcIik7XHJcbmxldCBDb2xsZWN0aW9uID0gcmVxdWlyZShcIm1vbmdvZGJcIikuQ29sbGVjdGlvbjtcclxubGV0IGNyZWF0ZUl0ZXJhdG9yID0gcmVxdWlyZShcIi4vY3JlYXRlSXRlcmF0b3JcIik7XHJcbmxldCBjb25maWcgPSByZXF1aXJlKFwiLi4vY29uZmlnXCIpO1xyXG5cclxuZnVuY3Rpb24gSW5zZXJ0KCkge1xyXG4gICAgTW9kaWZ5LmNhbGwodGhpcyk7XHJcblxyXG4gICAgdGhpcy5kb2N1bWVudHMgPSBudWxsO1xyXG59XHJcblxyXG51dGlsLmluaGVyaXRzKEluc2VydCwgTW9kaWZ5KTtcclxuXHJcbkluc2VydC5wcm90b3R5cGUuZG9Xb3JrID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0KSB7XHJcbiAgICBkZWJ1ZyhcIlNjaGVkdWxpbmcgZG9jdW1lbnRzLlwiKTtcclxuICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKHRoaXMuZG9jdW1lbnRzLCBcIl9kb2N1bWVudHNHb3RcIik7XHJcbn07XHJcblxyXG5JbnNlcnQucHJvdG90eXBlLl9kb2N1bWVudHNHb3QgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICBsZXQgc2VsZiA9IHRoaXM7XHJcbiAgICBpZiAocmVhc29uID09PSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUpIHtcclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgIGxldCBjb2xsID0gdGhpcy5nZXRDb2xsZWN0aW9uLmNhbGwodGhpcyk7XHJcbiAgICAgICAgICAgIGxldCBvcHRpb25zID0gdGhpcy5nZXRPcHRpb25zLmNhbGwodGhpcyk7XHJcbiAgICAgICAgICAgIGxldCBpdCA9IGNyZWF0ZUl0ZXJhdG9yKHRoaXMsIHJlc3VsdCk7XHJcbiAgICAgICAgICAgIGxldCBidWxrID0gY29sbC5pbml0aWFsaXplVW5vcmRlcmVkQnVsa09wKCk7XHJcbiAgICAgICAgICAgIHZhciBjb3VudCA9IDA7XHJcbiAgICAgICAgICAgIGRlYnVnKFwiUHJvY2Vzc2luZy5cIik7XHJcbiAgICAgICAgICAgIHZhciBwcm9jZXNzID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICBpdC5uZXh0KGZ1bmN0aW9uIChlcnIsIGRvYykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoYE5leHQgZmFpbGVkLlxcbiR7ZXJyLnN0YWNrfWApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsQ29udGV4dC5mYWlsKGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGRvYykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhcIkRvYyBnb3Q6XFxuJWpcIiwgZG9jKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnVsay5pbnNlcnQoXy5jbG9uZShkb2MpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY291bnQrKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvdW50ID49IGNvbmZpZy5idWxrU2l6ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoXCJFeGVjdXRpbmcgYnVsay5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWxrLmV4ZWN1dGUob3B0aW9ucywgZnVuY3Rpb24oZXJyMiwgYndSZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyMikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhgQnVsayBleGVjdXRlIGZhaWxlZC5cXG4ke2VycjIuc3RhY2sgPyBlcnIyLnN0YWNrIDogZXJyMn1gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbENvbnRleHQuZmFpbChlcnIyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKFwiQnVsayBleGVjdXRlZC5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVsayA9IGNvbGwuaW5pdGlhbGl6ZVVub3JkZXJlZEJ1bGtPcCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm9jZXNzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY291bnQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhcIkV4ZWN1dGluZyBmaW5hbCBidWxrLlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1bGsuZXhlY3V0ZShvcHRpb25zLCBmdW5jdGlvbihlcnIyLCBid1Jlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKGBCdWxrIGV4ZWN1dGUgZmFpbGVkLlxcbiR7ZXJyMi5zdGFja31gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbENvbnRleHQuZmFpbChlcnIyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKFwiQnVsayBleGVjdXRlZC5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgcHJvY2VzcygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgZGVidWcoXCJObyBkb2N1bWVudHMsIGVuZGluZy5cIik7XHJcbiAgICAgICAgICAgIGNhbGxDb250ZXh0LmVuZChyZWFzb24pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIGNhbGxDb250ZXh0LmVuZChyZWFzb24sIHJlc3VsdCk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IEluc2VydDsiXX0=
