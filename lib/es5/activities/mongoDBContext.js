"use strict";
"use strict";
var wf4node = require("../../../deps/workflow-4-node");
var Activity = wf4node.activities.Activity;
var util = require("util");
var activityMarkup = wf4node.activities.activityMarkup;
var _ = require("lodash");
var fast = require("fast.js");
var Bluebird = require("bluebird");
var MongoClient = require("mongodb").MongoClient;
var StrMap = require("backpack-node").collections.StrMap;
var debug = require("debug")("mongo-crunch:Context");
function MongoDBContext() {
  Activity.call(this);
  this.connections = null;
  this.body = null;
}
util.inherits(MongoDBContext, Activity);
MongoDBContext.prototype.run = function(callContext, args) {
  var self = this;
  var body = self.get("body");
  var connections = self.get("connections");
  debug(("Running connections: " + connections + "."));
  if (!body) {
    debug("There is no body, context completed.");
    callContext.complete();
    return ;
  }
  function toConnectionsArray(conns) {
    function toConnection(conn) {
      if (_.isString(conn)) {
        conn = {
          name: "default",
          url: conn,
          options: null
        };
      } else if (_.isObject(conn)) {
        conn = {
          name: conn.name || "default",
          url: conn.url,
          options: conn.options
        };
      } else {
        throw new Error("Connection is invalid: " + JSON.stringify(conn));
      }
      if (_.isString(conn.url) && conn.url) {
        return conn;
      }
      throw new Error("Connection is invalid: " + JSON.stringify(conn));
    }
    var result = [];
    if (_.isArray(conns)) {
      fast.forEach(conns, function(c) {
        result.push(toConnection(c));
      });
    } else {
      result.push(toConnection(conns));
    }
    return result;
  }
  try {
    debug("Parsing connections.");
    var connsDef = toConnectionsArray(connections);
    debug(("There is " + connsDef.length + " connection(s) has been defined."));
    var processedConns = new StrMap();
    fast.forEach(connsDef, function(conn) {
      if (!processedConns.containsKey(conn.name)) {
        processedConns.add(conn.name, conn);
      } else {
        throw new Error("Duplicated connection \"" + conn.name + "\".");
      }
    });
    var tasks = [];
    processedConns.forEachValue(function(conn) {
      debug(("Creating Db for connection " + conn.url + ", options " + conn.options + "."));
      tasks.push(Bluebird.promisify(MongoClient.connect)(conn.url, conn.options).then(function(db) {
        debug("Db created.");
        conn.db = db;
      }));
    });
    Bluebird.all(tasks).then(function() {
      var newConns = {};
      self.set("connections", newConns);
      self.set("MongoDBContext_CollectionRecycleBin", {});
      self.set("MongoDBContext_OpenedCursors", []);
      self.set("MongoDBContext_SeenCollections", []);
      processedConns.forEach(function(kvp) {
        newConns[kvp.key] = kvp.value.db;
      });
      debug("Context has been initialized, scheduling body.");
      callContext.schedule(body, "_bodyCompleted");
    }, function(e) {
      callContext.fail(e);
    });
  } catch (e) {
    callContext.fail(e);
  }
};
MongoDBContext.prototype._bodyCompleted = function(callContext, reason, result) {
  var self = this;
  debug(("Context's body completed, reason: " + reason + "."));
  if (reason !== Activity.states.complete) {
    debug("Reason is not complete, resuming call context.");
    callContext.end(reason, result);
    return ;
  }
  Bluebird.coroutine($traceurRuntime.initGeneratorFunction(function $__0() {
    var taskError,
        MongoDBContext_CollectionRecycleBin,
        MongoDBContext_OpenedCursors,
        tasks,
        binVals,
        connections,
        closeTasks,
        e;
    return $traceurRuntime.createGeneratorInstance(function($ctx) {
      while (true)
        switch ($ctx.state) {
          case 0:
            taskError = null;
            debug("Doing final tasks.");
            $ctx.state = 36;
            break;
          case 36:
            $ctx.pushTry(24, 25);
            $ctx.state = 27;
            break;
          case 27:
            MongoDBContext_CollectionRecycleBin = self.get("MongoDBContext_CollectionRecycleBin");
            MongoDBContext_OpenedCursors = self.get("MongoDBContext_OpenedCursors");
            tasks = [];
            binVals = _.values(MongoDBContext_CollectionRecycleBin);
            debug(("Collections in recycle bin: " + binVals.length + "."));
            fast.forEach(binVals, function(coll) {
              debug(("Dropping collection: " + coll.collectionName));
              tasks.push(Bluebird.promisify(coll.drop, coll)().then(function() {
                debug(("Collection '" + coll.collectionName + "' dropped."));
              }).catch(function(e) {
                if (e.name === "MongoError" && e.message === "ns not found") {
                  debug(("Collection '" + coll.collectionName + "' doesn't exists."));
                  return ;
                }
                debug(("ERROR: Collection '" + coll.collectionName + "' dropping failed with\n" + e.stack));
              }));
            });
            debug(("Cursors to close: " + MongoDBContext_OpenedCursors.length + "."));
            fast.forEach(MongoDBContext_OpenedCursors, function(c, idx) {
              tasks.push(Bluebird.promisify(c.close, c)().then(function() {
                debug(("Cursor " + idx + ". dropped."));
              }).catch(function(e) {
                debug(("ERROR: Cursor " + idx + ". closing failed with\n" + e.stack));
              }));
            });
            $ctx.state = 6;
            break;
          case 6:
            $ctx.state = 2;
            return Bluebird.all(tasks);
          case 2:
            $ctx.maybeThrow();
            $ctx.state = 4;
            break;
          case 4:
            $ctx.popTry();
            $ctx.state = 25;
            $ctx.finallyFallThrough = -2;
            break;
          case 24:
            $ctx.popTry();
            $ctx.maybeUncatchable();
            e = $ctx.storedException;
            $ctx.state = 30;
            break;
          case 30:
            taskError = e;
            $ctx.state = 25;
            $ctx.finallyFallThrough = -2;
            break;
          case 25:
            $ctx.popTry();
            $ctx.state = 34;
            break;
          case 34:
            self.delete("MongoDBContext_CollectionRecycleBin");
            self.delete("MongoDBContext_OpenedCursors");
            self.delete("MongoDBContext_SeenCollections");
            connections = self.get("connections");
            debug(("Closing " + connections.length + " connections."));
            closeTasks = [];
            fast.forEach(_.values(connections), function(db) {
              debug(("Closing '" + db.databaseName + "'."));
              closeTasks.push(Bluebird.promisify(db.close, db)(true).then(function() {
                debug(("Db '" + db.databaseName + "' closed."));
              }).catch(function(e) {
                debug(("ERROR: Closing Db '" + db.databaseName + "' failed with\n" + e.stack));
              }));
            });
            $ctx.state = 21;
            break;
          case 21:
            $ctx.pushTry(11, null);
            $ctx.state = 14;
            break;
          case 14:
            $ctx.state = 8;
            return Bluebird.all(closeTasks);
          case 8:
            $ctx.maybeThrow();
            $ctx.state = 10;
            break;
          case 10:
            $ctx.popTry();
            $ctx.state = 16;
            break;
          case 11:
            $ctx.popTry();
            $ctx.maybeUncatchable();
            e = $ctx.storedException;
            $ctx.state = 17;
            break;
          case 17:
            debug("ERROR: Cannot close MongoDB connections, error\n" + e.stack);
            $ctx.state = 16;
            break;
          case 16:
            if (taskError) {
              debug("ERROR: final tasks failed. Reporting error to call context.");
              callContext.fail(taskError);
            } else {
              debug("Final tasks completed.");
              callContext.complete();
            }
            $ctx.state = 23;
            break;
          case 23:
            $ctx.state = $ctx.finallyFallThrough;
            break;
          default:
            return $ctx.end();
        }
    }, $__0, this);
  }))();
};
MongoDBContext.addCollectionToRecycleBin = function(scope, collection) {
  var bin = scope.get("MongoDBContext_CollectionRecycleBin");
  debug(("Adding collection '" + collection.collectionName + "' to recycle bin."));
  bin[collection.collectionName] = collection;
  debug(("Recycle bin size is " + _.keys(bin).length + "."));
};
MongoDBContext.registerOpenedCursor = function(scope, cursor) {
  var cursors = scope.get("MongoDBContext_OpenedCursors");
  debug("Registering a cursor as opened.");
  cursors.push(cursor);
  debug(("There are " + cursors.length + " cursors registered."));
};
MongoDBContext.unregisterOpenedCursor = function(scope, cursor) {
  debug("Unregistering opened cursor.");
  scope.set("MongoDBContext_OpenedCursors", _.without(scope.get("MongoDBContext_OpenedCursors"), cursor));
  debug(("There are " + scope.get("MongoDBContext_OpenedCursors").length + " cursors registered."));
};
MongoDBContext.isFirstSeenCollection = function(scope, db, collectionName) {
  debug(("Determining if '" + collectionName + "' collection in '" + db.databaseName + "' db is first seen by the current context."));
  var colls = scope.get("MongoDBContext_SeenCollections");
  var entry = _.first(_.where(colls, {db: db}));
  if (!entry) {
    var collReg = {};
    collReg[collectionName] = true;
    colls.push({
      db: db,
      collections: collReg
    });
    debug("Fist seen.");
    return true;
  }
  if (!entry.collections[collectionName]) {
    entry.collections[collectionName] = true;
    debug("First seen.");
    return true;
  }
  debug("Not first seen.");
  return false;
};
module.exports = MongoDBContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vbmdvREJDb250ZXh0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsV0FBVyxDQUFDO0FBRVosQUFBSSxFQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsK0JBQThCLENBQUMsQ0FBQztBQUN0RCxBQUFJLEVBQUEsQ0FBQSxRQUFPLEVBQUksQ0FBQSxPQUFNLFdBQVcsU0FBUyxDQUFDO0FBQzFDLEFBQUksRUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLE9BQU0sQUFBQyxDQUFDLE1BQUssQ0FBQyxDQUFDO0FBQzFCLEFBQUksRUFBQSxDQUFBLGNBQWEsRUFBSSxDQUFBLE9BQU0sV0FBVyxlQUFlLENBQUM7QUFDdEQsQUFBSSxFQUFBLENBQUEsQ0FBQSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsUUFBTyxDQUFDLENBQUM7QUFDekIsQUFBSSxFQUFBLENBQUEsSUFBRyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsU0FBUSxDQUFDLENBQUM7QUFDN0IsQUFBSSxFQUFBLENBQUEsUUFBTyxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsVUFBUyxDQUFDLENBQUM7QUFDbEMsQUFBSSxFQUFBLENBQUEsV0FBVSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsU0FBUSxDQUFDLFlBQVksQ0FBQztBQUNoRCxBQUFJLEVBQUEsQ0FBQSxNQUFLLEVBQUksQ0FBQSxPQUFNLEFBQUMsQ0FBQyxlQUFjLENBQUMsWUFBWSxPQUFPLENBQUM7QUFDeEQsQUFBSSxFQUFBLENBQUEsS0FBSSxFQUFJLENBQUEsT0FBTSxBQUFDLENBQUMsT0FBTSxDQUFDLEFBQUMsQ0FBQyxzQkFBcUIsQ0FBQyxDQUFDO0FBRXBELE9BQVMsZUFBYSxDQUFHLEFBQUQsQ0FBRztBQUN2QixTQUFPLEtBQUssQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDO0FBRW5CLEtBQUcsWUFBWSxFQUFJLEtBQUcsQ0FBQztBQUN2QixLQUFHLEtBQUssRUFBSSxLQUFHLENBQUM7QUFDcEI7QUFBQSxBQUVBLEdBQUcsU0FBUyxBQUFDLENBQUMsY0FBYSxDQUFHLFNBQU8sQ0FBQyxDQUFDO0FBRXZDLGFBQWEsVUFBVSxJQUFJLEVBQUksVUFBVSxXQUFVLENBQUcsQ0FBQSxJQUFHLENBQUc7QUFDeEQsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUNmLEFBQUksSUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLElBQUcsSUFBSSxBQUFDLENBQUMsTUFBSyxDQUFDLENBQUM7QUFDM0IsQUFBSSxJQUFBLENBQUEsV0FBVSxFQUFJLENBQUEsSUFBRyxJQUFJLEFBQUMsQ0FBQyxhQUFZLENBQUMsQ0FBQztBQUV6QyxNQUFJLEFBQUMsRUFBQyx1QkFBdUIsRUFBQyxZQUFVLEVBQUMsSUFBRSxFQUFDLENBQUM7QUFFN0MsS0FBSSxDQUFDLElBQUcsQ0FBRztBQUNQLFFBQUksQUFBQyxDQUFDLHNDQUFxQyxDQUFDLENBQUM7QUFFN0MsY0FBVSxTQUFTLEFBQUMsRUFBQyxDQUFDO0FBQ3RCLFdBQU07RUFDVjtBQUFBLEFBRUEsU0FBUyxtQkFBaUIsQ0FBRyxLQUFJLENBQUc7QUFFaEMsV0FBUyxhQUFXLENBQUcsSUFBRyxDQUFHO0FBQ3pCLFNBQUksQ0FBQSxTQUFTLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBRztBQUNsQixXQUFHLEVBQUk7QUFDSCxhQUFHLENBQUcsVUFBUTtBQUNkLFlBQUUsQ0FBRyxLQUFHO0FBQ1IsZ0JBQU0sQ0FBRyxLQUFHO0FBQUEsUUFDaEIsQ0FBQztNQUNMLEtBQ0ssS0FBSSxDQUFBLFNBQVMsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFHO0FBQ3ZCLFdBQUcsRUFBSTtBQUNILGFBQUcsQ0FBRyxDQUFBLElBQUcsS0FBSyxHQUFLLFVBQVE7QUFDM0IsWUFBRSxDQUFHLENBQUEsSUFBRyxJQUFJO0FBQ1osZ0JBQU0sQ0FBRyxDQUFBLElBQUcsUUFBUTtBQUFBLFFBQ3hCLENBQUM7TUFDTCxLQUNLO0FBQ0QsWUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLHlCQUF3QixFQUFJLENBQUEsSUFBRyxVQUFVLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQyxDQUFDO01BQ3JFO0FBQUEsQUFFQSxTQUFJLENBQUEsU0FBUyxBQUFDLENBQUMsSUFBRyxJQUFJLENBQUMsQ0FBQSxFQUFLLENBQUEsSUFBRyxJQUFJLENBQUc7QUFDbEMsYUFBTyxLQUFHLENBQUM7TUFDZjtBQUFBLEFBQ0EsVUFBTSxJQUFJLE1BQUksQUFBQyxDQUFDLHlCQUF3QixFQUFJLENBQUEsSUFBRyxVQUFVLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3JFO0FBQUEsQUFFSSxNQUFBLENBQUEsTUFBSyxFQUFJLEdBQUMsQ0FBQztBQUNmLE9BQUksQ0FBQSxRQUFRLEFBQUMsQ0FBQyxLQUFJLENBQUMsQ0FBRztBQUNsQixTQUFHLFFBQVEsQUFBQyxDQUFDLEtBQUksQ0FBRyxVQUFVLENBQUEsQ0FBRztBQUM3QixhQUFLLEtBQUssQUFBQyxDQUFDLFlBQVcsQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUM7TUFDaEMsQ0FBQyxDQUFDO0lBQ04sS0FDSztBQUNELFdBQUssS0FBSyxBQUFDLENBQUMsWUFBVyxBQUFDLENBQUMsS0FBSSxDQUFDLENBQUMsQ0FBQztJQUNwQztBQUFBLEFBQ0EsU0FBTyxPQUFLLENBQUM7RUFDakI7QUFBQSxBQUVBLElBQUk7QUFDQSxRQUFJLEFBQUMsQ0FBQyxzQkFBcUIsQ0FBQyxDQUFDO0FBQzdCLEFBQUksTUFBQSxDQUFBLFFBQU8sRUFBSSxDQUFBLGtCQUFpQixBQUFDLENBQUMsV0FBVSxDQUFDLENBQUM7QUFDOUMsUUFBSSxBQUFDLEVBQUMsV0FBVyxFQUFDLENBQUEsUUFBTyxPQUFPLEVBQUMsbUNBQWlDLEVBQUMsQ0FBQztBQUNwRSxBQUFJLE1BQUEsQ0FBQSxjQUFhLEVBQUksSUFBSSxPQUFLLEFBQUMsRUFBQyxDQUFDO0FBQ2pDLE9BQUcsUUFBUSxBQUFDLENBQUMsUUFBTyxDQUFHLFVBQVUsSUFBRyxDQUFHO0FBQ25DLFNBQUksQ0FBQyxjQUFhLFlBQVksQUFBQyxDQUFDLElBQUcsS0FBSyxDQUFDLENBQUc7QUFDeEMscUJBQWEsSUFBSSxBQUFDLENBQUMsSUFBRyxLQUFLLENBQUcsS0FBRyxDQUFDLENBQUM7TUFDdkMsS0FDSztBQUNELFlBQU0sSUFBSSxNQUFJLEFBQUMsQ0FBQywwQkFBeUIsRUFBSSxDQUFBLElBQUcsS0FBSyxDQUFBLENBQUksTUFBSSxDQUFDLENBQUM7TUFDbkU7QUFBQSxJQUNKLENBQUMsQ0FBQztBQUVGLEFBQUksTUFBQSxDQUFBLEtBQUksRUFBSSxHQUFDLENBQUM7QUFDZCxpQkFBYSxhQUFhLEFBQUMsQ0FBQyxTQUFVLElBQUcsQ0FBRztBQUN4QyxVQUFJLEFBQUMsRUFBQyw2QkFBNkIsRUFBQyxDQUFBLElBQUcsSUFBSSxFQUFDLGFBQVksRUFBQyxDQUFBLElBQUcsUUFBUSxFQUFDLElBQUUsRUFBQyxDQUFDO0FBQ3pFLFVBQUksS0FBSyxBQUFDLENBQUMsUUFBTyxVQUFVLEFBQUMsQ0FBQyxXQUFVLFFBQVEsQ0FBQyxBQUFDLENBQUMsSUFBRyxJQUFJLENBQUcsQ0FBQSxJQUFHLFFBQVEsQ0FBQyxLQUFLLEFBQUMsQ0FBQyxTQUFVLEVBQUMsQ0FBRztBQUMxRixZQUFJLEFBQUMsQ0FBQyxhQUFZLENBQUMsQ0FBQztBQUNwQixXQUFHLEdBQUcsRUFBSSxHQUFDLENBQUM7TUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUM7QUFFRixXQUFPLElBQUksQUFBQyxDQUFDLEtBQUksQ0FBQyxLQUFLLEFBQUMsQ0FDcEIsU0FBVSxBQUFELENBQUc7QUFDUixBQUFJLFFBQUEsQ0FBQSxRQUFPLEVBQUksR0FBQyxDQUFDO0FBQ2pCLFNBQUcsSUFBSSxBQUFDLENBQUMsYUFBWSxDQUFHLFNBQU8sQ0FBQyxDQUFDO0FBQ2pDLFNBQUcsSUFBSSxBQUFDLENBQUMscUNBQW9DLENBQUcsR0FBQyxDQUFDLENBQUM7QUFDbkQsU0FBRyxJQUFJLEFBQUMsQ0FBQyw4QkFBNkIsQ0FBRyxHQUFDLENBQUMsQ0FBQztBQUM1QyxTQUFHLElBQUksQUFBQyxDQUFDLGdDQUErQixDQUFHLEdBQUMsQ0FBQyxDQUFDO0FBQzlDLG1CQUFhLFFBQVEsQUFBQyxDQUFDLFNBQVUsR0FBRSxDQUFHO0FBQ2xDLGVBQU8sQ0FBRSxHQUFFLElBQUksQ0FBQyxFQUFJLENBQUEsR0FBRSxNQUFNLEdBQUcsQ0FBQztNQUNwQyxDQUFDLENBQUM7QUFFRixVQUFJLEFBQUMsQ0FBQyxnREFBK0MsQ0FBQyxDQUFDO0FBQ3ZELGdCQUFVLFNBQVMsQUFBQyxDQUFDLElBQUcsQ0FBRyxpQkFBZSxDQUFDLENBQUM7SUFDaEQsQ0FDQSxVQUFVLENBQUEsQ0FBRztBQUNULGdCQUFVLEtBQUssQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBQ3ZCLENBQUMsQ0FBQztFQUNWLENBQ0EsT0FBTyxDQUFBLENBQUc7QUFDTixjQUFVLEtBQUssQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDO0VBQ3ZCO0FBQUEsQUFDSixDQUFDO0FBRUQsYUFBYSxVQUFVLGVBQWUsRUFBSSxVQUFVLFdBQVUsQ0FBRyxDQUFBLE1BQUssQ0FBRyxDQUFBLE1BQUs7QUFDMUUsQUFBSSxJQUFBLENBQUEsSUFBRyxFQUFJLEtBQUcsQ0FBQztBQUVmLE1BQUksQUFBQyxFQUFDLG9DQUFvQyxFQUFDLE9BQUssRUFBQyxJQUFFLEVBQUMsQ0FBQztBQUVyRCxLQUFJLE1BQUssSUFBTSxDQUFBLFFBQU8sT0FBTyxTQUFTLENBQUc7QUFDckMsUUFBSSxBQUFDLENBQUMsZ0RBQStDLENBQUMsQ0FBQztBQUN2RCxjQUFVLElBQUksQUFBQyxDQUFDLE1BQUssQ0FBRyxPQUFLLENBQUMsQ0FBQztBQUMvQixXQUFNO0VBQ1Y7QUFBQSxBQUVBLFNBQU8sVUFBVSxBQUFDLENBcEl0QixlQUFjLHNCQUFzQixBQUFDLENBb0lkLGNBQVcsQUFBRDs7Ozs7Ozs7O0FBcElqQyxTQUFPLENBQVAsZUFBYyx3QkFBd0IsQUFBZCxDQUF4QixTQUFTLElBQUcsQ0FBRztBQUNULFlBQU8sSUFBRzs7O3NCQW9JUSxLQUFHO0FBRW5CLGdCQUFJLEFBQUMsQ0FBQyxvQkFBbUIsQ0FBQyxDQUFDOzs7O0FBdkluQyxlQUFHLFFBQVEsQUFBQyxRQUVpQixDQUFDOzs7O2dEQXVJd0IsQ0FBQSxJQUFHLElBQUksQUFBQyxDQUFDLHFDQUFvQyxDQUFDO3lDQUNyRCxDQUFBLElBQUcsSUFBSSxBQUFDLENBQUMsOEJBQTZCLENBQUM7a0JBQzlELEdBQUM7b0JBRUMsQ0FBQSxDQUFBLE9BQU8sQUFBQyxDQUFDLG1DQUFrQyxDQUFDO0FBQzFELGdCQUFJLEFBQUMsRUFBQyw4QkFBOEIsRUFBQyxDQUFBLE9BQU0sT0FBTyxFQUFDLElBQUUsRUFBQyxDQUFDO0FBQ3ZELGVBQUcsUUFBUSxBQUFDLENBQUMsT0FBTSxDQUFHLFVBQVUsSUFBRyxDQUFHO0FBQ2xDLGtCQUFJLEFBQUMsRUFBQyx1QkFBdUIsRUFBQyxDQUFBLElBQUcsZUFBZSxFQUFHLENBQUM7QUFDcEQsa0JBQUksS0FBSyxBQUFDLENBQUMsUUFBTyxVQUFVLEFBQUMsQ0FBQyxJQUFHLEtBQUssQ0FBRyxLQUFHLENBQUMsQUFBQyxFQUFDLEtBQ3ZDLEFBQUMsQ0FBQyxTQUFTLEFBQUQsQ0FBRztBQUNiLG9CQUFJLEFBQUMsRUFBQyxjQUFjLEVBQUMsQ0FBQSxJQUFHLGVBQWUsRUFBQyxhQUFXLEVBQUMsQ0FBQztjQUN6RCxDQUFDLE1BQ0ksQUFBQyxDQUFDLFNBQVUsQ0FBQSxDQUFHO0FBQ2hCLG1CQUFJLENBQUEsS0FBSyxJQUFNLGFBQVcsQ0FBQSxFQUFLLENBQUEsQ0FBQSxRQUFRLElBQU0sZUFBYSxDQUFHO0FBQ3pELHNCQUFJLEFBQUMsRUFBQyxjQUFjLEVBQUMsQ0FBQSxJQUFHLGVBQWUsRUFBQyxvQkFBa0IsRUFBQyxDQUFDO0FBQzVELHlCQUFNO2dCQUNWO0FBQUEsQUFDQSxvQkFBSSxBQUFDLEVBQUMscUJBQXFCLEVBQUMsQ0FBQSxJQUFHLGVBQWUsRUFBQywyQkFBMEIsRUFBQyxDQUFBLENBQUEsTUFBTSxFQUFHLENBQUM7Y0FDeEYsQ0FBQyxDQUFDLENBQUM7WUFDWCxDQUFDLENBQUM7QUFFRixnQkFBSSxBQUFDLEVBQUMsb0JBQW9CLEVBQUMsQ0FBQSw0QkFBMkIsT0FBTyxFQUFDLElBQUUsRUFBQyxDQUFDO0FBQ2xFLGVBQUcsUUFBUSxBQUFDLENBQUMsNEJBQTJCLENBQUcsVUFBVSxDQUFBLENBQUcsQ0FBQSxHQUFFLENBQUc7QUFDekQsa0JBQUksS0FBSyxBQUFDLENBQUMsUUFBTyxVQUFVLEFBQUMsQ0FBQyxDQUFBLE1BQU0sQ0FBRyxFQUFBLENBQUMsQUFBQyxFQUFDLEtBQ2xDLEFBQUMsQ0FBQyxTQUFTLEFBQUQsQ0FBRztBQUNiLG9CQUFJLEFBQUMsRUFBQyxTQUFTLEVBQUMsSUFBRSxFQUFDLGFBQVcsRUFBQyxDQUFDO2NBQ3BDLENBQUMsTUFDSSxBQUFDLENBQUMsU0FBUyxDQUFBLENBQUc7QUFDZixvQkFBSSxBQUFDLEVBQUMsZ0JBQWdCLEVBQUMsSUFBRSxFQUFDLDBCQUF5QixFQUFDLENBQUEsQ0FBQSxNQUFNLEVBQUcsQ0FBQztjQUNsRSxDQUFDLENBQUMsQ0FBQztZQUNYLENBQUMsQ0FBQzs7Ozs7QUF2S2QsaUJBeUtrQixDQUFBLFFBQU8sSUFBSSxBQUFDLENBQUMsS0FBSSxDQUFDLENBektiOztBQUF2QixlQUFHLFdBQVcsQUFBQyxFQUFDLENBQUE7Ozs7QUFBaEIsZUFBRyxPQUFPLEFBQUMsRUFBQyxDQUFDOztBQUFiLGVBQUcsbUJBQW1CLEtBQW9CLENBQUE7OztBQUM1QixlQUFHLE9BQU8sQUFBQyxFQUFDLENBQUM7QUFDYixlQUFHLGlCQUFpQixBQUFDLEVBQUMsQ0FBQztBQUN2QixjQUFvQixDQUFBLElBQUcsZ0JBQWdCLENBQUM7Ozs7QUF5SzFDLG9CQUFRLEVBQUksRUFBQSxDQUFDOztBQTVLekIsZUFBRyxtQkFBbUIsS0FBb0IsQ0FBQTs7O0FBQTFDLGVBQUcsT0FBTyxBQUFDLEVBQUMsQ0FBQzs7OztBQStLRCxlQUFHLE9BQU8sQUFBQyxDQUFDLHFDQUFvQyxDQUFDLENBQUM7QUFDbEQsZUFBRyxPQUFPLEFBQUMsQ0FBQyw4QkFBNkIsQ0FBQyxDQUFDO0FBQzNDLGVBQUcsT0FBTyxBQUFDLENBQUMsZ0NBQStCLENBQUMsQ0FBQzt3QkFHM0IsQ0FBQSxJQUFHLElBQUksQUFBQyxDQUFDLGFBQVksQ0FBQztBQUN4QyxnQkFBSSxBQUFDLEVBQUMsVUFBVSxFQUFDLENBQUEsV0FBVSxPQUFPLEVBQUMsZ0JBQWMsRUFBQyxDQUFDO3VCQUNsQyxHQUFDO0FBQ2xCLGVBQUcsUUFBUSxBQUFDLENBQUMsQ0FBQSxPQUFPLEFBQUMsQ0FBQyxXQUFVLENBQUMsQ0FBRyxVQUFVLEVBQUMsQ0FBRztBQUM5QyxrQkFBSSxBQUFDLEVBQUMsV0FBVyxFQUFDLENBQUEsRUFBQyxhQUFhLEVBQUMsS0FBRyxFQUFDLENBQUM7QUFDdEMsdUJBQVMsS0FBSyxBQUFDLENBQUMsUUFBTyxVQUFVLEFBQUMsQ0FBQyxFQUFDLE1BQU0sQ0FBRyxHQUFDLENBQUMsQUFBQyxDQUFDLElBQUcsQ0FBQyxLQUM3QyxBQUFDLENBQUMsU0FBUyxBQUFELENBQUc7QUFDYixvQkFBSSxBQUFDLEVBQUMsTUFBTSxFQUFDLENBQUEsRUFBQyxhQUFhLEVBQUMsWUFBVSxFQUFDLENBQUM7Y0FDNUMsQ0FBQyxNQUNJLEFBQUMsQ0FBQyxTQUFTLENBQUEsQ0FBRztBQUNmLG9CQUFJLEFBQUMsRUFBQyxxQkFBcUIsRUFBQyxDQUFBLEVBQUMsYUFBYSxFQUFDLGtCQUFpQixFQUFDLENBQUEsQ0FBQSxNQUFNLEVBQUcsQ0FBQztjQUMzRSxDQUFDLENBQUMsQ0FBQztZQUNYLENBQUMsQ0FBQzs7OztBQWhNZCxlQUFHLFFBQVEsQUFBQyxVQUVpQixDQUFDOzs7OztBQUY5QixpQkFtTXNCLENBQUEsUUFBTyxJQUFJLEFBQUMsQ0FBQyxVQUFTLENBQUMsQ0FuTXRCOztBQUF2QixlQUFHLFdBQVcsQUFBQyxFQUFDLENBQUE7Ozs7QUFBaEIsZUFBRyxPQUFPLEFBQUMsRUFBQyxDQUFDOzs7O0FBQ0MsZUFBRyxPQUFPLEFBQUMsRUFBQyxDQUFDO0FBQ2IsZUFBRyxpQkFBaUIsQUFBQyxFQUFDLENBQUM7QUFDdkIsY0FBb0IsQ0FBQSxJQUFHLGdCQUFnQixDQUFDOzs7O0FBbU10QyxnQkFBSSxBQUFDLENBQUMsa0RBQWlELEVBQUksQ0FBQSxDQUFBLE1BQU0sQ0FBQyxDQUFDOzs7O0FBR3ZFLGVBQUksU0FBUSxDQUFHO0FBQ1gsa0JBQUksQUFBQyxDQUFDLDZEQUE0RCxDQUFDLENBQUM7QUFDcEUsd0JBQVUsS0FBSyxBQUFDLENBQUMsU0FBUSxDQUFDLENBQUM7WUFDL0IsS0FDSztBQUNELGtCQUFJLEFBQUMsQ0FBQyx3QkFBdUIsQ0FBQyxDQUFDO0FBQy9CLHdCQUFVLFNBQVMsQUFBQyxFQUFDLENBQUM7WUFDMUI7QUFBQTs7O0FBL01VLGVBQUcsTUFBTSxFQUFJLENBQUEsSUFBRyxtQkFBbUIsQ0FBQztBQUNwQyxpQkFBSzs7QUFGM0IsaUJBQU8sQ0FBQSxJQUFHLElBQUksQUFBQyxFQUFDLENBQUE7O0FBQ21CLElBQy9CLE9BQTZCLEtBQUcsQ0FBQyxDQUFDO0VBZ05sQyxDQWxObUQsQ0FrTmxELEFBQUMsRUFBQyxDQUFDO0FBQ1IsQ0FBQztBQUVELGFBQWEsMEJBQTBCLEVBQUksVUFBVSxLQUFJLENBQUcsQ0FBQSxVQUFTLENBQUc7QUFDcEUsQUFBSSxJQUFBLENBQUEsR0FBRSxFQUFJLENBQUEsS0FBSSxJQUFJLEFBQUMsQ0FBQyxxQ0FBb0MsQ0FBQyxDQUFDO0FBQzFELE1BQUksQUFBQyxFQUFDLHFCQUFxQixFQUFDLENBQUEsVUFBUyxlQUFlLEVBQUMsb0JBQWtCLEVBQUMsQ0FBQztBQUN6RSxJQUFFLENBQUUsVUFBUyxlQUFlLENBQUMsRUFBSSxXQUFTLENBQUM7QUFDM0MsTUFBSSxBQUFDLEVBQUMsc0JBQXNCLEVBQUMsQ0FBQSxDQUFBLEtBQUssQUFBQyxDQUFDLEdBQUUsQ0FBQyxPQUFPLEVBQUMsSUFBRSxFQUFDLENBQUM7QUFDdkQsQ0FBQztBQUVELGFBQWEscUJBQXFCLEVBQUksVUFBVSxLQUFJLENBQUcsQ0FBQSxNQUFLLENBQUc7QUFDM0QsQUFBSSxJQUFBLENBQUEsT0FBTSxFQUFJLENBQUEsS0FBSSxJQUFJLEFBQUMsQ0FBQyw4QkFBNkIsQ0FBQyxDQUFDO0FBQ3ZELE1BQUksQUFBQyxDQUFDLGlDQUFnQyxDQUFDLENBQUM7QUFDeEMsUUFBTSxLQUFLLEFBQUMsQ0FBQyxNQUFLLENBQUMsQ0FBQztBQUNwQixNQUFJLEFBQUMsRUFBQyxZQUFZLEVBQUMsQ0FBQSxPQUFNLE9BQU8sRUFBQyx1QkFBcUIsRUFBQyxDQUFDO0FBQzVELENBQUM7QUFFRCxhQUFhLHVCQUF1QixFQUFJLFVBQVUsS0FBSSxDQUFHLENBQUEsTUFBSyxDQUFHO0FBQzdELE1BQUksQUFBQyxDQUFDLDhCQUE2QixDQUFDLENBQUM7QUFDckMsTUFBSSxJQUFJLEFBQUMsQ0FBQyw4QkFBNkIsQ0FBRyxDQUFBLENBQUEsUUFBUSxBQUFDLENBQUMsS0FBSSxJQUFJLEFBQUMsQ0FBQyw4QkFBNkIsQ0FBQyxDQUFHLE9BQUssQ0FBQyxDQUFDLENBQUM7QUFDdkcsTUFBSSxBQUFDLEVBQUMsWUFBWSxFQUFDLENBQUEsS0FBSSxJQUFJLEFBQUMsQ0FBQyw4QkFBNkIsQ0FBQyxPQUFPLEVBQUMsdUJBQXFCLEVBQUMsQ0FBQztBQUM5RixDQUFDO0FBRUQsYUFBYSxzQkFBc0IsRUFBSSxVQUFVLEtBQUksQ0FBRyxDQUFBLEVBQUMsQ0FBRyxDQUFBLGNBQWEsQ0FBRztBQUN4RSxNQUFJLEFBQUMsRUFBQyxrQkFBa0IsRUFBQyxlQUFhLEVBQUMsb0JBQW1CLEVBQUMsQ0FBQSxFQUFDLGFBQWEsRUFBQyw2Q0FBMkMsRUFBQyxDQUFDO0FBQ3ZILEFBQUksSUFBQSxDQUFBLEtBQUksRUFBSSxDQUFBLEtBQUksSUFBSSxBQUFDLENBQUMsZ0NBQStCLENBQUMsQ0FBQztBQUN2RCxBQUFJLElBQUEsQ0FBQSxLQUFJLEVBQUksQ0FBQSxDQUFBLE1BQU0sQUFBQyxDQUFDLENBQUEsTUFBTSxBQUFDLENBQUMsS0FBSSxDQUFHLEVBQUUsRUFBQyxDQUFHLEdBQUMsQ0FBRSxDQUFDLENBQUMsQ0FBQztBQUMvQyxLQUFJLENBQUMsS0FBSSxDQUFHO0FBQ1IsQUFBSSxNQUFBLENBQUEsT0FBTSxFQUFJLEdBQUMsQ0FBQztBQUNoQixVQUFNLENBQUUsY0FBYSxDQUFDLEVBQUksS0FBRyxDQUFDO0FBQzlCLFFBQUksS0FBSyxBQUFDLENBQUM7QUFDUCxPQUFDLENBQUcsR0FBQztBQUNMLGdCQUFVLENBQUcsUUFBTTtBQUFBLElBQ3ZCLENBQUMsQ0FBQztBQUNGLFFBQUksQUFBQyxDQUFDLFlBQVcsQ0FBQyxDQUFDO0FBQ25CLFNBQU8sS0FBRyxDQUFDO0VBQ2Y7QUFBQSxBQUNBLEtBQUksQ0FBQyxLQUFJLFlBQVksQ0FBRSxjQUFhLENBQUMsQ0FBRztBQUNwQyxRQUFJLFlBQVksQ0FBRSxjQUFhLENBQUMsRUFBSSxLQUFHLENBQUM7QUFDeEMsUUFBSSxBQUFDLENBQUMsYUFBWSxDQUFDLENBQUM7QUFDcEIsU0FBTyxLQUFHLENBQUM7RUFDZjtBQUFBLEFBQ0EsTUFBSSxBQUFDLENBQUMsaUJBQWdCLENBQUMsQ0FBQztBQUN4QixPQUFPLE1BQUksQ0FBQztBQUNoQixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksZUFBYSxDQUFDO0FBQUEiLCJmaWxlIjoiYWN0aXZpdGllcy9tb25nb0RCQ29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XHJcblxyXG5sZXQgd2Y0bm9kZSA9IHJlcXVpcmUoXCIuLi8uLi8uLi9kZXBzL3dvcmtmbG93LTQtbm9kZVwiKTtcclxubGV0IEFjdGl2aXR5ID0gd2Y0bm9kZS5hY3Rpdml0aWVzLkFjdGl2aXR5O1xyXG5sZXQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG5sZXQgYWN0aXZpdHlNYXJrdXAgPSB3ZjRub2RlLmFjdGl2aXRpZXMuYWN0aXZpdHlNYXJrdXA7XHJcbmxldCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcclxubGV0IGZhc3QgPSByZXF1aXJlKFwiZmFzdC5qc1wiKTtcclxubGV0IEJsdWViaXJkID0gcmVxdWlyZShcImJsdWViaXJkXCIpO1xyXG5sZXQgTW9uZ29DbGllbnQgPSByZXF1aXJlKFwibW9uZ29kYlwiKS5Nb25nb0NsaWVudDtcclxubGV0IFN0ck1hcCA9IHJlcXVpcmUoXCJiYWNrcGFjay1ub2RlXCIpLmNvbGxlY3Rpb25zLlN0ck1hcDtcclxubGV0IGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpKFwibW9uZ28tY3J1bmNoOkNvbnRleHRcIik7XHJcblxyXG5mdW5jdGlvbiBNb25nb0RCQ29udGV4dCAoKSB7XHJcbiAgICBBY3Rpdml0eS5jYWxsKHRoaXMpO1xyXG5cclxuICAgIHRoaXMuY29ubmVjdGlvbnMgPSBudWxsO1xyXG4gICAgdGhpcy5ib2R5ID0gbnVsbDtcclxufVxyXG5cclxudXRpbC5pbmhlcml0cyhNb25nb0RCQ29udGV4dCwgQWN0aXZpdHkpO1xyXG5cclxuTW9uZ29EQkNvbnRleHQucHJvdG90eXBlLnJ1biA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCwgYXJncykge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzO1xyXG4gICAgbGV0IGJvZHkgPSBzZWxmLmdldChcImJvZHlcIik7XHJcbiAgICBsZXQgY29ubmVjdGlvbnMgPSBzZWxmLmdldChcImNvbm5lY3Rpb25zXCIpO1xyXG5cclxuICAgIGRlYnVnKGBSdW5uaW5nIGNvbm5lY3Rpb25zOiAke2Nvbm5lY3Rpb25zfS5gKTtcclxuXHJcbiAgICBpZiAoIWJvZHkpIHtcclxuICAgICAgICBkZWJ1ZyhcIlRoZXJlIGlzIG5vIGJvZHksIGNvbnRleHQgY29tcGxldGVkLlwiKTtcclxuXHJcbiAgICAgICAgY2FsbENvbnRleHQuY29tcGxldGUoKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdG9Db25uZWN0aW9uc0FycmF5IChjb25ucykge1xyXG5cclxuICAgICAgICBmdW5jdGlvbiB0b0Nvbm5lY3Rpb24gKGNvbm4pIHtcclxuICAgICAgICAgICAgaWYgKF8uaXNTdHJpbmcoY29ubikpIHtcclxuICAgICAgICAgICAgICAgIGNvbm4gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogXCJkZWZhdWx0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBjb25uLFxyXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG51bGxcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoXy5pc09iamVjdChjb25uKSkge1xyXG4gICAgICAgICAgICAgICAgY29ubiA9IHtcclxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBjb25uLm5hbWUgfHwgXCJkZWZhdWx0XCIsXHJcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBjb25uLnVybCxcclxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBjb25uLm9wdGlvbnNcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb25uZWN0aW9uIGlzIGludmFsaWQ6IFwiICsgSlNPTi5zdHJpbmdpZnkoY29ubikpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoXy5pc1N0cmluZyhjb25uLnVybCkgJiYgY29ubi51cmwpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjb25uO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvbm5lY3Rpb24gaXMgaW52YWxpZDogXCIgKyBKU09OLnN0cmluZ2lmeShjb25uKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgcmVzdWx0ID0gW107XHJcbiAgICAgICAgaWYgKF8uaXNBcnJheShjb25ucykpIHtcclxuICAgICAgICAgICAgZmFzdC5mb3JFYWNoKGNvbm5zLCBmdW5jdGlvbiAoYykge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godG9Db25uZWN0aW9uKGMpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaCh0b0Nvbm5lY3Rpb24oY29ubnMpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGRlYnVnKFwiUGFyc2luZyBjb25uZWN0aW9ucy5cIik7XHJcbiAgICAgICAgbGV0IGNvbm5zRGVmID0gdG9Db25uZWN0aW9uc0FycmF5KGNvbm5lY3Rpb25zKTtcclxuICAgICAgICBkZWJ1ZyhgVGhlcmUgaXMgJHtjb25uc0RlZi5sZW5ndGh9IGNvbm5lY3Rpb24ocykgaGFzIGJlZW4gZGVmaW5lZC5gKTtcclxuICAgICAgICBsZXQgcHJvY2Vzc2VkQ29ubnMgPSBuZXcgU3RyTWFwKCk7XHJcbiAgICAgICAgZmFzdC5mb3JFYWNoKGNvbm5zRGVmLCBmdW5jdGlvbiAoY29ubikge1xyXG4gICAgICAgICAgICBpZiAoIXByb2Nlc3NlZENvbm5zLmNvbnRhaW5zS2V5KGNvbm4ubmFtZSkpIHtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3NlZENvbm5zLmFkZChjb25uLm5hbWUsIGNvbm4pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRHVwbGljYXRlZCBjb25uZWN0aW9uIFxcXCJcIiArIGNvbm4ubmFtZSArIFwiXFxcIi5cIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgbGV0IHRhc2tzID0gW107XHJcbiAgICAgICAgcHJvY2Vzc2VkQ29ubnMuZm9yRWFjaFZhbHVlKGZ1bmN0aW9uIChjb25uKSB7XHJcbiAgICAgICAgICAgIGRlYnVnKGBDcmVhdGluZyBEYiBmb3IgY29ubmVjdGlvbiAke2Nvbm4udXJsfSwgb3B0aW9ucyAke2Nvbm4ub3B0aW9uc30uYCk7XHJcbiAgICAgICAgICAgIHRhc2tzLnB1c2goQmx1ZWJpcmQucHJvbWlzaWZ5KE1vbmdvQ2xpZW50LmNvbm5lY3QpKGNvbm4udXJsLCBjb25uLm9wdGlvbnMpLnRoZW4oZnVuY3Rpb24gKGRiKSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1ZyhcIkRiIGNyZWF0ZWQuXCIpO1xyXG4gICAgICAgICAgICAgICAgY29ubi5kYiA9IGRiO1xyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIEJsdWViaXJkLmFsbCh0YXNrcykudGhlbihcclxuICAgICAgICAgICAgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IG5ld0Nvbm5zID0ge307XHJcbiAgICAgICAgICAgICAgICBzZWxmLnNldChcImNvbm5lY3Rpb25zXCIsIG5ld0Nvbm5zKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuc2V0KFwiTW9uZ29EQkNvbnRleHRfQ29sbGVjdGlvblJlY3ljbGVCaW5cIiwge30pO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5zZXQoXCJNb25nb0RCQ29udGV4dF9PcGVuZWRDdXJzb3JzXCIsIFtdKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuc2V0KFwiTW9uZ29EQkNvbnRleHRfU2VlbkNvbGxlY3Rpb25zXCIsIFtdKTtcclxuICAgICAgICAgICAgICAgIHByb2Nlc3NlZENvbm5zLmZvckVhY2goZnVuY3Rpb24gKGt2cCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ld0Nvbm5zW2t2cC5rZXldID0ga3ZwLnZhbHVlLmRiO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgZGVidWcoXCJDb250ZXh0IGhhcyBiZWVuIGluaXRpYWxpemVkLCBzY2hlZHVsaW5nIGJvZHkuXCIpO1xyXG4gICAgICAgICAgICAgICAgY2FsbENvbnRleHQuc2NoZWR1bGUoYm9keSwgXCJfYm9keUNvbXBsZXRlZFwiKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgIGNhbGxDb250ZXh0LmZhaWwoZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgY2F0Y2ggKGUpIHtcclxuICAgICAgICBjYWxsQ29udGV4dC5mYWlsKGUpO1xyXG4gICAgfVxyXG59O1xyXG5cclxuTW9uZ29EQkNvbnRleHQucHJvdG90eXBlLl9ib2R5Q29tcGxldGVkID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCByZWFzb24sIHJlc3VsdCkge1xyXG4gICAgbGV0IHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIGRlYnVnKGBDb250ZXh0J3MgYm9keSBjb21wbGV0ZWQsIHJlYXNvbjogJHtyZWFzb259LmApO1xyXG5cclxuICAgIGlmIChyZWFzb24gIT09IEFjdGl2aXR5LnN0YXRlcy5jb21wbGV0ZSkge1xyXG4gICAgICAgIGRlYnVnKFwiUmVhc29uIGlzIG5vdCBjb21wbGV0ZSwgcmVzdW1pbmcgY2FsbCBjb250ZXh0LlwiKTtcclxuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBCbHVlYmlyZC5jb3JvdXRpbmUoZnVuY3Rpb24qICgpIHtcclxuICAgICAgICBsZXQgdGFza0Vycm9yID0gbnVsbDtcclxuXHJcbiAgICAgICAgZGVidWcoXCJEb2luZyBmaW5hbCB0YXNrcy5cIik7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgbGV0IE1vbmdvREJDb250ZXh0X0NvbGxlY3Rpb25SZWN5Y2xlQmluID0gc2VsZi5nZXQoXCJNb25nb0RCQ29udGV4dF9Db2xsZWN0aW9uUmVjeWNsZUJpblwiKTtcclxuICAgICAgICAgICAgbGV0IE1vbmdvREJDb250ZXh0X09wZW5lZEN1cnNvcnMgPSBzZWxmLmdldChcIk1vbmdvREJDb250ZXh0X09wZW5lZEN1cnNvcnNcIik7XHJcbiAgICAgICAgICAgIGxldCB0YXNrcyA9IFtdO1xyXG5cclxuICAgICAgICAgICAgbGV0IGJpblZhbHMgPSBfLnZhbHVlcyhNb25nb0RCQ29udGV4dF9Db2xsZWN0aW9uUmVjeWNsZUJpbik7XHJcbiAgICAgICAgICAgIGRlYnVnKGBDb2xsZWN0aW9ucyBpbiByZWN5Y2xlIGJpbjogJHtiaW5WYWxzLmxlbmd0aH0uYCk7XHJcbiAgICAgICAgICAgIGZhc3QuZm9yRWFjaChiaW5WYWxzLCBmdW5jdGlvbiAoY29sbCkge1xyXG4gICAgICAgICAgICAgICAgZGVidWcoYERyb3BwaW5nIGNvbGxlY3Rpb246ICR7Y29sbC5jb2xsZWN0aW9uTmFtZX1gKTtcclxuICAgICAgICAgICAgICAgIHRhc2tzLnB1c2goQmx1ZWJpcmQucHJvbWlzaWZ5KGNvbGwuZHJvcCwgY29sbCkoKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhgQ29sbGVjdGlvbiAnJHtjb2xsLmNvbGxlY3Rpb25OYW1lfScgZHJvcHBlZC5gKTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbiAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5uYW1lID09PSBcIk1vbmdvRXJyb3JcIiAmJiBlLm1lc3NhZ2UgPT09IFwibnMgbm90IGZvdW5kXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKGBDb2xsZWN0aW9uICcke2NvbGwuY29sbGVjdGlvbk5hbWV9JyBkb2Vzbid0IGV4aXN0cy5gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhgRVJST1I6IENvbGxlY3Rpb24gJyR7Y29sbC5jb2xsZWN0aW9uTmFtZX0nIGRyb3BwaW5nIGZhaWxlZCB3aXRoXFxuJHtlLnN0YWNrfWApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBkZWJ1ZyhgQ3Vyc29ycyB0byBjbG9zZTogJHtNb25nb0RCQ29udGV4dF9PcGVuZWRDdXJzb3JzLmxlbmd0aH0uYCk7XHJcbiAgICAgICAgICAgIGZhc3QuZm9yRWFjaChNb25nb0RCQ29udGV4dF9PcGVuZWRDdXJzb3JzLCBmdW5jdGlvbiAoYywgaWR4KSB7XHJcbiAgICAgICAgICAgICAgICB0YXNrcy5wdXNoKEJsdWViaXJkLnByb21pc2lmeShjLmNsb3NlLCBjKSgpXHJcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlYnVnKGBDdXJzb3IgJHtpZHh9LiBkcm9wcGVkLmApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoYEVSUk9SOiBDdXJzb3IgJHtpZHh9LiBjbG9zaW5nIGZhaWxlZCB3aXRoXFxuJHtlLnN0YWNrfWApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB5aWVsZCBCbHVlYmlyZC5hbGwodGFza3MpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICB0YXNrRXJyb3IgPSBlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmaW5hbGx5IHtcclxuICAgICAgICAgICAgc2VsZi5kZWxldGUoXCJNb25nb0RCQ29udGV4dF9Db2xsZWN0aW9uUmVjeWNsZUJpblwiKTtcclxuICAgICAgICAgICAgc2VsZi5kZWxldGUoXCJNb25nb0RCQ29udGV4dF9PcGVuZWRDdXJzb3JzXCIpO1xyXG4gICAgICAgICAgICBzZWxmLmRlbGV0ZShcIk1vbmdvREJDb250ZXh0X1NlZW5Db2xsZWN0aW9uc1wiKTtcclxuXHJcbiAgICAgICAgICAgIC8vIENsb3NlIGFsbCBkYnM6XHJcbiAgICAgICAgICAgIGxldCBjb25uZWN0aW9ucyA9IHNlbGYuZ2V0KFwiY29ubmVjdGlvbnNcIik7XHJcbiAgICAgICAgICAgIGRlYnVnKGBDbG9zaW5nICR7Y29ubmVjdGlvbnMubGVuZ3RofSBjb25uZWN0aW9ucy5gKTtcclxuICAgICAgICAgICAgbGV0IGNsb3NlVGFza3MgPSBbXTtcclxuICAgICAgICAgICAgZmFzdC5mb3JFYWNoKF8udmFsdWVzKGNvbm5lY3Rpb25zKSwgZnVuY3Rpb24gKGRiKSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1ZyhgQ2xvc2luZyAnJHtkYi5kYXRhYmFzZU5hbWV9Jy5gKTtcclxuICAgICAgICAgICAgICAgIGNsb3NlVGFza3MucHVzaChCbHVlYmlyZC5wcm9taXNpZnkoZGIuY2xvc2UsIGRiKSh0cnVlKVxyXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhgRGIgJyR7ZGIuZGF0YWJhc2VOYW1lfScgY2xvc2VkLmApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoYEVSUk9SOiBDbG9zaW5nIERiICcke2RiLmRhdGFiYXNlTmFtZX0nIGZhaWxlZCB3aXRoXFxuJHtlLnN0YWNrfWApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgeWllbGQgQmx1ZWJpcmQuYWxsKGNsb3NlVGFza3MpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1ZyhcIkVSUk9SOiBDYW5ub3QgY2xvc2UgTW9uZ29EQiBjb25uZWN0aW9ucywgZXJyb3JcXG5cIiArIGUuc3RhY2spO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGFza0Vycm9yKSB7XHJcbiAgICAgICAgICAgICAgICBkZWJ1ZyhcIkVSUk9SOiBmaW5hbCB0YXNrcyBmYWlsZWQuIFJlcG9ydGluZyBlcnJvciB0byBjYWxsIGNvbnRleHQuXCIpO1xyXG4gICAgICAgICAgICAgICAgY2FsbENvbnRleHQuZmFpbCh0YXNrRXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZGVidWcoXCJGaW5hbCB0YXNrcyBjb21wbGV0ZWQuXCIpO1xyXG4gICAgICAgICAgICAgICAgY2FsbENvbnRleHQuY29tcGxldGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0pKCk7XHJcbn07XHJcblxyXG5Nb25nb0RCQ29udGV4dC5hZGRDb2xsZWN0aW9uVG9SZWN5Y2xlQmluID0gZnVuY3Rpb24gKHNjb3BlLCBjb2xsZWN0aW9uKSB7XHJcbiAgICBsZXQgYmluID0gc2NvcGUuZ2V0KFwiTW9uZ29EQkNvbnRleHRfQ29sbGVjdGlvblJlY3ljbGVCaW5cIik7XHJcbiAgICBkZWJ1ZyhgQWRkaW5nIGNvbGxlY3Rpb24gJyR7Y29sbGVjdGlvbi5jb2xsZWN0aW9uTmFtZX0nIHRvIHJlY3ljbGUgYmluLmApO1xyXG4gICAgYmluW2NvbGxlY3Rpb24uY29sbGVjdGlvbk5hbWVdID0gY29sbGVjdGlvbjtcclxuICAgIGRlYnVnKGBSZWN5Y2xlIGJpbiBzaXplIGlzICR7Xy5rZXlzKGJpbikubGVuZ3RofS5gKTtcclxufTtcclxuXHJcbk1vbmdvREJDb250ZXh0LnJlZ2lzdGVyT3BlbmVkQ3Vyc29yID0gZnVuY3Rpb24gKHNjb3BlLCBjdXJzb3IpIHtcclxuICAgIGxldCBjdXJzb3JzID0gc2NvcGUuZ2V0KFwiTW9uZ29EQkNvbnRleHRfT3BlbmVkQ3Vyc29yc1wiKTtcclxuICAgIGRlYnVnKGBSZWdpc3RlcmluZyBhIGN1cnNvciBhcyBvcGVuZWQuYCk7XHJcbiAgICBjdXJzb3JzLnB1c2goY3Vyc29yKTtcclxuICAgIGRlYnVnKGBUaGVyZSBhcmUgJHtjdXJzb3JzLmxlbmd0aH0gY3Vyc29ycyByZWdpc3RlcmVkLmApO1xyXG59O1xyXG5cclxuTW9uZ29EQkNvbnRleHQudW5yZWdpc3Rlck9wZW5lZEN1cnNvciA9IGZ1bmN0aW9uIChzY29wZSwgY3Vyc29yKSB7XHJcbiAgICBkZWJ1ZyhgVW5yZWdpc3RlcmluZyBvcGVuZWQgY3Vyc29yLmApO1xyXG4gICAgc2NvcGUuc2V0KFwiTW9uZ29EQkNvbnRleHRfT3BlbmVkQ3Vyc29yc1wiLCBfLndpdGhvdXQoc2NvcGUuZ2V0KFwiTW9uZ29EQkNvbnRleHRfT3BlbmVkQ3Vyc29yc1wiKSwgY3Vyc29yKSk7XHJcbiAgICBkZWJ1ZyhgVGhlcmUgYXJlICR7c2NvcGUuZ2V0KFwiTW9uZ29EQkNvbnRleHRfT3BlbmVkQ3Vyc29yc1wiKS5sZW5ndGh9IGN1cnNvcnMgcmVnaXN0ZXJlZC5gKTtcclxufTtcclxuXHJcbk1vbmdvREJDb250ZXh0LmlzRmlyc3RTZWVuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uIChzY29wZSwgZGIsIGNvbGxlY3Rpb25OYW1lKSB7XHJcbiAgICBkZWJ1ZyhgRGV0ZXJtaW5pbmcgaWYgJyR7Y29sbGVjdGlvbk5hbWV9JyBjb2xsZWN0aW9uIGluICcke2RiLmRhdGFiYXNlTmFtZX0nIGRiIGlzIGZpcnN0IHNlZW4gYnkgdGhlIGN1cnJlbnQgY29udGV4dC5gKTtcclxuICAgIGxldCBjb2xscyA9IHNjb3BlLmdldChcIk1vbmdvREJDb250ZXh0X1NlZW5Db2xsZWN0aW9uc1wiKTtcclxuICAgIGxldCBlbnRyeSA9IF8uZmlyc3QoXy53aGVyZShjb2xscywgeyBkYjogZGIgfSkpO1xyXG4gICAgaWYgKCFlbnRyeSkge1xyXG4gICAgICAgIGxldCBjb2xsUmVnID0ge307XHJcbiAgICAgICAgY29sbFJlZ1tjb2xsZWN0aW9uTmFtZV0gPSB0cnVlO1xyXG4gICAgICAgIGNvbGxzLnB1c2goe1xyXG4gICAgICAgICAgICBkYjogZGIsXHJcbiAgICAgICAgICAgIGNvbGxlY3Rpb25zOiBjb2xsUmVnXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgZGVidWcoXCJGaXN0IHNlZW4uXCIpO1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgaWYgKCFlbnRyeS5jb2xsZWN0aW9uc1tjb2xsZWN0aW9uTmFtZV0pIHtcclxuICAgICAgICBlbnRyeS5jb2xsZWN0aW9uc1tjb2xsZWN0aW9uTmFtZV0gPSB0cnVlO1xyXG4gICAgICAgIGRlYnVnKFwiRmlyc3Qgc2Vlbi5cIik7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICBkZWJ1ZyhcIk5vdCBmaXJzdCBzZWVuLlwiKTtcclxuICAgIHJldHVybiBmYWxzZTtcclxufTtcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gTW9uZ29EQkNvbnRleHQ7Il19
