"use strict";
var wf4node = require("workflow-4-node");
var util = require("util");
var Activity = wf4node.activities.Activity;
var Bluebird = require("bluebird");
var UnitOfWork = require("./unitOfWork");
var _ = require("lodash");
var Connected = require("./connected");
var debug = require("debug")("mongo-crunch:CollectionRef");
var async = Bluebird.coroutine;
require("date-utils");
function CollectionRef() {
  Connected.call(this);
  this.name = null;
  this.mustExists = true;
  this.deleteOnExit = false;
  this.clearBeforeUse = false;
  this.options = null;
  this.indexes = null;
  this.ttl = null;
  this.nonScopedProperties.add("_generateName");
}
util.inherits(CollectionRef, Connected);
CollectionRef.prototype._generateName = function(name, ttl) {
  if (ttl && ttl > 0) {
    var to = new Date();
    to.addMinutes(ttl);
    name += "@" + to.toUTCFormat("YYYYMMDDHHMISS");
  }
  return name;
};
CollectionRef.prototype.doWork = function(callContext) {
  callContext.schedule([this.name, this.mustExists, this.deleteOnExit, this.clearBeforeUse, this.options, this.indexes, this.ttl], "_varsGot");
};
CollectionRef.prototype._varsGot = function(callContext, reason, result) {
  if (reason !== Activity.states.complete) {
    callContext.end(reason, result);
    return;
  }
  var self = this;
  var ttl = result[6];
  var name = callContext.activity._generateName(result[0], ttl);
  var mustExists = result[1];
  var deleteOnExit = result[2];
  var clearBeforeUse = result[3];
  var options = result[4];
  var indexes = result[5];
  debug((name + " running, mustExists: " + mustExists + ", deleteOnExit: " + deleteOnExit + ", clearBeforeUse: " + clearBeforeUse));
  debug(("options: " + util.inspect(options)));
  debug(("indexes: " + util.inspect(indexes)));
  if (!_.isString(name) || !name) {
    callContext.fail(new Error("Activity argument \"name\" is null or empty."));
    return;
  }
  function getIndexes() {
    function toIndex(idx) {
      var idxName = idx.name;
      var fieldOrSpec = idx.fieldOrSpec;
      var idxOptions = idx.options || {w: "majority"};
      if (!_.isString(idxName) || !fieldOrSpec) {
        throw new Error("Invalid index specification: " + JSON.stringify(idx));
      }
      return {
        name: idxName,
        fieldOrSpec: fieldOrSpec,
        options: idxOptions
      };
    }
    var r = [];
    if (_.isArray(indexes)) {
      var $__4 = true;
      var $__5 = false;
      var $__6 = undefined;
      try {
        for (var $__2 = void 0,
            $__1 = (indexes)[Symbol.iterator](); !($__4 = ($__2 = $__1.next()).done); $__4 = true) {
          var idx = $__2.value;
          {
            r.push(toIndex(idx));
          }
        }
      } catch ($__7) {
        $__5 = true;
        $__6 = $__7;
      } finally {
        try {
          if (!$__4 && $__1.return != null) {
            $__1.return();
          }
        } finally {
          if ($__5) {
            throw $__6;
          }
        }
      }
    } else if (_.isPlainObject(indexes)) {
      r.push(toIndex(indexes));
    }
    return r;
  }
  async($traceurRuntime.initGeneratorFunction(function $__8() {
    var db,
        firstSeen,
        dropped,
        opts,
        coll,
        indexDefs,
        i,
        indexDef,
        e;
    return $traceurRuntime.createGeneratorInstance(function($ctx) {
      while (true)
        switch ($ctx.state) {
          case 0:
            $ctx.pushTry(55, null);
            $ctx.state = 58;
            break;
          case 58:
            db = callContext.activity.getDb(self);
            firstSeen = UnitOfWork.isFirstSeenCollection(self, db, name);
            dropped = false;
            $ctx.state = 50;
            break;
          case 50:
            $ctx.state = (deleteOnExit && firstSeen && !mustExists) ? 16 : 19;
            break;
          case 16:
            debug(("'" + name + "' is a temporary collection that must dropped on exit. Dropping."));
            $ctx.state = 17;
            break;
          case 17:
            $ctx.pushTry(7, null);
            $ctx.state = 10;
            break;
          case 10:
            $ctx.state = 2;
            return db.dropCollection(name);
          case 2:
            $ctx.maybeThrow();
            $ctx.state = 4;
            break;
          case 4:
            debug(("'" + name + "' dropped"));
            $ctx.state = 6;
            break;
          case 6:
            $ctx.popTry();
            $ctx.state = 12;
            break;
          case 7:
            $ctx.popTry();
            $ctx.maybeUncatchable();
            e = $ctx.storedException;
            $ctx.state = 13;
            break;
          case 13:
            if (!((e.name === "MongoError" && e.message === "ns not found"))) {
              throw e;
            }
            debug(("'" + name + "' doesn't exists when referenced first."));
            $ctx.state = 12;
            break;
          case 12:
            dropped = true;
            $ctx.state = 19;
            break;
          case 19:
            opts = _.isObject(options) ? _.clone(options) : {w: "majority"};
            if (mustExists) {
              debug("Adding strict option.");
              opts.strict = true;
            }
            debug(("Getting '" + name + "' collection's reference from Db."));
            $ctx.state = 52;
            break;
          case 52:
            $ctx.state = 22;
            return Bluebird.promisify(db.collection, {context: db})(name, opts);
          case 22:
            coll = $ctx.sent;
            $ctx.state = 24;
            break;
          case 24:
            $ctx.state = (firstSeen) ? 37 : 40;
            break;
          case 37:
            indexDefs = getIndexes();
            $ctx.state = 38;
            break;
          case 38:
            $ctx.state = (indexDefs.length) ? 34 : 31;
            break;
          case 34:
            debug(("Ensuring " + indexDefs.length + " indexes."));
            $ctx.state = 35;
            break;
          case 35:
            i = 0;
            $ctx.state = 33;
            break;
          case 33:
            $ctx.state = (i < indexDefs.length) ? 29 : 31;
            break;
          case 28:
            i++;
            $ctx.state = 33;
            break;
          case 29:
            indexDef = indexDefs[i];
            debug(("Ensuring index " + util.inspect(indexDef)));
            $ctx.state = 30;
            break;
          case 30:
            $ctx.state = 26;
            return coll.ensureIndex(indexDef.name, indexDef.fieldOrSpec, indexDef.options);
          case 26:
            $ctx.maybeThrow();
            $ctx.state = 28;
            break;
          case 31:
            if (deleteOnExit) {
              UnitOfWork.addCollectionToRecycleBin(self, coll);
            }
            $ctx.state = 40;
            break;
          case 40:
            $ctx.state = (clearBeforeUse && !dropped) ? 46 : 45;
            break;
          case 46:
            debug(("Calling 'deleteMany' in collection '" + name + "' because 'clearBeforeUse' option is set."));
            $ctx.state = 47;
            break;
          case 47:
            $ctx.state = 43;
            return coll.deleteMany({}, {w: "majority"});
          case 43:
            $ctx.maybeThrow();
            $ctx.state = 45;
            break;
          case 45:
            debug(("CollectionRef '" + name + "' run completed."));
            callContext.complete(coll);
            $ctx.state = 54;
            break;
          case 54:
            $ctx.popTry();
            $ctx.state = -2;
            break;
          case 55:
            $ctx.popTry();
            $ctx.maybeUncatchable();
            e = $ctx.storedException;
            $ctx.state = 61;
            break;
          case 61:
            callContext.fail(e);
            $ctx.state = -2;
            break;
          default:
            return $ctx.end();
        }
    }, $__8, this);
  }))();
};
module.exports = CollectionRef;
//# sourceMappingURL=data:application/json;base64,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QXVKSSxnQkFBSSxBQUFDLEVBQUMsc0NBQXNDLEVBQUMsS0FBRyxFQUFDLDRDQUEwQyxFQUFDLENBQUM7Ozs7O2lCQUN2RixDQUFBLElBQUcsV0FBVyxBQUFDLENBQUMsRUFBQyxDQUFHLEVBQUUsQ0FBQSxDQUFHLFdBQVMsQ0FBRSxDQUFDOztBQXpKM0QsZUFBRyxXQUFXLEFBQUMsRUFBQyxDQUFBOzs7O0FBNEpKLGdCQUFJLEFBQUMsRUFBQyxpQkFBaUIsRUFBQyxLQUFHLEVBQUMsbUJBQWlCLEVBQUMsQ0FBQztBQUMvQyxzQkFBVSxTQUFTLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQzs7OztBQTdKdEMsZUFBRyxPQUFPLEFBQUMsRUFBQyxDQUFDOzs7O0FBQ0MsZUFBRyxPQUFPLEFBQUMsRUFBQyxDQUFDO0FBQ2IsZUFBRyxpQkFBaUIsQUFBQyxFQUFDLENBQUM7QUFDdkIsY0FBb0IsQ0FBQSxJQUFHLGdCQUFnQixDQUFDOzs7O0FBNkoxQyxzQkFBVSxLQUFLLEFBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQzs7OztBQWhLL0IsaUJBQU8sQ0FBQSxJQUFHLElBQUksQUFBQyxFQUFDLENBQUE7O0FBQ21CLElBQy9CLE9BQTZCLEtBQUcsQ0FBQyxDQUFDO0VBZ0tsQyxDQWxLbUQsQ0FrS2xELEFBQUMsRUFBQyxDQUFDO0FBQ1IsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLGNBQVksQ0FBQztBQUM5QiIsImZpbGUiOiJhY3Rpdml0aWVzL2NvbGxlY3Rpb25SZWYuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxubGV0IHdmNG5vZGUgPSByZXF1aXJlKFwid29ya2Zsb3ctNC1ub2RlXCIpO1xyXG5sZXQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG5sZXQgQWN0aXZpdHkgPSB3ZjRub2RlLmFjdGl2aXRpZXMuQWN0aXZpdHk7XHJcbmxldCBCbHVlYmlyZCA9IHJlcXVpcmUoXCJibHVlYmlyZFwiKTtcclxubGV0IFVuaXRPZldvcmsgPSByZXF1aXJlKFwiLi91bml0T2ZXb3JrXCIpO1xyXG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XHJcbmxldCBDb25uZWN0ZWQgPSByZXF1aXJlKFwiLi9jb25uZWN0ZWRcIik7XHJcbmxldCBkZWJ1ZyA9IHJlcXVpcmUoXCJkZWJ1Z1wiKShcIm1vbmdvLWNydW5jaDpDb2xsZWN0aW9uUmVmXCIpO1xyXG5sZXQgYXN5bmMgPSBCbHVlYmlyZC5jb3JvdXRpbmU7XHJcbnJlcXVpcmUoXCJkYXRlLXV0aWxzXCIpO1xyXG5cclxuZnVuY3Rpb24gQ29sbGVjdGlvblJlZigpIHtcclxuICAgIENvbm5lY3RlZC5jYWxsKHRoaXMpO1xyXG5cclxuICAgIHRoaXMubmFtZSA9IG51bGw7XHJcbiAgICB0aGlzLm11c3RFeGlzdHMgPSB0cnVlO1xyXG4gICAgdGhpcy5kZWxldGVPbkV4aXQgPSBmYWxzZTtcclxuICAgIHRoaXMuY2xlYXJCZWZvcmVVc2UgPSBmYWxzZTtcclxuICAgIHRoaXMub3B0aW9ucyA9IG51bGw7XHJcbiAgICB0aGlzLmluZGV4ZXMgPSBudWxsO1xyXG4gICAgdGhpcy50dGwgPSBudWxsO1xyXG5cclxuICAgIHRoaXMubm9uU2NvcGVkUHJvcGVydGllcy5hZGQoXCJfZ2VuZXJhdGVOYW1lXCIpO1xyXG59XHJcblxyXG51dGlsLmluaGVyaXRzKENvbGxlY3Rpb25SZWYsIENvbm5lY3RlZCk7XHJcblxyXG5Db2xsZWN0aW9uUmVmLnByb3RvdHlwZS5fZ2VuZXJhdGVOYW1lID0gZnVuY3Rpb24obmFtZSwgdHRsKSB7XHJcbiAgICBpZiAodHRsICYmIHR0bCA+IDApIHtcclxuICAgICAgICBsZXQgdG8gPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIHRvLmFkZE1pbnV0ZXModHRsKTtcclxuICAgICAgICBuYW1lICs9IFwiQFwiICsgdG8udG9VVENGb3JtYXQoXCJZWVlZTU1EREhITUlTU1wiKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuYW1lO1xyXG59O1xyXG5cclxuQ29sbGVjdGlvblJlZi5wcm90b3R5cGUuZG9Xb3JrID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0KSB7XHJcbiAgICBjYWxsQ29udGV4dC5zY2hlZHVsZShcclxuICAgICAgICBbXHJcbiAgICAgICAgICAgIHRoaXMubmFtZSxcclxuICAgICAgICAgICAgdGhpcy5tdXN0RXhpc3RzLFxyXG4gICAgICAgICAgICB0aGlzLmRlbGV0ZU9uRXhpdCxcclxuICAgICAgICAgICAgdGhpcy5jbGVhckJlZm9yZVVzZSxcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLFxyXG4gICAgICAgICAgICB0aGlzLmluZGV4ZXMsXHJcbiAgICAgICAgICAgIHRoaXMudHRsXHJcbiAgICAgICAgXSxcclxuICAgICAgICBcIl92YXJzR290XCIpO1xyXG59O1xyXG5cclxuQ29sbGVjdGlvblJlZi5wcm90b3R5cGUuX3ZhcnNHb3QgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICBpZiAocmVhc29uICE9PSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUpIHtcclxuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgc2VsZiA9IHRoaXM7XHJcbiAgICBsZXQgdHRsID0gcmVzdWx0WzZdO1xyXG4gICAgbGV0IG5hbWUgPSBjYWxsQ29udGV4dC5hY3Rpdml0eS5fZ2VuZXJhdGVOYW1lKHJlc3VsdFswXSwgdHRsKTtcclxuICAgIGxldCBtdXN0RXhpc3RzID0gcmVzdWx0WzFdO1xyXG4gICAgbGV0IGRlbGV0ZU9uRXhpdCA9IHJlc3VsdFsyXTtcclxuICAgIGxldCBjbGVhckJlZm9yZVVzZSA9IHJlc3VsdFszXTtcclxuICAgIGxldCBvcHRpb25zID0gcmVzdWx0WzRdO1xyXG4gICAgbGV0IGluZGV4ZXMgPSByZXN1bHRbNV07XHJcblxyXG4gICAgZGVidWcoYCR7bmFtZX0gcnVubmluZywgbXVzdEV4aXN0czogJHttdXN0RXhpc3RzfSwgZGVsZXRlT25FeGl0OiAke2RlbGV0ZU9uRXhpdH0sIGNsZWFyQmVmb3JlVXNlOiAke2NsZWFyQmVmb3JlVXNlfWApO1xyXG4gICAgZGVidWcoYG9wdGlvbnM6ICR7dXRpbC5pbnNwZWN0KG9wdGlvbnMpfWApO1xyXG4gICAgZGVidWcoYGluZGV4ZXM6ICR7dXRpbC5pbnNwZWN0KGluZGV4ZXMpfWApO1xyXG5cclxuICAgIGlmICghXy5pc1N0cmluZyhuYW1lKSB8fCAhbmFtZSkge1xyXG4gICAgICAgIGNhbGxDb250ZXh0LmZhaWwobmV3IEVycm9yKFwiQWN0aXZpdHkgYXJndW1lbnQgXFxcIm5hbWVcXFwiIGlzIG51bGwgb3IgZW1wdHkuXCIpKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0SW5kZXhlcygpIHtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gdG9JbmRleChpZHgpIHtcclxuICAgICAgICAgICAgbGV0IGlkeE5hbWUgPSBpZHgubmFtZTtcclxuICAgICAgICAgICAgbGV0IGZpZWxkT3JTcGVjID0gaWR4LmZpZWxkT3JTcGVjO1xyXG4gICAgICAgICAgICBsZXQgaWR4T3B0aW9ucyA9IGlkeC5vcHRpb25zIHx8IHsgdzogXCJtYWpvcml0eVwiIH07XHJcbiAgICAgICAgICAgIGlmICghXy5pc1N0cmluZyhpZHhOYW1lKSB8fCAhZmllbGRPclNwZWMpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgaW5kZXggc3BlY2lmaWNhdGlvbjogXCIgKyBKU09OLnN0cmluZ2lmeShpZHgpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgbmFtZTogaWR4TmFtZSxcclxuICAgICAgICAgICAgICAgIGZpZWxkT3JTcGVjOiBmaWVsZE9yU3BlYyxcclxuICAgICAgICAgICAgICAgIG9wdGlvbnM6IGlkeE9wdGlvbnNcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCByID0gW107XHJcbiAgICAgICAgaWYgKF8uaXNBcnJheShpbmRleGVzKSkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpZHggb2YgaW5kZXhlcykge1xyXG4gICAgICAgICAgICAgICAgci5wdXNoKHRvSW5kZXgoaWR4KSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KGluZGV4ZXMpKSB7XHJcbiAgICAgICAgICAgIHIucHVzaCh0b0luZGV4KGluZGV4ZXMpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jKGZ1bmN0aW9uKiAoKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgbGV0IGRiID0gY2FsbENvbnRleHQuYWN0aXZpdHkuZ2V0RGIoc2VsZik7XHJcblxyXG4gICAgICAgICAgICBsZXQgZmlyc3RTZWVuID0gVW5pdE9mV29yay5pc0ZpcnN0U2VlbkNvbGxlY3Rpb24oc2VsZiwgZGIsIG5hbWUpO1xyXG5cclxuICAgICAgICAgICAgbGV0IGRyb3BwZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgaWYgKGRlbGV0ZU9uRXhpdCAmJiBmaXJzdFNlZW4gJiYgIW11c3RFeGlzdHMpIHtcclxuICAgICAgICAgICAgICAgIGRlYnVnKGAnJHtuYW1lfScgaXMgYSB0ZW1wb3JhcnkgY29sbGVjdGlvbiB0aGF0IG11c3QgZHJvcHBlZCBvbiBleGl0LiBEcm9wcGluZy5gKTtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgZGIuZHJvcENvbGxlY3Rpb24obmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVidWcoYCcke25hbWV9JyBkcm9wcGVkYCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghKChlLm5hbWUgPT09IFwiTW9uZ29FcnJvclwiICYmIGUubWVzc2FnZSA9PT0gXCJucyBub3QgZm91bmRcIikpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGRlYnVnKGAnJHtuYW1lfScgZG9lc24ndCBleGlzdHMgd2hlbiByZWZlcmVuY2VkIGZpcnN0LmApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZHJvcHBlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBvcHRzID0gXy5pc09iamVjdChvcHRpb25zKSA/IF8uY2xvbmUob3B0aW9ucykgOiB7IHc6IFwibWFqb3JpdHlcIiB9O1xyXG4gICAgICAgICAgICBpZiAobXVzdEV4aXN0cykge1xyXG4gICAgICAgICAgICAgICAgZGVidWcoXCJBZGRpbmcgc3RyaWN0IG9wdGlvbi5cIik7XHJcbiAgICAgICAgICAgICAgICBvcHRzLnN0cmljdCA9IHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGVidWcoYEdldHRpbmcgJyR7bmFtZX0nIGNvbGxlY3Rpb24ncyByZWZlcmVuY2UgZnJvbSBEYi5gKTtcclxuICAgICAgICAgICAgbGV0IGNvbGwgPSB5aWVsZCBCbHVlYmlyZC5wcm9taXNpZnkoZGIuY29sbGVjdGlvbiwge2NvbnRleHQ6IGRifSkobmFtZSwgb3B0cyk7XHJcblxyXG4gICAgICAgICAgICBpZiAoZmlyc3RTZWVuKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgaW5kZXhEZWZzID0gZ2V0SW5kZXhlcygpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGluZGV4RGVmcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhgRW5zdXJpbmcgJHtpbmRleERlZnMubGVuZ3RofSBpbmRleGVzLmApO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhEZWZzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbmRleERlZiA9IGluZGV4RGVmc1tpXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVidWcoYEVuc3VyaW5nIGluZGV4ICR7dXRpbC5pbnNwZWN0KGluZGV4RGVmKX1gKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgY29sbC5lbnN1cmVJbmRleChpbmRleERlZi5uYW1lLCBpbmRleERlZi5maWVsZE9yU3BlYywgaW5kZXhEZWYub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChkZWxldGVPbkV4aXQpIHtcclxuICAgICAgICAgICAgICAgICAgICBVbml0T2ZXb3JrLmFkZENvbGxlY3Rpb25Ub1JlY3ljbGVCaW4oc2VsZiwgY29sbCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChjbGVhckJlZm9yZVVzZSAmJiAhZHJvcHBlZCkge1xyXG4gICAgICAgICAgICAgICAgZGVidWcoYENhbGxpbmcgJ2RlbGV0ZU1hbnknIGluIGNvbGxlY3Rpb24gJyR7bmFtZX0nIGJlY2F1c2UgJ2NsZWFyQmVmb3JlVXNlJyBvcHRpb24gaXMgc2V0LmApO1xyXG4gICAgICAgICAgICAgICAgeWllbGQgY29sbC5kZWxldGVNYW55KHt9LCB7IHc6IFwibWFqb3JpdHlcIiB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZGVidWcoYENvbGxlY3Rpb25SZWYgJyR7bmFtZX0nIHJ1biBjb21wbGV0ZWQuYCk7XHJcbiAgICAgICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKGNvbGwpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBjYWxsQ29udGV4dC5mYWlsKGUpO1xyXG4gICAgICAgIH1cclxuICAgIH0pKCk7XHJcbn07XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IENvbGxlY3Rpb25SZWY7XHJcbiJdfQ==
