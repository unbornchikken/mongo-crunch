"use strict";
"use strict";
var wf4node = require("workflow-4-node");
var util = require("util");
var Activity = wf4node.activities.Activity;
var Bluebird = require("bluebird");
var UnitOfWork = require("./unitOfWork");
var _ = require("lodash");
var Connected = require("./connected");
var debug = require("debug")("mongo-crunch:CollectionRef");
var async = Bluebird.coroutine;
require("date-utils");
function CollectionRef() {
  Connected.call(this);
  this.name = null;
  this.mustExists = true;
  this.deleteOnExit = false;
  this.clearBeforeUse = false;
  this.options = null;
  this.indexes = null;
  this.ttl = null;
  this.nonScopedProperties.add("_generateName");
}
util.inherits(CollectionRef, Connected);
CollectionRef.prototype._generateName = function(name, ttl) {
  if (ttl && ttl > 0) {
    var to = new Date();
    to.addMinutes(ttl);
    name += "@" + to.toUTCFormat("YYYYMMDDHHMISS");
  }
  return name;
};
CollectionRef.prototype.doWork = function(callContext) {
  callContext.schedule([this.name, this.mustExists, this.deleteOnExit, this.clearBeforeUse, this.options, this.indexes, this.ttl], "_varsGot");
};
CollectionRef.prototype._varsGot = function(callContext, reason, result) {
  if (reason !== Activity.states.complete) {
    callContext.end(reason, result);
    return;
  }
  var self = this;
  var ttl = result[6];
  var name = callContext.activity._generateName(result[0], ttl);
  var mustExists = result[1];
  var deleteOnExit = result[2];
  var clearBeforeUse = result[3];
  var options = result[4];
  var indexes = result[5];
  debug((name + " running, mustExists: " + mustExists + ", deleteOnExit: " + deleteOnExit + ", clearBeforeUse: " + clearBeforeUse));
  debug(("options: " + util.inspect(options)));
  debug(("indexes: " + util.inspect(indexes)));
  if (!_.isString(name) || !name) {
    callContext.fail(new Error("Activity argument \"name\" is null or empty."));
    return;
  }
  function getIndexes() {
    function toIndex(idx) {
      var idxName = idx.name;
      var fieldOrSpec = idx.fieldOrSpec;
      var idxOptions = idx.options || {w: "majority"};
      if (!_.isString(idxName) || !fieldOrSpec) {
        throw new Error("Invalid index specification: " + JSON.stringify(idx));
      }
      return {
        name: idxName,
        fieldOrSpec: fieldOrSpec,
        options: idxOptions
      };
    }
    var r = [];
    if (_.isArray(indexes)) {
      var $__3 = true;
      var $__4 = false;
      var $__5 = undefined;
      try {
        for (var $__1 = void 0,
            $__0 = (indexes)[$traceurRuntime.toProperty(Symbol.iterator)](); !($__3 = ($__1 = $__0.next()).done); $__3 = true) {
          var idx = $__1.value;
          {
            r.push(toIndex(idx));
          }
        }
      } catch ($__6) {
        $__4 = true;
        $__5 = $__6;
      } finally {
        try {
          if (!$__3 && $__0.return != null) {
            $__0.return();
          }
        } finally {
          if ($__4) {
            throw $__5;
          }
        }
      }
    } else if (_.isPlainObject(indexes)) {
      r.push(toIndex(indexes));
    }
    return r;
  }
  async($traceurRuntime.initGeneratorFunction(function $__7() {
    var db,
        firstSeen,
        dropped,
        opts,
        coll,
        indexDefs,
        i,
        indexDef,
        e;
    return $traceurRuntime.createGeneratorInstance(function($ctx) {
      while (true)
        switch ($ctx.state) {
          case 0:
            $ctx.pushTry(55, null);
            $ctx.state = 58;
            break;
          case 58:
            db = callContext.activity.getDb(self);
            firstSeen = UnitOfWork.isFirstSeenCollection(self, db, name);
            dropped = false;
            $ctx.state = 50;
            break;
          case 50:
            $ctx.state = (deleteOnExit && firstSeen && !mustExists) ? 16 : 19;
            break;
          case 16:
            debug(("'" + name + "' is a temporary collection that must dropped on exit. Dropping."));
            $ctx.state = 17;
            break;
          case 17:
            $ctx.pushTry(7, null);
            $ctx.state = 10;
            break;
          case 10:
            $ctx.state = 2;
            return db.dropCollection(name);
          case 2:
            $ctx.maybeThrow();
            $ctx.state = 4;
            break;
          case 4:
            debug(("'" + name + "' dropped"));
            $ctx.state = 6;
            break;
          case 6:
            $ctx.popTry();
            $ctx.state = 12;
            break;
          case 7:
            $ctx.popTry();
            $ctx.maybeUncatchable();
            e = $ctx.storedException;
            $ctx.state = 13;
            break;
          case 13:
            if (!((e.name === "MongoError" && e.message === "ns not found"))) {
              throw e;
            }
            debug(("'" + name + "' doesn't exists when referenced first."));
            $ctx.state = 12;
            break;
          case 12:
            dropped = true;
            $ctx.state = 19;
            break;
          case 19:
            opts = _.isObject(options) ? _.clone(options) : {w: "majority"};
            if (mustExists) {
              debug("Adding strict option.");
              opts.strict = true;
            }
            debug(("Getting '" + name + "' collection's reference from Db."));
            $ctx.state = 52;
            break;
          case 52:
            $ctx.state = 22;
            return Bluebird.promisify(db.collection, {context: db})(name, opts);
          case 22:
            coll = $ctx.sent;
            $ctx.state = 24;
            break;
          case 24:
            $ctx.state = (firstSeen) ? 37 : 40;
            break;
          case 37:
            indexDefs = getIndexes();
            $ctx.state = 38;
            break;
          case 38:
            $ctx.state = (indexDefs.length) ? 34 : 31;
            break;
          case 34:
            debug(("Ensuring " + indexDefs.length + " indexes."));
            $ctx.state = 35;
            break;
          case 35:
            i = 0;
            $ctx.state = 33;
            break;
          case 33:
            $ctx.state = (i < indexDefs.length) ? 29 : 31;
            break;
          case 28:
            i++;
            $ctx.state = 33;
            break;
          case 29:
            indexDef = indexDefs[i];
            debug(("Ensuring index " + util.inspect(indexDef)));
            $ctx.state = 30;
            break;
          case 30:
            $ctx.state = 26;
            return coll.ensureIndex(indexDef.name, indexDef.fieldOrSpec, indexDef.options);
          case 26:
            $ctx.maybeThrow();
            $ctx.state = 28;
            break;
          case 31:
            if (deleteOnExit) {
              UnitOfWork.addCollectionToRecycleBin(self, coll);
            }
            $ctx.state = 40;
            break;
          case 40:
            $ctx.state = (clearBeforeUse && !dropped) ? 46 : 45;
            break;
          case 46:
            debug(("Calling 'deleteMany' in collection '" + name + "' because 'clearBeforeUse' option is set."));
            $ctx.state = 47;
            break;
          case 47:
            $ctx.state = 43;
            return coll.deleteMany({}, {w: "majority"});
          case 43:
            $ctx.maybeThrow();
            $ctx.state = 45;
            break;
          case 45:
            debug(("CollectionRef '" + name + "' run completed."));
            callContext.complete(coll);
            $ctx.state = 54;
            break;
          case 54:
            $ctx.popTry();
            $ctx.state = -2;
            break;
          case 55:
            $ctx.popTry();
            $ctx.maybeUncatchable();
            e = $ctx.storedException;
            $ctx.state = 61;
            break;
          case 61:
            callContext.fail(e);
            $ctx.state = -2;
            break;
          default:
            return $ctx.end();
        }
    }, $__7, this);
  }))();
};
module.exports = CollectionRef;
//# sourceMappingURL=data:application/json;base64,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RUFBQyxPQUFNLENBdkpWLFVBQXdDLENBQUM7QUFDaEUsaUJBQUk7O0FBdUpJLGdCQUFJLEFBQUMsRUFBQyxzQ0FBc0MsRUFBQyxLQUFHLEVBQUMsNENBQTBDLEVBQUMsQ0FBQzs7Ozs7aUJBQ3ZGLENBQUEsSUFBRyxXQUFXLEFBQUMsQ0FBQyxFQUFDLENBQUcsRUFBRSxDQUFBLENBQUcsV0FBUyxDQUFFLENBQUM7O0FBekozRCxlQUFHLFdBQVcsQUFBQyxFQUFDLENBQUE7Ozs7QUE0SkosZ0JBQUksQUFBQyxFQUFDLGlCQUFpQixFQUFDLEtBQUcsRUFBQyxtQkFBaUIsRUFBQyxDQUFDO0FBQy9DLHNCQUFVLFNBQVMsQUFBQyxDQUFDLElBQUcsQ0FBQyxDQUFDOzs7O0FBN0p0QyxlQUFHLE9BQU8sQUFBQyxFQUFDLENBQUM7Ozs7QUFDQyxlQUFHLE9BQU8sQUFBQyxFQUFDLENBQUM7QUFDYixlQUFHLGlCQUFpQixBQUFDLEVBQUMsQ0FBQztBQUN2QixjQUFvQixDQUFBLElBQUcsZ0JBQWdCLENBQUM7Ozs7QUE2SjFDLHNCQUFVLEtBQUssQUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDOzs7O0FBaEsvQixpQkFBTyxDQUFBLElBQUcsSUFBSSxBQUFDLEVBQUMsQ0FBQTs7QUFDbUIsSUFDL0IsT0FBNkIsS0FBRyxDQUFDLENBQUM7RUFnS2xDLENBbEttRCxDQWtLbEQsQUFBQyxFQUFDLENBQUM7QUFDUixDQUFDO0FBRUQsS0FBSyxRQUFRLEVBQUksY0FBWSxDQUFDO0FBQzlCIiwiZmlsZSI6ImFjdGl2aXRpZXMvY29sbGVjdGlvblJlZi5qcyIsInNvdXJjZVJvb3QiOiJsaWIvZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmxldCB3ZjRub2RlID0gcmVxdWlyZShcIndvcmtmbG93LTQtbm9kZVwiKTtcbmxldCB1dGlsID0gcmVxdWlyZShcInV0aWxcIik7XG5sZXQgQWN0aXZpdHkgPSB3ZjRub2RlLmFjdGl2aXRpZXMuQWN0aXZpdHk7XG5sZXQgQmx1ZWJpcmQgPSByZXF1aXJlKFwiYmx1ZWJpcmRcIik7XG5sZXQgVW5pdE9mV29yayA9IHJlcXVpcmUoXCIuL3VuaXRPZldvcmtcIik7XG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgQ29ubmVjdGVkID0gcmVxdWlyZShcIi4vY29ubmVjdGVkXCIpO1xubGV0IGRlYnVnID0gcmVxdWlyZShcImRlYnVnXCIpKFwibW9uZ28tY3J1bmNoOkNvbGxlY3Rpb25SZWZcIik7XG5sZXQgYXN5bmMgPSBCbHVlYmlyZC5jb3JvdXRpbmU7XG5yZXF1aXJlKFwiZGF0ZS11dGlsc1wiKTtcblxuZnVuY3Rpb24gQ29sbGVjdGlvblJlZigpIHtcbiAgICBDb25uZWN0ZWQuY2FsbCh0aGlzKTtcblxuICAgIHRoaXMubmFtZSA9IG51bGw7XG4gICAgdGhpcy5tdXN0RXhpc3RzID0gdHJ1ZTtcbiAgICB0aGlzLmRlbGV0ZU9uRXhpdCA9IGZhbHNlO1xuICAgIHRoaXMuY2xlYXJCZWZvcmVVc2UgPSBmYWxzZTtcbiAgICB0aGlzLm9wdGlvbnMgPSBudWxsO1xuICAgIHRoaXMuaW5kZXhlcyA9IG51bGw7XG4gICAgdGhpcy50dGwgPSBudWxsO1xuXG4gICAgdGhpcy5ub25TY29wZWRQcm9wZXJ0aWVzLmFkZChcIl9nZW5lcmF0ZU5hbWVcIik7XG59XG5cbnV0aWwuaW5oZXJpdHMoQ29sbGVjdGlvblJlZiwgQ29ubmVjdGVkKTtcblxuQ29sbGVjdGlvblJlZi5wcm90b3R5cGUuX2dlbmVyYXRlTmFtZSA9IGZ1bmN0aW9uKG5hbWUsIHR0bCkge1xuICAgIGlmICh0dGwgJiYgdHRsID4gMCkge1xuICAgICAgICBsZXQgdG8gPSBuZXcgRGF0ZSgpO1xuICAgICAgICB0by5hZGRNaW51dGVzKHR0bCk7XG4gICAgICAgIG5hbWUgKz0gXCJAXCIgKyB0by50b1VUQ0Zvcm1hdChcIllZWVlNTURESEhNSVNTXCIpO1xuICAgIH1cbiAgICByZXR1cm4gbmFtZTtcbn07XG5cbkNvbGxlY3Rpb25SZWYucHJvdG90eXBlLmRvV29yayA9IGZ1bmN0aW9uIChjYWxsQ29udGV4dCkge1xuICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKFxuICAgICAgICBbXG4gICAgICAgICAgICB0aGlzLm5hbWUsXG4gICAgICAgICAgICB0aGlzLm11c3RFeGlzdHMsXG4gICAgICAgICAgICB0aGlzLmRlbGV0ZU9uRXhpdCxcbiAgICAgICAgICAgIHRoaXMuY2xlYXJCZWZvcmVVc2UsXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMsXG4gICAgICAgICAgICB0aGlzLmluZGV4ZXMsXG4gICAgICAgICAgICB0aGlzLnR0bFxuICAgICAgICBdLFxuICAgICAgICBcIl92YXJzR290XCIpO1xufTtcblxuQ29sbGVjdGlvblJlZi5wcm90b3R5cGUuX3ZhcnNHb3QgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XG4gICAgaWYgKHJlYXNvbiAhPT0gQWN0aXZpdHkuc3RhdGVzLmNvbXBsZXRlKSB7XG4gICAgICAgIGNhbGxDb250ZXh0LmVuZChyZWFzb24sIHJlc3VsdCk7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgbGV0IHR0bCA9IHJlc3VsdFs2XTtcbiAgICBsZXQgbmFtZSA9IGNhbGxDb250ZXh0LmFjdGl2aXR5Ll9nZW5lcmF0ZU5hbWUocmVzdWx0WzBdLCB0dGwpO1xuICAgIGxldCBtdXN0RXhpc3RzID0gcmVzdWx0WzFdO1xuICAgIGxldCBkZWxldGVPbkV4aXQgPSByZXN1bHRbMl07XG4gICAgbGV0IGNsZWFyQmVmb3JlVXNlID0gcmVzdWx0WzNdO1xuICAgIGxldCBvcHRpb25zID0gcmVzdWx0WzRdO1xuICAgIGxldCBpbmRleGVzID0gcmVzdWx0WzVdO1xuXG4gICAgZGVidWcoYCR7bmFtZX0gcnVubmluZywgbXVzdEV4aXN0czogJHttdXN0RXhpc3RzfSwgZGVsZXRlT25FeGl0OiAke2RlbGV0ZU9uRXhpdH0sIGNsZWFyQmVmb3JlVXNlOiAke2NsZWFyQmVmb3JlVXNlfWApO1xuICAgIGRlYnVnKGBvcHRpb25zOiAke3V0aWwuaW5zcGVjdChvcHRpb25zKX1gKTtcbiAgICBkZWJ1ZyhgaW5kZXhlczogJHt1dGlsLmluc3BlY3QoaW5kZXhlcyl9YCk7XG5cbiAgICBpZiAoIV8uaXNTdHJpbmcobmFtZSkgfHwgIW5hbWUpIHtcbiAgICAgICAgY2FsbENvbnRleHQuZmFpbChuZXcgRXJyb3IoXCJBY3Rpdml0eSBhcmd1bWVudCBcXFwibmFtZVxcXCIgaXMgbnVsbCBvciBlbXB0eS5cIikpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0SW5kZXhlcygpIHtcblxuICAgICAgICBmdW5jdGlvbiB0b0luZGV4KGlkeCkge1xuICAgICAgICAgICAgbGV0IGlkeE5hbWUgPSBpZHgubmFtZTtcbiAgICAgICAgICAgIGxldCBmaWVsZE9yU3BlYyA9IGlkeC5maWVsZE9yU3BlYztcbiAgICAgICAgICAgIGxldCBpZHhPcHRpb25zID0gaWR4Lm9wdGlvbnMgfHwgeyB3OiBcIm1ham9yaXR5XCIgfTtcbiAgICAgICAgICAgIGlmICghXy5pc1N0cmluZyhpZHhOYW1lKSB8fCAhZmllbGRPclNwZWMpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGluZGV4IHNwZWNpZmljYXRpb246IFwiICsgSlNPTi5zdHJpbmdpZnkoaWR4KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIG5hbWU6IGlkeE5hbWUsXG4gICAgICAgICAgICAgICAgZmllbGRPclNwZWM6IGZpZWxkT3JTcGVjLFxuICAgICAgICAgICAgICAgIG9wdGlvbnM6IGlkeE9wdGlvbnNcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgciA9IFtdO1xuICAgICAgICBpZiAoXy5pc0FycmF5KGluZGV4ZXMpKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBpZHggb2YgaW5kZXhlcykge1xuICAgICAgICAgICAgICAgIHIucHVzaCh0b0luZGV4KGlkeCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKF8uaXNQbGFpbk9iamVjdChpbmRleGVzKSkge1xuICAgICAgICAgICAgci5wdXNoKHRvSW5kZXgoaW5kZXhlcykpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHI7XG4gICAgfVxuXG4gICAgYXN5bmMoZnVuY3Rpb24qICgpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCBkYiA9IGNhbGxDb250ZXh0LmFjdGl2aXR5LmdldERiKHNlbGYpO1xuXG4gICAgICAgICAgICBsZXQgZmlyc3RTZWVuID0gVW5pdE9mV29yay5pc0ZpcnN0U2VlbkNvbGxlY3Rpb24oc2VsZiwgZGIsIG5hbWUpO1xuXG4gICAgICAgICAgICBsZXQgZHJvcHBlZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGRlbGV0ZU9uRXhpdCAmJiBmaXJzdFNlZW4gJiYgIW11c3RFeGlzdHMpIHtcbiAgICAgICAgICAgICAgICBkZWJ1ZyhgJyR7bmFtZX0nIGlzIGEgdGVtcG9yYXJ5IGNvbGxlY3Rpb24gdGhhdCBtdXN0IGRyb3BwZWQgb24gZXhpdC4gRHJvcHBpbmcuYCk7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgZGIuZHJvcENvbGxlY3Rpb24obmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIGRlYnVnKGAnJHtuYW1lfScgZHJvcHBlZGApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoISgoZS5uYW1lID09PSBcIk1vbmdvRXJyb3JcIiAmJiBlLm1lc3NhZ2UgPT09IFwibnMgbm90IGZvdW5kXCIpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhgJyR7bmFtZX0nIGRvZXNuJ3QgZXhpc3RzIHdoZW4gcmVmZXJlbmNlZCBmaXJzdC5gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZHJvcHBlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBvcHRzID0gXy5pc09iamVjdChvcHRpb25zKSA/IF8uY2xvbmUob3B0aW9ucykgOiB7IHc6IFwibWFqb3JpdHlcIiB9O1xuICAgICAgICAgICAgaWYgKG11c3RFeGlzdHMpIHtcbiAgICAgICAgICAgICAgICBkZWJ1ZyhcIkFkZGluZyBzdHJpY3Qgb3B0aW9uLlwiKTtcbiAgICAgICAgICAgICAgICBvcHRzLnN0cmljdCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWJ1ZyhgR2V0dGluZyAnJHtuYW1lfScgY29sbGVjdGlvbidzIHJlZmVyZW5jZSBmcm9tIERiLmApO1xuICAgICAgICAgICAgbGV0IGNvbGwgPSB5aWVsZCBCbHVlYmlyZC5wcm9taXNpZnkoZGIuY29sbGVjdGlvbiwge2NvbnRleHQ6IGRifSkobmFtZSwgb3B0cyk7XG5cbiAgICAgICAgICAgIGlmIChmaXJzdFNlZW4pIHtcbiAgICAgICAgICAgICAgICBsZXQgaW5kZXhEZWZzID0gZ2V0SW5kZXhlcygpO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleERlZnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGRlYnVnKGBFbnN1cmluZyAke2luZGV4RGVmcy5sZW5ndGh9IGluZGV4ZXMuYCk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXhEZWZzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXhEZWYgPSBpbmRleERlZnNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWJ1ZyhgRW5zdXJpbmcgaW5kZXggJHt1dGlsLmluc3BlY3QoaW5kZXhEZWYpfWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgY29sbC5lbnN1cmVJbmRleChpbmRleERlZi5uYW1lLCBpbmRleERlZi5maWVsZE9yU3BlYywgaW5kZXhEZWYub3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoZGVsZXRlT25FeGl0KSB7XG4gICAgICAgICAgICAgICAgICAgIFVuaXRPZldvcmsuYWRkQ29sbGVjdGlvblRvUmVjeWNsZUJpbihzZWxmLCBjb2xsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjbGVhckJlZm9yZVVzZSAmJiAhZHJvcHBlZCkge1xuICAgICAgICAgICAgICAgIGRlYnVnKGBDYWxsaW5nICdkZWxldGVNYW55JyBpbiBjb2xsZWN0aW9uICcke25hbWV9JyBiZWNhdXNlICdjbGVhckJlZm9yZVVzZScgb3B0aW9uIGlzIHNldC5gKTtcbiAgICAgICAgICAgICAgICB5aWVsZCBjb2xsLmRlbGV0ZU1hbnkoe30sIHsgdzogXCJtYWpvcml0eVwiIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkZWJ1ZyhgQ29sbGVjdGlvblJlZiAnJHtuYW1lfScgcnVuIGNvbXBsZXRlZC5gKTtcbiAgICAgICAgICAgIGNhbGxDb250ZXh0LmNvbXBsZXRlKGNvbGwpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjYWxsQ29udGV4dC5mYWlsKGUpO1xuICAgICAgICB9XG4gICAgfSkoKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gQ29sbGVjdGlvblJlZjtcbiJdfQ==
