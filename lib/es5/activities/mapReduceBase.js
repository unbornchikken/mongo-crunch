"use strict";
"use strict";
var wf4node = require("workflow-4-node");
var util = require("util");
var Activity = wf4node.activities.Activity;
var CollectionOp = require("./collectionOp");
var _ = require("lodash");
function MapReduceBase() {
  CollectionOp.call(this);
  this.map = null;
  this.reduce = null;
  this.finalize = null;
  this.query = null;
  this.sort = null;
  this.limit = null;
  this.scope = null;
  this.sharded = true;
  this.nonAtomic = false;
  this.flatten = true;
  this.codeProperties.add("map");
  this.codeProperties.add("reduce");
  this.codeProperties.add("finalize");
}
util.inherits(MapReduceBase, CollectionOp);
Object.defineProperties(MapReduceBase.prototype, {collectionify: {
    value: true,
    enumerable: false
  }});
MapReduceBase.prototype.doWork = function(callContext) {
  callContext.schedule([this.query, this.sort, this.limit, this.scope, this.map, this.reduce, this.finalize, this.flatten, this.sharded, this.nonAtomic], "_parsGot");
};
MapReduceBase.prototype._parsGot = function(callContext, reason, result) {
  if (reason !== Activity.states.complete) {
    callContext.end(reason, result);
    return;
  }
  var query = result[0];
  var sort = result[1];
  var limit = result[2];
  var scope = result[3];
  var map = result[4];
  var reduce = result[5];
  var finalize = result[6] || undefined;
  this.flatten = !!result[7];
  var sharded = result[8];
  var nonAtomic = result[9];
  if (!_.isFunction(map) && !_.isString(map)) {
    throw new TypeError("Map function is not a function.");
  }
  if (!_.isFunction(reduce) && !_.isString(reduce)) {
    throw new TypeError("Reduce function is not a function.");
  }
  if (!_.isUndefined(finalize) && !_.isFunction(finalize) && !_.isString(finalize)) {
    throw new TypeError("Finalize function is not a function.");
  }
  var coll = this.getCollection.call(this);
  callContext.activity.doReduce.call(this, callContext, coll, map, reduce, {
    query: query,
    sort: sort,
    limit: limit,
    scope: scope,
    finalize: finalize,
    sharded: sharded,
    nonAtomic: nonAtomic
  });
};
MapReduceBase.prototype.doReduce = function(callContext, options) {
  callContext.fail(new Error("Not implemented."));
};
module.exports = MapReduceBase;
//# sourceMappingURL=data:application/json;base64,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Q0FBQztFQUMvRDtBQUFBLEFBRUksSUFBQSxDQUFBLElBQUcsRUFBSSxDQUFBLElBQUcsY0FBYyxLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUMsQ0FBQztBQUV4QyxZQUFVLFNBQVMsU0FBUyxLQUFLLEFBQUMsQ0FBQyxJQUFHLENBQUcsWUFBVSxDQUFHLEtBQUcsQ0FBRyxJQUFFLENBQUcsT0FBSyxDQUNsRTtBQUNJLFFBQUksQ0FBRyxNQUFJO0FBQ1gsT0FBRyxDQUFHLEtBQUc7QUFDVCxRQUFJLENBQUcsTUFBSTtBQUNYLFFBQUksQ0FBRyxNQUFJO0FBQ1gsV0FBTyxDQUFHLFNBQU87QUFDakIsVUFBTSxDQUFHLFFBQU07QUFDZixZQUFRLENBQUcsVUFBUTtBQUFBLEVBQ3ZCLENBQUMsQ0FBQztBQUNWLENBQUM7QUFFRCxZQUFZLFVBQVUsU0FBUyxFQUFJLFVBQVUsV0FBVSxDQUFHLENBQUEsT0FBTSxDQUFHO0FBQy9ELFlBQVUsS0FBSyxBQUFDLENBQUMsR0FBSSxNQUFJLEFBQUMsQ0FBQyxrQkFBaUIsQ0FBQyxDQUFDLENBQUM7QUFDbkQsQ0FBQztBQUVELEtBQUssUUFBUSxFQUFJLGNBQVksQ0FBQztBQUM5QiIsImZpbGUiOiJhY3Rpdml0aWVzL21hcFJlZHVjZUJhc2UuanMiLCJzb3VyY2VSb290IjoibGliL2VzNiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xyXG5cclxubGV0IHdmNG5vZGUgPSByZXF1aXJlKFwid29ya2Zsb3ctNC1ub2RlXCIpO1xyXG5sZXQgdXRpbCA9IHJlcXVpcmUoXCJ1dGlsXCIpO1xyXG5sZXQgQWN0aXZpdHkgPSB3ZjRub2RlLmFjdGl2aXRpZXMuQWN0aXZpdHk7XHJcbmxldCBDb2xsZWN0aW9uT3AgPSByZXF1aXJlKFwiLi9jb2xsZWN0aW9uT3BcIik7XHJcbmxldCBfID0gcmVxdWlyZShcImxvZGFzaFwiKTtcclxuXHJcbmZ1bmN0aW9uIE1hcFJlZHVjZUJhc2UoKSB7XHJcbiAgICBDb2xsZWN0aW9uT3AuY2FsbCh0aGlzKTtcclxuXHJcbiAgICB0aGlzLm1hcCA9IG51bGw7XHJcbiAgICB0aGlzLnJlZHVjZSA9IG51bGw7XHJcbiAgICB0aGlzLmZpbmFsaXplID0gbnVsbDtcclxuICAgIHRoaXMucXVlcnkgPSBudWxsO1xyXG4gICAgdGhpcy5zb3J0ID0gbnVsbDtcclxuICAgIHRoaXMubGltaXQgPSBudWxsO1xyXG4gICAgdGhpcy5zY29wZSA9IG51bGw7XHJcbiAgICB0aGlzLnNoYXJkZWQgPSB0cnVlO1xyXG4gICAgdGhpcy5ub25BdG9taWMgPSBmYWxzZTtcclxuICAgIHRoaXMuZmxhdHRlbiA9IHRydWU7XHJcblxyXG4gICAgdGhpcy5jb2RlUHJvcGVydGllcy5hZGQoXCJtYXBcIik7XHJcbiAgICB0aGlzLmNvZGVQcm9wZXJ0aWVzLmFkZChcInJlZHVjZVwiKTtcclxuICAgIHRoaXMuY29kZVByb3BlcnRpZXMuYWRkKFwiZmluYWxpemVcIik7XHJcbn1cclxuXHJcbnV0aWwuaW5oZXJpdHMoTWFwUmVkdWNlQmFzZSwgQ29sbGVjdGlvbk9wKTtcclxuXHJcbk9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKE1hcFJlZHVjZUJhc2UucHJvdG90eXBlLCB7XHJcbiAgICBjb2xsZWN0aW9uaWZ5OiB7XHJcbiAgICAgICAgdmFsdWU6IHRydWUsXHJcbiAgICAgICAgZW51bWVyYWJsZTogZmFsc2VcclxuICAgIH1cclxufSk7XHJcblxyXG5NYXBSZWR1Y2VCYXNlLnByb3RvdHlwZS5kb1dvcmsgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQpIHtcclxuICAgIGNhbGxDb250ZXh0LnNjaGVkdWxlKFtcclxuICAgICAgICAgICAgdGhpcy5xdWVyeSxcclxuICAgICAgICAgICAgdGhpcy5zb3J0LFxyXG4gICAgICAgICAgICB0aGlzLmxpbWl0LFxyXG4gICAgICAgICAgICB0aGlzLnNjb3BlLFxyXG4gICAgICAgICAgICB0aGlzLm1hcCxcclxuICAgICAgICAgICAgdGhpcy5yZWR1Y2UsXHJcbiAgICAgICAgICAgIHRoaXMuZmluYWxpemUsXHJcbiAgICAgICAgICAgIHRoaXMuZmxhdHRlbixcclxuICAgICAgICAgICAgdGhpcy5zaGFyZGVkLFxyXG4gICAgICAgICAgICB0aGlzLm5vbkF0b21pY1xyXG4gICAgICAgIF0sXHJcbiAgICAgICAgXCJfcGFyc0dvdFwiXHJcbiAgICApO1xyXG59O1xyXG5cclxuTWFwUmVkdWNlQmFzZS5wcm90b3R5cGUuX3BhcnNHb3QgPSBmdW5jdGlvbiAoY2FsbENvbnRleHQsIHJlYXNvbiwgcmVzdWx0KSB7XHJcbiAgICBpZiAocmVhc29uICE9PSBBY3Rpdml0eS5zdGF0ZXMuY29tcGxldGUpIHtcclxuICAgICAgICBjYWxsQ29udGV4dC5lbmQocmVhc29uLCByZXN1bHQpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcXVlcnkgPSByZXN1bHRbMF07XHJcbiAgICBsZXQgc29ydCA9IHJlc3VsdFsxXTtcclxuICAgIGxldCBsaW1pdCA9IHJlc3VsdFsyXTtcclxuICAgIGxldCBzY29wZSA9IHJlc3VsdFszXTtcclxuICAgIGxldCBtYXAgPSByZXN1bHRbNF07XHJcbiAgICBsZXQgcmVkdWNlID0gcmVzdWx0WzVdO1xyXG4gICAgbGV0IGZpbmFsaXplID0gcmVzdWx0WzZdIHx8IHVuZGVmaW5lZDtcclxuICAgIHRoaXMuZmxhdHRlbiA9ICEhcmVzdWx0WzddO1xyXG4gICAgbGV0IHNoYXJkZWQgPSByZXN1bHRbOF07XHJcbiAgICBsZXQgbm9uQXRvbWljID0gcmVzdWx0WzldO1xyXG5cclxuICAgIGlmICghXy5pc0Z1bmN0aW9uKG1hcCkgJiYgIV8uaXNTdHJpbmcobWFwKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJNYXAgZnVuY3Rpb24gaXMgbm90IGEgZnVuY3Rpb24uXCIpO1xyXG4gICAgfVxyXG4gICAgaWYgKCFfLmlzRnVuY3Rpb24ocmVkdWNlKSAmJiAhXy5pc1N0cmluZyhyZWR1Y2UpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcIlJlZHVjZSBmdW5jdGlvbiBpcyBub3QgYSBmdW5jdGlvbi5cIik7XHJcbiAgICB9XHJcbiAgICBpZiAoIV8uaXNVbmRlZmluZWQoZmluYWxpemUpICYmICFfLmlzRnVuY3Rpb24oZmluYWxpemUpICYmICFfLmlzU3RyaW5nKGZpbmFsaXplKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJGaW5hbGl6ZSBmdW5jdGlvbiBpcyBub3QgYSBmdW5jdGlvbi5cIik7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGNvbGwgPSB0aGlzLmdldENvbGxlY3Rpb24uY2FsbCh0aGlzKTtcclxuXHJcbiAgICBjYWxsQ29udGV4dC5hY3Rpdml0eS5kb1JlZHVjZS5jYWxsKHRoaXMsIGNhbGxDb250ZXh0LCBjb2xsLCBtYXAsIHJlZHVjZSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHF1ZXJ5OiBxdWVyeSxcclxuICAgICAgICAgICAgc29ydDogc29ydCxcclxuICAgICAgICAgICAgbGltaXQ6IGxpbWl0LFxyXG4gICAgICAgICAgICBzY29wZTogc2NvcGUsXHJcbiAgICAgICAgICAgIGZpbmFsaXplOiBmaW5hbGl6ZSxcclxuICAgICAgICAgICAgc2hhcmRlZDogc2hhcmRlZCxcclxuICAgICAgICAgICAgbm9uQXRvbWljOiBub25BdG9taWNcclxuICAgICAgICB9KTtcclxufTtcclxuXHJcbk1hcFJlZHVjZUJhc2UucHJvdG90eXBlLmRvUmVkdWNlID0gZnVuY3Rpb24gKGNhbGxDb250ZXh0LCBvcHRpb25zKSB7XHJcbiAgICBjYWxsQ29udGV4dC5mYWlsKG5ldyBFcnJvcihcIk5vdCBpbXBsZW1lbnRlZC5cIikpO1xyXG59O1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBNYXBSZWR1Y2VCYXNlO1xyXG4iXX0=
